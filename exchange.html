<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Fayå¹£å…Œæ›å€ - FayWooooo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background-image: linear-gradient(rgb(8, 19, 41), rgb(0, 0, 0));
      color: white;
      font-family: 'hanwangheiheavy', sans-serif;
      margin: 20px;
      text-align: center;
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }
    .exchange-container {
      background: rgba(255,255,255,0.07);
      padding: 20px;
      border-radius: 20px;
      max-width: 90%;
      margin: 50px auto;
      box-shadow: 0 8px 25px rgba(0,0,0,0.5);
      position: relative;
    }
    h1 { color: gold; }
    .balance {
      font-size: 20px;
      margin-bottom: 20px;
    }
    .items-wrapper {
      display: flex;
      overflow: hidden;
      width: 100%;
      position: relative;
    }
    .items-container {
      display: flex;
      transition: transform 0.5s ease;
      width: 100%;
    }
    .item {
      border: 1px solid gold;
      padding: 15px;
      border-radius: 12px;
      margin: 0 10px;
      min-width: 250px;
      max-width: 250px;
      flex-shrink: 0;
      background: rgba(255,255,255,0.05);
    }
    button {
      background-color: gold;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      margin-top: 8px;
    }
    button:disabled {
      background-color: gray;
      cursor: not-allowed;
    }
    .nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
      z-index: 5;
    }
    .nav-btn:hover {
      background: gold;
      color: black;
    }
    #prev-btn { left: -10px; }
    #next-btn { right: -10px; }
    @media (max-width:768px){
      .item {
        min-width: 200px;
        max-width: 200px;
      }
    }
    .admin-panel {
      background: rgba(255, 0, 0, 0.1);
      border: 2px solid #ff4444;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
      display: none;
    }

    .admin-title {
      color: #ff6666;
      font-size: 24px;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .admin-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      align-items: center;
    }

    .admin-input {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      width: 200px;
    }

    .admin-button {
      background: linear-gradient(45deg, #ff4444, #ff6666);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .admin-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 68, 68, 0.4);
    }

    .admin-select {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
    }

    .admin-info {
      color: #ffaaaa;
      font-size: 12px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <script>
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      alert('âš ï¸ è«‹å…ˆç™»å…¥æ‰èƒ½æŸ¥çœ‹ä»»å‹™');
      window.location.href = 'index.html';
    }
  </script>
  
  <h1 style="font-size: 55px;font-weight:normal;color:white;">Fayå¹£å…Œæ›å€</h1>
  
  <div id="admin-panel" class="admin-panel">
    <div class="admin-title">ğŸ”§ å®˜æ–¹ç®¡ç†é¢æ¿</div>
    <div class="admin-controls">
      <input type="text" id="user-email-input" class="admin-input" placeholder="è¼¸å…¥å¸³è™Ÿ Email" list="user-suggestions"/>
      <datalist id="user-suggestions"></datalist>

      <select id="action-select" class="admin-select">
        <option value="add">å¢åŠ  Fayå¹£</option>
        <option value="subtract">æ¸›å°‘ Fayå¹£</option>
        <option value="reset">æ­¸é›¶</option>
      </select>

      <input type="number" id="coin-amount-input" class="admin-input" placeholder="è¼¸å…¥æ•¸é‡" />
      <button onclick="applyAdminAction()" class="admin-button">åŸ·è¡Œ</button>
    </div>
    <div class="admin-info">âš ï¸ æ­¤åŠŸèƒ½åƒ…é™å®˜æ–¹å¸³è™Ÿä½¿ç”¨</div>
  </div>

  <div class="exchange-container">
    <div class="balance">ç›®å‰é¤˜é¡ï¼š<span id="coin-balance">0</span> Fayå¹£</div>
    <button id="prev-btn" class="nav-btn">â¬…</button>
    <button id="next-btn" class="nav-btn">â¡</button>
    <div class="items-wrapper">
      <div id="items-container" class="items-container"></div>
    </div>
  </div>
  
  <button style="margin-top:20px;" onclick="window.location.href='index.html'">å›é¦–é </button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // ç¢ºä¿ç™»å…¥ç‹€æ…‹
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      alert('âš ï¸ è«‹å…ˆç™»å…¥æ‰èƒ½é€²å…¥æ­¤é é¢');
      window.location.href = 'index.html';
    }

    const userEmail = localStorage.getItem('userEmail') || '';
    const userName = localStorage.getItem('userName') || '';
    const userId = localStorage.getItem('userId') || '';

    const firebaseConfig = {
      apiKey: "AIzaSyAw3NxfRft4pke6TUl9gQ4a8P0LEm30zWo",
      authDomain: "faycoin-bb878.firebaseapp.com",
      projectId: "faycoin-bb878",
      storageBucket: "faycoin-bb878.appspot.com",
      messagingSenderId: "665116400856",
      appId: "1:665116400856:web:a263d792c69129400d8bad",
      measurementId: "G-ZSZZD4W1HX"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/1D62EhlL1CFk7RXxu7NE-3HrWd6Ci6ZlMMaWXCMa2w5w/gviz/tq?tqx=out:csv';
    const PROXY_URL = 'https://corsproxy.io/?';

    let itemsData = [];
    const itemsPerPage = 3;
    let currentPage = 0;

    async function fetchItems() {
      try {
        const response = await fetch(PROXY_URL + encodeURIComponent(SHEET_CSV_URL));
        if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥å•†å“è³‡æ–™');
        const csvText = await response.text();
        itemsData = parseCSV(csvText);
        renderItems();
      } catch (error) {
        console.error('è®€å–è©¦ç®—è¡¨å¤±æ•—ï¼š', error);
      }
    }

    function parseCSV(text) {
      const lines = text.split('\n').filter(l => l.trim() !== '');
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const parts = lines[i].split(',');
        if (parts.length >= 2) {
          let name = parts[0].trim();
          let priceStr = parts[1].trim();

          if (name.startsWith('"') && name.endsWith('"')) name = name.slice(1, -1);
          if (priceStr.startsWith('"') && priceStr.endsWith('"')) priceStr = priceStr.slice(1, -1);

          const price = parseInt(priceStr);
          if (name && !isNaN(price)) data.push({ name, price });
        }
      }
      return data;
    }

    function renderItems() {
      const container = document.getElementById('items-container');
      container.innerHTML = '';
      itemsData.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <h3>${item.name}</h3>
          <p>åƒ¹æ ¼ï¼š${item.price} Fayå¹£</p>
          <button onclick="redeem(${item.price})">ç«‹å³å…Œæ›</button>
        `;
        container.appendChild(div);
      });
      updatePage();
    }

    function updatePage() {
      const container = document.getElementById('items-container');
      const totalPages = Math.ceil(itemsData.length / itemsPerPage);
      const offset = -currentPage * (itemsPerPage * 270);
      container.style.transform = `translateX(${offset}px)`;
    }

    function nextPage() {
      const totalPages = Math.ceil(itemsData.length / itemsPerPage);
      currentPage = (currentPage + 1) % totalPages;
      updatePage();
    }

    function prevPage() {
      const totalPages = Math.ceil(itemsData.length / itemsPerPage);
      currentPage = (currentPage - 1 + totalPages) % totalPages;
      updatePage();
    }

    // ğŸ”¹ ä¿®æ­£ï¼šçµ±ä¸€ä½¿ç”¨ Firebase è¼‰å…¥é¤˜é¡
    async function loadBalance() {
      const email = localStorage.getItem('userEmail');
      if (!email) {
        document.getElementById('coin-balance').textContent = 0;
        return 0;
      }

      try {
        const snapshot = await db.collection('userLoginRewards')
          .where('userEmail', '==', email)
          .get();

        let coins = 0;
        if (!snapshot.empty) {
          coins = snapshot.docs[0].data().coins || 0;
        }

        // åŒæ­¥æ›´æ–°æœ¬åœ°å„²å­˜å’Œç•«é¢
        localStorage.setItem(`fayCoins_${email}`, coins);
        localStorage.setItem('fayCoinBalance', coins.toString());
        document.getElementById('coin-balance').textContent = coins;
        
        return coins;
      } catch (error) {
        console.error('è¼‰å…¥é¤˜é¡å¤±æ•—ï¼š', error);
        // å¦‚æœ Firebase å¤±æ•—ï¼Œå˜—è©¦å¾æœ¬åœ°å„²å­˜è®€å–
        const localCoins = parseInt(localStorage.getItem(`fayCoins_${email}`) || '0');
        document.getElementById('coin-balance').textContent = localCoins;
        return localCoins;
      }
    }

    // ğŸ”¹ ä¿®æ­£ï¼šåŒæ­¥æ›´æ–° Firebase å’Œæœ¬åœ°å„²å­˜
    async function saveBalance(value) {
      const email = localStorage.getItem('userEmail');
      if (!email) return;

      // æ›´æ–°æœ¬åœ°å„²å­˜
      localStorage.setItem(`fayCoins_${email}`, value);
      localStorage.setItem('fayCoinBalance', value.toString());

      // æ›´æ–° Firebase
      try {
        const snapshot = await db.collection('userLoginRewards')
          .where('userEmail', '==', email)
          .get();

        if (!snapshot.empty) {
          await db.collection('userLoginRewards')
            .doc(snapshot.docs[0].id)
            .update({ coins: value });
        }
      } catch (error) {
        console.error('å„²å­˜é¤˜é¡å¤±æ•—ï¼š', error);
      }

      // ç™¼é€äº‹ä»¶é€šçŸ¥å…¶ä»–é é¢
      window.dispatchEvent(new CustomEvent('fayCoinChanged', {
        detail: { newBalance: value }
      }));
    }

    async function redeem(price) {
      let balance = await loadBalance();
      const item = itemsData.find(it => it.price === price)?.name || 'æœªçŸ¥å•†å“';

      if (balance >= price) {
        balance -= price;
        await saveBalance(balance);
        document.getElementById('coin-balance').textContent = balance;
        alert(`âœ… å…Œæ›æˆåŠŸï¼å‰©é¤˜ Fayå¹£ï¼š${balance}`);
        uploadRecord(getUserId(), balance, item);
      } else {
        alert('âŒ Fayå¹£ä¸è¶³ï¼Œç„¡æ³•å…Œæ›ï¼');
      }
    }

    function getUserId() {
      let uid = localStorage.getItem('userId');
      if (!uid) {
        uid = 'user_' + Math.random().toString(36).substring(2, 12);
        localStorage.setItem('userId', uid);
      }
      return uid;
    }

    function uploadRecord(userId, coins, item) {
      db.collection('exchangeRecords').add({
        userId: userId,
        coins: coins,
        item: item,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        console.log('âœ… å·²å¯«å…¥ Firestore');
      }).catch(err => {
        console.error('âŒ Firestore å¯«å…¥å¤±æ•—', err);
      });
    }

    // ğŸ”¹ ä¿®æ­£ï¼šå„ªåŒ–ç®¡ç†å“¡æ“ä½œæç¤ºè¨Šæ¯
    async function applyAdminAction() {
      let email = document.getElementById('user-email-input').value.trim();

      if (!email) {
        alert('è«‹è¼¸å…¥å¸³è™Ÿ Email');
        return;
      }

      email = email.toLowerCase();
      const action = document.getElementById('action-select').value;
      const amount = parseInt(document.getElementById('coin-amount-input').value) || 0;

      if ((action === 'add' || action === 'subtract') && amount <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—');
        return;
      }

      try {
        console.log("ğŸ” æ­£åœ¨æŸ¥è©¢å¸³è™Ÿï¼š", email);

        const userRef = db.collection('userLoginRewards')
                          .where('userEmail', '==', email);
        const snapshot = await userRef.get();

        if (snapshot.empty) {
          console.warn("âŒ æŸ¥ç„¡è³‡æ–™ï¼Œåˆ—å‡ºæ‰€æœ‰å¸³è™Ÿä¾›æª¢æŸ¥ï¼š");
          const allUsers = await db.collection('userLoginRewards').get();
          allUsers.forEach(doc => console.log("ğŸ“Œ", doc.data().userEmail));
          alert('æ‰¾ä¸åˆ°è©²å¸³è™Ÿï¼Œè«‹ç¢ºèª Email æ˜¯å¦æ­£ç¢º');
          return;
        }

        snapshot.forEach(async (doc) => {
          let balance = doc.data().coins || 0;

          if (action === 'add') {
            balance += amount;
          } else if (action === 'subtract') {
            balance = Math.max(0, balance - amount);
          } else if (action === 'reset') {
            balance = 0;
          }

          await db.collection('userLoginRewards').doc(doc.id).update({ coins: balance });
          
          // ğŸ”¹ å„ªåŒ–æç¤ºè¨Šæ¯ï¼šåªé¡¯ç¤ºæœ€çµ‚é¤˜é¡
          alert(`âœ… ${email} çš„ Fayå¹£é¤˜é¡å·²èª¿æ•´ç‚ºï¼š${balance}`);
          
          // å¦‚æœæ˜¯ç›®å‰ç™»å…¥è€…ï¼ŒåŒæ­¥æ›´æ–°ç•«é¢
          if (email === localStorage.getItem('userEmail')) {
            document.getElementById('coin-balance').textContent = balance;
            localStorage.setItem(`fayCoins_${email}`, balance);
            localStorage.setItem('fayCoinBalance', balance.toString());
          }

          uploadRecord(email, balance, `ã€å®˜æ–¹æ“ä½œ-${action}ã€‘`);
          
          // æ¸…ç©ºè¼¸å…¥æ¡†
          document.getElementById('coin-amount-input').value = '';
        });
      } catch (err) {
        console.error("âŒ Firebase æ›´æ–°å¤±æ•—", err);
        alert('æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°');
      }
    }

    // è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…å¸³è™Ÿä¾›ç®¡ç†å“¡é¸æ“‡
    async function loadAllUsersFromFirebase() {
      try {
        const snapshot = await db.collection('userLoginRewards').get();
        const datalist = document.getElementById("user-suggestions");
        datalist.innerHTML = "";

        snapshot.forEach(doc => {
          const email = doc.data().userEmail;
          if (email) {
            const option = document.createElement("option");
            option.value = email;
            datalist.appendChild(option);
          }
        });
      } catch (err) {
        console.error("âŒ è®€å–å¸³è™Ÿæ¸…å–®å¤±æ•—", err);
      }
    }

    // äº‹ä»¶ç›£è½å™¨
    document.getElementById('next-btn').addEventListener('click', nextPage);
    document.getElementById('prev-btn').addEventListener('click', prevPage);

    // ğŸ”¹ é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    window.onload = async () => {
      await loadBalance(); // ç­‰å¾…é¤˜é¡è¼‰å…¥å®Œæˆ
      fetchItems();
      setInterval(fetchItems, 5000);

      const email = localStorage.getItem('userEmail');
      const isAdmin = email === 'faywooooo@gmail.com';
      if (isAdmin) {
        document.getElementById('admin-panel').style.display = 'block';
        loadAllUsersFromFirebase();
      }
    };

    // ç›£è½ Fayå¹£è®ŠåŒ–äº‹ä»¶ï¼ˆä¾†è‡ªå…¶ä»–é é¢ï¼‰
    window.addEventListener('fayCoinChanged', async (event) => {
      const newBalance = event.detail.newBalance;
      document.getElementById('coin-balance').textContent = newBalance;
    });
    // åœ¨è³¼è²·æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶ä¸­
if (handlePurchase('å•†å“åç¨±', 50)) {
  // è³¼è²·æˆåŠŸçš„è™•ç†
}
// ç¾åœ¨ä»ç„¶å¯ä»¥é€™æ¨£ç”¨ï¼Œæœƒè‡ªå‹•åŒæ­¥
addFayCoins(15);
  </script>
  <script type="module">
  import './faycoin-sync.js';
</script>


<script>
const key = `forceReload:${location.pathname.split('/').pop()}`;
const lastReload = localStorage.getItem(key);
if (lastReload) {
  localStorage.removeItem(key);
  location.reload();
}
const reloadKey = `forceReload:${location.pathname.split('/').pop()}`;
const reloadValue = localStorage.getItem(reloadKey);
if (reloadValue) {
  localStorage.removeItem(reloadKey);
  location.reload();
}

</script>

</body>
</html>