<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Fayå¹£å…Œæ›å€ - FayWooooo</title>
    <link rel="icon" href="logo.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  emailjs.init("Rna6NHThG_VW9eyRE"); // âš ï¸ å¡«ä½ çš„ Public Key
</script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    @font-face {
    font-family: 'hanwangheiheavy';
    src: url('https://www.moedict.tw/fonts/truetype/wang/wt014.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
  }
    body {
      background-image: linear-gradient(rgb(8, 19, 41), rgb(0, 0, 0));
      color: white;
      font-family: 'hanwangheiheavy', sans-serif;
      margin: 20px;
      text-align: center;
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }
    .exchange-container {
      background: rgba(255,255,255,0.07);
      padding: 20px;
      border-radius: 20px;
      max-width: 100%;
      margin: 50px auto;
      box-shadow: 0 8px 25px rgba(0,0,0,0.5);
      position: relative;
    }
    h1 { color: gold; }
    .balance {
      font-size: 20px;
      margin-bottom: 20px;
    }
    .items-wrapper {
      display: flex;
      overflow: hidden;
      width: 100%;
      position: relative;
    }
    .items-container {
      display: flex;
      transition: transform 0.5s ease;
      width: 100%;
    }
    .item {
      border: 1px solid gold;
      padding: 15px;
      border-radius: 12px;
      margin: 0 10px;
      min-width: 250px;
      max-width: 250px;
      flex-shrink: 0;
      background: rgba(255,255,255,0.05);
      user-select: none;
    }
    button {
      background-color: gold;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      margin-top: 8px;
    }
    button:disabled {
      background-color: gray;
      cursor: not-allowed;
    }
    .nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
      z-index: 5;
    }
    .nav-btn:hover {
      background: gold;
      color: black;
    }
    #prev-btn { left: -10px; }
    #next-btn { right: -10px; }
    @media (max-width:768px){
      .item {
        min-width: 200px;
        max-width: 200px;
      }
    }
    .admin-panel {
      background: rgba(255, 0, 0, 0.1);
      border: 2px solid #ff4444;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
      display: none;
    }

    .admin-title {
      color: #ff6666;
      font-size: 24px;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .admin-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      align-items: center;
    }

    .admin-input {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      width: 200px;
    }

    .admin-button {
      background: linear-gradient(45deg, #ff4444, #ff6666);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .admin-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 68, 68, 0.4);
    }

    .admin-select {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
    }

    .admin-info {
      color: #ffaaaa;
      font-size: 12px;
      margin-top: 10px;
    }
    .chest-container {
  background: rgba(255,255,255,0.05);
  padding: 20px;
  border-radius: 15px;
  margin-top: 30px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.5);
}
#buy-chest-btn {
  background: linear-gradient(45deg, gold);
  color: black;
  border: none;
  padding: 12px 25px;
  font-size: 18px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
}
#buy-chest-btn:hover {
  transform: scale(1.1);
  background: linear-gradient(45deg, orange);
}
#buy-normal-chest-btn {
  background: linear-gradient(45deg, gold);
  color: black;
  border: none;
  padding: 12px 25px;
  font-size: 18px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
}
#buy-normal-chest-btn:hover {
  transform: scale(1.1);
  background: linear-gradient(45deg, orange);
}
.chest-box {
  margin: 20px auto;
  width: 120px;
  height: 100px;
  position: relative;
  perspective: 1000px;
}
.chest-lid {
  width: 120px;
  height: 40px;
  background: rgb(24, 0, 113);
  border: 3px solid #ffffff;
  position: absolute;
  top: 0;
  transform-origin: bottom;
  transition: transform 0.8s ease;
  border-radius: 5px 5px 0 0;
}
.chest-body {
  width: 120px;
  height: 60px;
  background: rgb(0, 0, 0);
  border: 3px solid #ffffff;
  position: absolute;
  bottom: 0;
  border-radius: 0 0 5px 5px;
}
.chest-open .chest-lid {
  transform: rotateX(-120deg);
}

/* æŠ½çå…¬å‘Š Toast */
.reward-toast {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%) translateY(50px);
  background: rgba(0,0,0,0.8);
  color: gold;
  padding: 12px 25px;
  border-radius: 10px;
  font-size: 18px;
  opacity: 0;
  transition: all 0.5s ease;
  z-index: 10000;
}
.reward-toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
/* ===== Claw Machine UI ===== */
.claw-section {
  margin-top: 30px;
  padding: 24px;
  border-radius: 20px;
  background: linear-gradient(135deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
  box-shadow: 0 12px 30px rgba(0,0,0,0.55), inset 0 0 1px rgba(255,255,255,0.15);
  position: relative;
  overflow: hidden;
}

.claw-header {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: center;
  margin-bottom: 14px;
}

.claw-title {
  font-size: 28px;
  color: #ffd166;
  letter-spacing: 1px;
  text-shadow: 0 4px 14px rgba(255,209,102,0.35);
}

.claw-card {
  display: grid;
  grid-template-columns: 1.1fr 1fr;
  gap: 22px;
  align-items: stretch;
}

@media (max-width: 980px) {
  .claw-card { grid-template-columns: 1fr; }
}

/* Cabinet (Machine) */
.claw-cabinet {
  background: radial-gradient(120% 130% at 50% 0%, rgba(255,255,255,0.12), rgba(0,0,0,0.2) 70%);
  border: 2px solid rgba(255,255,255,0.18);
  border-radius: 18px;
  position: relative;
  height: 420px;
  overflow: hidden;
  backdrop-filter: blur(6px);
}

.cabinet-glow:before {
  content: "";
  position: absolute;
  inset: -2px;
  background: linear-gradient(
    120deg,
    rgba(255,215,0,0.2),
    transparent 35%,
    rgba(0,170,255,0.18),
    transparent 70%,
    rgba(255,0,185,0.18)
  );
  filter: blur(10px);
  z-index: 0;
  pointer-events: none;
}

.cabinet-glass {
  position: absolute;
  inset: 0;
  z-index: 1;
  background: radial-gradient(120% 120% at 20% 0%, rgba(255,255,255,0.08), transparent 55%),
              radial-gradient(120% 120% at 80% 0%, rgba(255,255,255,0.06), transparent 60%);
}

/* Prize bed */
.prize-bed {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 36%;
  background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(0,0,0,0.5));
  border-top: 1px solid rgba(255,255,255,0.2);
  overflow: hidden;
  z-index: 2;
}


.prize {
  background: rgba(255,255,255,0.10);
  border: 1px solid rgba(255,255,255,0.25);
  border-radius: 12px;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: #eaffff;
  text-align: center;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.prize:hover {
  transform: translateY(-4px) scale(1.05);
  box-shadow: 0 6px 16px rgba(0,0,0,0.45);
}

.prize.win {
  outline: 2px solid #00ffd5;
  background: linear-gradient(135deg, rgba(0,255,213,0.25), rgba(0,150,255,0.3));
  box-shadow: 0 0 16px rgba(0,255,213,0.6);
}

/* Controls */
/* ===== Claw (æ›´åƒå¤¾å­) ===== */
.claw-arm {
  position: absolute;
  top: -120px;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 160px;
  z-index: 3;
  display: flex;
  flex-direction: column;
  align-items: center;
  transition: top 1s ease-in-out, left 1s ease-in-out;
}

/* å‚ç›´åŠç·š */
.claw-body {
  width: 6px;
  height: 110px;
  background: linear-gradient(180deg, #ccc, #555);
  border-radius: 3px;
}

/* çˆªå­ä¸­æ¨ */
.claw-grabber {
  position: relative;
  width: 70px;
  height: 50px;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  background: radial-gradient(circle at center, #666 20%, #333 80%);
  border-radius: 50%;
  box-shadow: 0 0 6px rgba(0,0,0,0.6);
}

/* çˆªå­æŒ‡é ­ */
.claw-finger {
  width: 14px;
  height: 45px;
  background: linear-gradient(180deg, #ddd, #666);
  border-radius: 8px;
  margin: 0 6px;
  transform-origin: top center;
  position: relative;
  box-shadow: inset 0 0 4px rgba(0,0,0,0.5);
}

/* å¤¾åˆæ™‚æ—‹è½‰ */
.claw-grab .claw-finger:nth-child(1) { 
  transform: rotate(35deg) translateY(5px); 
}
.claw-grab .claw-finger:nth-child(2) { 
  transform: rotate(-35deg) translateY(5px); 
}
.claw-grab .claw-finger:nth-child(3) { 
  transform: rotate(0deg) translateY(12px) scaleY(0.9); 
}


/* ===== Prize Ticket (å·) ===== */
.ticket {
  background: #ffd166;
  color: #333;
  font-size: 10px;
  font-weight: bold;
  padding: 4px 8px;
  border-radius: 4px;
  border: 1px dashed #333;
  transform: rotate(0deg);
  display: flex;
  align-items: center;
  justify-content: center;
  white-space: nowrap;
  user-select: none;
  transition: transform 0.3s ease;
}

.ticket.roll {
  border-radius: 50%;
  width: 28px;
  height: 28px;
  font-size: 8px;
  border: 2px solid #333;
  padding: 0;
  justify-content: center;
  text-align: center;
}
/* ===== ä¸­çå·å‹•ç•« ===== */
@keyframes shake {
  0%, 100% { transform: translate(0, 0) rotate(0deg); }
  20% { transform: translate(-2px, 0) rotate(-5deg); }
  40% { transform: translate(2px, 0) rotate(5deg); }
  60% { transform: translate(-2px, 0) rotate(-5deg); }
  80% { transform: translate(2px, 0) rotate(5deg); }
}

@keyframes floatUp {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  100% { transform: translateY(-150px) scale(0.8); opacity: 0; }
}

.ticket.win {
  animation: shake 0.4s ease-in-out, floatUp 1s ease-in-out 0.4s forwards;
  z-index: 5;
}
/* æŠ“å¨ƒå¨ƒå…¬å‘Š Toast */
.reward-toast {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%) translateY(50px);
  background: rgba(0,0,0,0.8);
  color: gold;
  padding: 12px 25px;
  border-radius: 10px;
  font-size: 18px;
  opacity: 0;
  transition: all 0.5s ease;
  z-index: 10000;
}
.reward-toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
/* å¨ƒå¨ƒæ©Ÿå‡ºå£æ´ */
.prize-hole {
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 90px;
  height: 35px;
  background: radial-gradient(ellipse at center, #111 60%, #000 100%);
  border: 2px solid #333;
  border-radius: 50% / 40%;
  z-index: 4;
}
@keyframes fallBack {
  0%   { transform: translateY(0) rotate(0deg); opacity: 1; }
  30%  { transform: translateY(40px) rotate(-20deg); }
  60%  { transform: translateY(90px) rotate(25deg); }
  100% { transform: translateY(130px) rotate(0deg); opacity: 1; }
}

.ticket.fall-back {
  animation: fallBack 0.8s ease-out forwards;
  position: absolute !important; /* ç¢ºä¿èƒ½è‡ªç”±æ‰è½ */
}
.tool-ai{
  border-radius: 12px;
  margin: 0 10px;
  min-width: 250px;
  max-width: 250px;
  flex-shrink: 0;
  padding: 50px;

}
.tool-ai-container{
  background: rgba(255,255,255,0.05);
  border-radius: 15px;
  margin-top: 30px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.5);
}
  </style>
</head>
<body>
  <script>
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      window.location.href = 'index.html';
    }
  </script>
  <div id="coin-panel" style="display:none;"></div>
  <h1 style="font-size: 55px;font-weight:normal;color:white;">Fayå¹£å…Œæ›å€</h1>
  
  <div id="admin-panel" class="admin-panel">
    <div class="admin-title">å®˜æ–¹ç®¡ç†é¢æ¿</div>
    <div class="admin-controls">
      <input type="text" id="user-email-input" class="admin-input" placeholder="è¼¸å…¥å¸³è™Ÿ Email" list="user-suggestions"/>
      <datalist id="user-suggestions"></datalist>

      <select id="action-select" class="admin-select">
        <option value="add">å¢åŠ  Fayå¹£</option>
        <option value="subtract">æ¸›å°‘ Fayå¹£</option>
        <option value="reset">æ­¸é›¶</option>
        <option value="giftNormal">è´ˆé€æ™®é€šå¯¶ç®±</option>
        <option value="removeNormal">åˆªé™¤æ™®é€šå¯¶ç®±</option> <!-- æ–°å¢ -->
        <option value="giftAdvanced">è´ˆé€é«˜ç´šå¯¶ç®±</option>
        <option value="removeAdvanced">åˆªé™¤é«˜ç´šå¯¶ç®±</option> <!-- æ–°å¢ -->
      </select>
      

      <input type="number" id="coin-amount-input" class="admin-input" placeholder="è¼¸å…¥æ•¸é‡" />
      <button onclick="applyAdminAction()" class="admin-button">åŸ·è¡Œ</button>
    </div>

    <div class="admin-info">âš ï¸ æ­¤åŠŸèƒ½åƒ…é™å®˜æ–¹å¸³è™Ÿä½¿ç”¨</div>
  </div>

  <div class="exchange-container">
    <div class="balance">ç›®å‰é¤˜é¡ï¼š<span id="coin-balance">0</span> Fayå¹£</div>
    <div class="items-wrapper">
      <div id="items-container" class="items-container"></div>
    </div></div>
    <!-- å·¥å…·å…Œæ›å°ˆå€ -->
    <div class="tool-ai-container">
      <center>
        <div class="tool-ai">
          <h2>AI è©•ä¼°å·¥å…·</h2>
          <p>åƒ¹æ ¼ï¼š200 Fayå¹£ / 5 æ¬¡ä½¿ç”¨é¡åº¦</p>
          <p>å‰©é¤˜é¡åº¦ï¼š<span id="tool-quota">0</span> æ¬¡</p>
          <button onclick="redeemTool(200)">å…Œæ›ä½¿ç”¨é¡åº¦</button><br><br>
          <a href="tool-ai.html" style="color:gold;text-decoration:underline;">é€²å…¥ AI è©•ä¼°å·¥å…·</a>
        </div>
        
      </center>
    </div>
    

    <!-- ===== æ™®é€šå¯¶ç®±ç³»çµ± ===== -->
<div class="chest-container">
  <p>å‰©é¤˜æ™®é€šå¯¶ç®±æ•¸é‡ï¼š<span id="normal-chest-count">0</span> é¡†</p>
  <h2 style="color:lightblue;">æ™®é€šå¯¶ç®±</h2>
  <button id="buy-normal-chest-btn">é–‹å•Ÿæ™®é€šå¯¶ç®±</button>

  <div id="normal-chest-box" class="chest-box">
    <div class="chest-lid"></div>
    <div class="chest-body"></div>
  </div>
  <p id="normal-reward-result" style="margin-top:15px;font-size:18px;color:lightgreen;"></p>
  <button onclick="buyNormalChestBundle(200, 1)">è³¼è²· 1 é¡†æ™®é€šå¯¶ç®± (200 Fayå¹£)</button><br>
  <button onclick="buyNormalChestBundle(380, 2)">è³¼è²· 2 é¡†æ™®é€šå¯¶ç®± (380 Fayå¹£)</button>
</div>

    <!-- ===== é«˜ç´šå¯¶ç®±ç³»çµ± ===== -->
<div class="chest-container">
  <p>å‰©é¤˜é«˜ç´šå¯¶ç®±æ•¸é‡ï¼š<span id="chest-count">0</span> é¡†</p>
  <h2 style="color:gold;">é«˜ç´šå¯¶ç®±</h2>
  <button id="buy-chest-btn">é–‹å•Ÿé«˜ç´šå¯¶ç®±</button>

  <div id="chest-box" class="chest-box">
    <div class="chest-lid"></div>
    <div class="chest-body"></div>
  </div>
  <p id="reward-result" style="margin-top:15px;font-size:18px;color:lightgreen;"></p>
    <button onclick="buyChestBundle(500, 1)">è³¼è²· 1 é¡†é«˜ç´šå¯¶ç®± (500 Fayå¹£)</button><br>
  <button onclick="buyChestBundle(1000, 2)">è³¼è²· 3 é¡†é«˜ç´šå¯¶ç®± (1000 Fayå¹£)</button>
</div>
<div class="claw-section">
  <div class="claw-header">
    <i class="fa-solid fa-gamepad fa-2x" style="color:#ffd166"></i>
    <span class="claw-title">Fayå¹£æŠ“å¨ƒå¨ƒæ©Ÿ</span>
  </div>
  <div class="claw-card">
    <!-- Cabinet -->
    <div class="claw-cabinet cabinet-glow">
      <div class="claw-arm" id="clawArm">
        <div class="claw-body"></div>
        <div class="claw-grabber" id="clawGrabber">
          <div class="claw-finger"></div>
          <div class="claw-finger"></div>
          <div class="claw-finger"></div>
        </div>
      </div>      
      <div class="cabinet-glass"></div>
      <div id="prizeBed" class="prize-bed"></div>
      <div class="prize-hole" id="prizeHole"></div>
    </div>
    
    

    <!-- Control -->
    <div class="claw-controls">
      <p style="color:#eee;font-size:15px;margin-bottom:10px;">
        èŠ±è²» <b>10 Fayå¹£</b> å˜—è©¦å¤¾å…Œæ›åˆ¸<br>
        ä¿å¤¾ï¼š1500 Fayå¹£
      </p>
      <button id="playClaw" class="btn-grad">é–‹å§‹å¤¾å–</button>
      <div style="margin-top:18px;">
        <div id="progressBar" style="height:12px;border-radius:8px;background:#333;overflow:hidden;">
          <div id="progressFill" style="height:100%;width:0;background:linear-gradient(90deg,#ffd166,#ff6b6b);"></div>
        </div>
        <small style="color:#aaa;">è·é›¢ä¿å¤¾é€²åº¦</small>
        <button onclick="buyGuaranteeClaw(1500)">ç›´æ¥è³¼è²·ä¿å¤¾ (1500 Fayå¹£)</button>

      </div>
      <p id="clawResult" style="margin-top:14px;color:#ffd166;font-weight:bold;"></p>
    </div>
  </div>
</div>

  </div>
  
  <button style="margin-top:20px;" onclick="window.location.href='index.html'">å›é¦–é </button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // ç¢ºä¿ç™»å…¥ç‹€æ…‹
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      alert('âš ï¸ è«‹å…ˆç™»å…¥æ‰èƒ½é€²å…¥æ­¤é é¢');
      window.location.href = 'index.html';
    }

    const userEmail = localStorage.getItem('userEmail') || '';
    const userName = localStorage.getItem('userName') || '';
    const userId = localStorage.getItem('userId') || '';

    const firebaseConfig = {
      apiKey: "AIzaSyAw3NxfRft4pke6TUl9gQ4a8P0LEm30zWo",
      authDomain: "faycoin-bb878.firebaseapp.com",
      projectId: "faycoin-bb878",
      storageBucket: "faycoin-bb878.appspot.com",
      messagingSenderId: "665116400856",
      appId: "1:665116400856:web:a263d792c69129400d8bad",
      measurementId: "G-ZSZZD4W1HX"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/1D62EhlL1CFk7RXxu7NE-3HrWd6Ci6ZlMMaWXCMa2w5w/gviz/tq?tqx=out:csv';
    const PROXY_URL = 'https://corsproxy.io/?';

    let itemsData = [];
    const itemsPerPage = 3;
    let currentPage = 0;

    async function fetchItems() {
      try {
        const response = await fetch(PROXY_URL + encodeURIComponent(SHEET_CSV_URL));
        if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥å•†å“è³‡æ–™');
        const csvText = await response.text();
        itemsData = parseCSV(csvText);
        renderItems();
      } catch (error) {
        console.error('è®€å–è©¦ç®—è¡¨å¤±æ•—ï¼š', error);
      }
    }

    function parseCSV(text) {
      const lines = text.split('\n').filter(l => l.trim() !== '');
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const parts = lines[i].split(',');
        if (parts.length >= 2) {
          let name = parts[0].trim();
          let priceStr = parts[1].trim();

          if (name.startsWith('"') && name.endsWith('"')) name = name.slice(1, -1);
          if (priceStr.startsWith('"') && priceStr.endsWith('"')) priceStr = priceStr.slice(1, -1);

          const price = parseInt(priceStr);
          if (name && !isNaN(price)) data.push({ name, price });
        }
      }
      return data;
    }

    function renderItems() {
      const container = document.getElementById('items-container');
      container.innerHTML = '';
      itemsData.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <h3>${item.name}</h3>
          <p>åƒ¹æ ¼ï¼š${item.price} Fayå¹£</p>
          <button onclick="redeem(${item.price})">ç«‹å³å…Œæ›</button>
        `;
        container.appendChild(div);
      });
      updatePage();
    }

    function updatePage() {
      const container = document.getElementById('items-container');
      const totalPages = Math.ceil(itemsData.length / itemsPerPage);
      const offset = -currentPage * (itemsPerPage * 270);
      container.style.transform = `translateX(${offset}px)`;
    }

    function nextPage() {
      const totalPages = Math.ceil(itemsData.length / itemsPerPage);
      currentPage = (currentPage + 1) % totalPages;
      updatePage();
    }

    function prevPage() {
      const totalPages = Math.ceil(itemsData.length / itemsPerPage);
      currentPage = (currentPage - 1 + totalPages) % totalPages;
      updatePage();
    }

    // ğŸ”¹ ä¿®æ­£ï¼šçµ±ä¸€ä½¿ç”¨ Firebase è¼‰å…¥é¤˜é¡
    async function loadBalance() {
      const email = localStorage.getItem('userEmail');
      if (!email) {
        document.getElementById('coin-balance').textContent = 0;
        return 0;
      }

      try {
        const snapshot = await db.collection('userLoginRewards')
          .where('userEmail', '==', email)
          .get();

        let coins = 0;
        if (!snapshot.empty) {
          coins = snapshot.docs[0].data().coins || 0;
        }

        // åŒæ­¥æ›´æ–°æœ¬åœ°å„²å­˜å’Œç•«é¢
        localStorage.setItem(`fayCoins_${email}`, coins);
        localStorage.setItem('fayCoinBalance', coins.toString());
        document.getElementById('coin-balance').textContent = coins;
        
        return coins;
      } catch (error) {
        console.error('è¼‰å…¥é¤˜é¡å¤±æ•—ï¼š', error);
        // å¦‚æœ Firebase å¤±æ•—ï¼Œå˜—è©¦å¾æœ¬åœ°å„²å­˜è®€å–
        const localCoins = parseInt(localStorage.getItem(`fayCoins_${email}`) || '0');
        document.getElementById('coin-balance').textContent = localCoins;
        return localCoins;
      }
    }

    // ğŸ”¹ ä¿®æ­£ï¼šåŒæ­¥æ›´æ–° Firebase å’Œæœ¬åœ°å„²å­˜
    async function saveBalance(value) {
      const email = localStorage.getItem('userEmail');
      if (!email) return;

      // æ›´æ–°æœ¬åœ°å„²å­˜
      localStorage.setItem(`fayCoins_${email}`, value);
      localStorage.setItem('fayCoinBalance', value.toString());

      // æ›´æ–° Firebase
      try {
        const snapshot = await db.collection('userLoginRewards')
          .where('userEmail', '==', email)
          .get();

        if (!snapshot.empty) {
          await db.collection('userLoginRewards')
            .doc(snapshot.docs[0].id)
            .update({ coins: value });
        }
      } catch (error) {
        console.error('å„²å­˜é¤˜é¡å¤±æ•—ï¼š', error);
      }

      // ç™¼é€äº‹ä»¶é€šçŸ¥å…¶ä»–é é¢
      window.dispatchEvent(new CustomEvent('fayCoinChanged', {
        detail: { newBalance: value }
      }));
    }

    async function redeem(price) {
      let balance = await loadBalance();
      const item = itemsData.find(it => it.price === price)?.name || 'æœªçŸ¥å•†å“';


      if (balance >= price) {
  balance -= price;
  await saveBalance(balance);
  document.getElementById('coin-balance').textContent = balance;
  alert(`âœ… å…Œæ›æˆåŠŸï¼å‰©é¤˜ Fayå¹£ï¼š${balance}`);
  uploadRecord(getUserId(), balance, item);

  // ğŸ”¹ å¯„é€ Email
  const email = localStorage.getItem("userEmail");
  if (email && email !== "faywooooo@gmail.com") {
    sendRewardEmail(email, `æˆåŠŸå…Œæ›äº†å•†å“ï¼š${item}`, "template_o2q9pt8");
  }
}else {
        alert('âŒ Fayå¹£ä¸è¶³ï¼Œç„¡æ³•å…Œæ›ï¼');
      }

    }

    function getUserId() {
      let uid = localStorage.getItem('userId');
      if (!uid) {
        uid = 'user_' + Math.random().toString(36).substring(2, 12);
        localStorage.setItem('userId', uid);
      }
      return uid;
    }

    function uploadRecord(userId, coins, item) {
      db.collection('exchangeRecords').add({
        userId: userId,
        coins: coins,
        item: item,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        console.log('âœ… å·²å¯«å…¥ Firestore');
      }).catch(err => {
        console.error('âŒ Firestore å¯«å…¥å¤±æ•—', err);
      });
    }

    // ğŸ”¹ ä¿®æ­£ï¼šå„ªåŒ–ç®¡ç†å“¡æ“ä½œæç¤ºè¨Šæ¯
async function applyAdminAction() {
  let email = document.getElementById('user-email-input').value.trim();
  if (!email) {
    alert('è«‹è¼¸å…¥å¸³è™Ÿ Email');
    return;
  }

  email = email.toLowerCase();
  const action = document.getElementById('action-select').value;
  const amount = parseInt(document.getElementById('coin-amount-input').value) || 0;

  if ((action === 'add' || action === 'subtract') && amount <= 0) {
    alert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—');
    return;
  }

  try {
    const snapshot = await db.collection('userLoginRewards')
                             .where('userEmail', '==', email)
                             .get();

    if (snapshot.empty) {
      alert('æ‰¾ä¸åˆ°è©²å¸³è™Ÿï¼Œè«‹ç¢ºèª Email æ˜¯å¦æ­£ç¢º');
      return;
    }

    snapshot.forEach(async (doc) => {
      let data = doc.data();
      let balance = data.coins || 0;
      let normalChests = data.normalChests || 0;
      let advancedChests = data.chests || 0;

      if (action === 'add') {
        balance += amount;
        await db.collection('userLoginRewards').doc(doc.id).update({ coins: balance });
        alert(`âœ… ${email} çš„ Fayå¹£é¤˜é¡å·²èª¿æ•´ç‚ºï¼š${balance}`);
      } 
      else if (action === 'subtract') {
        balance = Math.max(0, balance - amount);
        await db.collection('userLoginRewards').doc(doc.id).update({ coins: balance });
        alert(`âœ… ${email} çš„ Fayå¹£é¤˜é¡å·²èª¿æ•´ç‚ºï¼š${balance}`);
      } 
      else if (action === 'reset') {
        balance = 0;
        await db.collection('userLoginRewards').doc(doc.id).update({ coins: balance });
        alert(`âœ… ${email} çš„ Fayå¹£é¤˜é¡å·²é‡ç½®ç‚º 0`);
      }
else if (action === 'giftNormal') {
  normalChests += amount;
  await db.collection('userLoginRewards').doc(doc.id).update({ normalChests });
  alert(`ğŸ å·²è´ˆé€ ${amount} é¡†æ™®é€šå¯¶ç®±çµ¦ ${email}`);

  // ğŸ”¹ è§¸ç™¼äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–é é¢
  window.dispatchEvent(new CustomEvent('normalChestChanged', {
    detail: { email: email, count: normalChests }
  }));
}
else if (action === 'giftAdvanced') {
  advancedChests += amount;
  await db.collection('userLoginRewards').doc(doc.id).update({ chests: advancedChests });
  alert(`ğŸ å·²è´ˆé€ ${amount} é¡†é«˜ç´šå¯¶ç®±çµ¦ ${email}`);

  // ğŸ”¹ è§¸ç™¼äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–é é¢
  window.dispatchEvent(new CustomEvent('advancedChestChanged', {
    detail: { email: email, count: advancedChests }
  }));
}
else if (action === 'removeNormal') {
  normalChests = Math.max(0, normalChests - amount);
  await db.collection('userLoginRewards').doc(doc.id).update({ normalChests });
  alert(`ğŸ—‘ï¸ å·²åˆªé™¤ ${amount} é¡†æ™®é€šå¯¶ç®± from ${email}`);

  // å³æ™‚æ›´æ–°
  window.dispatchEvent(new CustomEvent('normalChestChanged', {
    detail: { email: email, count: normalChests }
  }));
}
else if (action === 'removeAdvanced') {
  advancedChests = Math.max(0, advancedChests - amount);
  await db.collection('userLoginRewards').doc(doc.id).update({ chests: advancedChests });
  alert(`ğŸ—‘ï¸ å·²åˆªé™¤ ${amount} é¡†é«˜ç´šå¯¶ç®± from ${email}`);

  // å³æ™‚æ›´æ–°
  window.dispatchEvent(new CustomEvent('advancedChestChanged', {
    detail: { email: email, count: advancedChests }
  }));
}

    });

    document.getElementById('coin-amount-input').value = '';
  } catch (err) {
    console.error("âŒ Firebase æ›´æ–°å¤±æ•—", err);
    alert('æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°');
  }
  
}


    // è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…å¸³è™Ÿä¾›ç®¡ç†å“¡é¸æ“‡
    async function loadAllUsersFromFirebase() {
      try {
        const snapshot = await db.collection('userLoginRewards').get();
        const datalist = document.getElementById("user-suggestions");
        datalist.innerHTML = "";

        snapshot.forEach(doc => {
          const email = doc.data().userEmail;
          if (email) {
            const option = document.createElement("option");
            option.value = email;
            datalist.appendChild(option);
          }
        });
      } catch (err) {
        console.error("âŒ è®€å–å¸³è™Ÿæ¸…å–®å¤±æ•—", err);
      }
    }
function enableResponsiveDrag(wrapperSelector, containerSelector, updateFunc) {
  const wrapper = document.querySelector(wrapperSelector);
  const container = document.querySelector(containerSelector);

  let isDown = false;
  let startX, currentTranslate = 0, prevTranslate = 0, animationID;
  let currentIndex = 0;

  // åˆ¤æ–·è£ç½®å¤§å°ï¼ˆå°æ–¼ 768px è¦–ç‚ºæ‰‹æ©Ÿï¼‰
  function isMobile() {
    return window.innerWidth <= 768;
  }

  function setSliderPosition() {
    container.style.transform = `translateX(${currentTranslate}px)`;
  }

  function animation() {
    setSliderPosition();
    if (isDown) requestAnimationFrame(animation);
  }

  // æ¡Œæ©Ÿæ»‘é¼ 
  wrapper.addEventListener("mousedown", (e) => {
    isDown = true;
    startX = e.pageX;
    wrapper.style.cursor = "grabbing";
    animationID = requestAnimationFrame(animation);
  });

  wrapper.addEventListener("mousemove", (e) => {
    if (!isDown) return;
    const x = e.pageX;
    const dx = x - startX;
    currentTranslate = prevTranslate + dx;
  });

  wrapper.addEventListener("mouseup", (e) => {
    cancelAnimationFrame(animationID);
    isDown = false;
    wrapper.style.cursor = "grab";

    const dx = e.pageX - startX;

    if (!isMobile()) {
      // æ¡Œæ©Ÿç¿»é ï¼šä¸€æ¬¡ 2 æ ¼
      if (dx < -50) currentIndex += 2;
      if (dx > 50) currentIndex -= 2;
      if (currentIndex < 0) currentIndex = 0;
      const maxIndex = container.children.length - 2;
      if (currentIndex > maxIndex) currentIndex = maxIndex;

      const itemWidth = container.children[0].offsetWidth + 20;
      currentTranslate = -currentIndex * itemWidth;
      prevTranslate = currentTranslate;
      setSliderPosition();
      if (typeof updateFunc === "function") updateFunc();
    } else {
      prevTranslate = currentTranslate;
    }
  });

  wrapper.addEventListener("mouseleave", () => {
    if (isDown) {
      isDown = false;
      wrapper.style.cursor = "grab";
      cancelAnimationFrame(animationID);
    }
  });

  // æ‰‹æ©Ÿè§¸æ§
  wrapper.addEventListener("touchstart", (e) => {
    isDown = true;
    startX = e.touches[0].clientX;
    animationID = requestAnimationFrame(animation);
  });

  wrapper.addEventListener("touchmove", (e) => {
    if (!isDown) return;
    const x = e.touches[0].clientX;
    const dx = x - startX;
    if (isMobile()) {
      currentTranslate = prevTranslate + dx;
    }
  });

  wrapper.addEventListener("touchend", (e) => {
    cancelAnimationFrame(animationID);
    isDown = false;

    const dx = e.changedTouches[0].clientX - startX;

    if (!isMobile()) {
      // æ¡Œæ©Ÿç¿»é ï¼šä¸€æ¬¡ 2 æ ¼
      if (dx < -50) currentIndex += 2;
      if (dx > 50) currentIndex -= 2;
      if (currentIndex < 0) currentIndex = 0;
      const maxIndex = container.children.length - 2;
      if (currentIndex > maxIndex) currentIndex = maxIndex;

      const itemWidth = container.children[0].offsetWidth + 20;
      currentTranslate = -currentIndex * itemWidth;
    }
    prevTranslate = currentTranslate;
    setSliderPosition();
  });
}

// å•Ÿç”¨
window.addEventListener("load", () => {
  if (document.getElementById("items-container")) {
    enableResponsiveDrag(".items-wrapper", "#items-container", updatePage);
  }
  if (document.getElementById("carousel")) {
    enableResponsiveDrag(".carousel-wrapper", "#carousel", updateCarousel);
  }
});

    // ğŸ”¹ é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    window.onload = async () => {
  await loadBalance();
  await fetchItems();
  setInterval(fetchItems, 5000);

  const email = localStorage.getItem('userEmail');
  const adminEmails = ["faywooooo@gmail.com", "faywooooobs@gmail.com"]; // å…è¨±å¤šå€‹å¸³è™Ÿ
  const isAdmin = adminEmails.includes(email);

  if (isAdmin) {
    document.getElementById('admin-panel').style.display = 'block';
    loadAllUsersFromFirebase();
  }

  listenToChestRewards(); // å•Ÿå‹•å…¬å‘Šç›£è½
};


    // ç›£è½ Fayå¹£è®ŠåŒ–äº‹ä»¶ï¼ˆä¾†è‡ªå…¶ä»–é é¢ï¼‰
    window.addEventListener('fayCoinChanged', async (event) => {
      const newBalance = event.detail.newBalance;
      document.getElementById('coin-balance').textContent = newBalance;
    });
  </script>
<script type="module" src="faycoin-sync.js"></script>



<script>
const key = `forceReload:${location.pathname.split('/').pop()}`;
const lastReload = localStorage.getItem(key);
if (lastReload) {
  localStorage.removeItem(key);
  location.reload();
}
const reloadKey = `forceReload:${location.pathname.split('/').pop()}`;
const reloadValue = localStorage.getItem(reloadKey);
if (reloadValue) {
  localStorage.removeItem(reloadKey);
  location.reload();
}
// Fayå¯¶ç®±çå‹µæ±  (å«æ©Ÿç‡)
const chestRewards = [
{ name: "æ•™ä½ åšå¸ç›ç¸®åœ–(åŸºç¤æŠ€å·§)", type: "item", chance: 15 },
{ name: "æ•™ä½ å…è²»å·¥å…·åšå°ˆæ¥­ç¸®åœ–", type: "item", chance: 15 },
{ name: "æ•™ä½ ç”¨æ‰‹æ©Ÿå¿«é€Ÿå‰ªå½±ç‰‡", type: "item", chance: 12 },
{ name: "æ•™ä½ é«˜ç´šå‰ªè¼¯æŠ€å·§", type: "item", chance: 8 },
{ name: "é »é“è¨ºæ–·ä¸€æ¬¡(å¹«ä½ çœ‹å„ªç¼ºé»)", type: "item", chance: 8 },
{ name: "é‡èº«è¦åŠƒä½ çš„å½±ç‰‡ä¸»é¡Œæ–¹å‘", type: "item", chance: 8 },
{ name: "æ•™ä½ é »é“ç¶“ç‡Ÿ(30åˆ†é˜)", type: "item", chance: 8 },
{ name: "@ä½ å«ä½ çˆ¸çˆ¸5æ¬¡", type: "item", chance: 8 },
{ name: "çµ¦ä½ ç®¡+è®“å…¨éƒ¨ç®¡å¯ä»¥@All", type: "item", chance: 6 },
{ name: "è®“ä½ æ±ºå®šä¸‹éƒ¨å½±ç‰‡é¡Œæ", type: "item", chance: 6 },
{ name: "æˆ‘å¹«ä½ åšä¸€å€‹å°ˆå±¬å®£å‚³ç‰‡", type: "item", chance: 6 }

];
// åŠ æ¬Šéš¨æ©ŸæŠ½ç
function getWeightedReward() {
  const totalChance = chestRewards.reduce((sum, r) => sum + r.chance, 0);
  let rand = Math.random() * totalChance;
  for (let r of chestRewards) {
    rand -= r.chance;
    if (rand <= 0) return r;
  }
  return chestRewards[chestRewards.length - 1];
}

// === Fayå¯¶ç®±æ•¸é‡ ===
async function loadChests() {
  const email = localStorage.getItem("userEmail");
  if (!email) return 0;
  try {
    const snapshot = await db.collection("userLoginRewards").where("userEmail", "==", email).get();
    if (!snapshot.empty) {
      return snapshot.docs[0].data().chests || 0;
    }
  } catch (e) { console.error(e); }
  return 0;
}
async function saveChests(value) {
  const email = localStorage.getItem("userEmail");
  if (!email) return;
  try {
    const snapshot = await db.collection("userLoginRewards").where("userEmail", "==", email).get();
    if (!snapshot.empty) {
      await db.collection("userLoginRewards").doc(snapshot.docs[0].id).update({ chests: value });
    }
  } catch (e) { console.error(e); }
}
async function updateChestDisplay() {
  const chests = await loadChests();
  document.getElementById("chest-count").innerText = chests;
}

// === é–‹å•Ÿå¯¶ç®±ï¼ˆä¸€æ¬¡åªé–‹ä¸€é¡†ï¼‰ ===
async function openChest() {
  let chests = await loadChests();
  if (chests <= 0) {
    alert("âŒ æ²’æœ‰å¯¶ç®±å¯ä»¥æ‰“é–‹ï¼");
    return;
  }

  // æ‰£é™¤ä¸€é¡†å¯¶ç®±
  chests -= 1;
  await saveChests(chests);
  await updateChestDisplay();

  // æ’­æ”¾å‹•ç•«
  const chest = document.getElementById("chest-box");
  chest.classList.add("chest-open");

  setTimeout(async () => {
    chest.classList.remove("chest-open");
    const reward = getWeightedReward();
    let balance = await loadBalance();
    let msg = "";

    if (reward.type === "coins") {
      // åŠ  Fay å¹£
      balance += reward.amount;
      await saveBalance(balance);
      msg = `ğŸ‰ æ­å–œç²å¾— ${reward.name}ï¼ç›®å‰é¤˜é¡ï¼š${balance}`;
    } else {
      // ç²å¾—ç‰©å“
      msg = `ğŸ‰ æ­å–œç²å¾— ${reward.name}ï¼`;

      const email = localStorage.getItem("userEmail");
      if (email && email !== "faywooooo@gmail.com") {
        sendRewardEmail(email, reward.name, "template_7r9kdt9", "é«˜ç´šå¯¶ç®±");

      }
    }

    // é¡¯ç¤ºçµæœ
    document.getElementById("reward-result").innerText = msg;

    // Firestore ç´€éŒ„
    recordChestReward(localStorage.getItem("userEmail"), reward.name);
    uploadRecord(getUserId(), balance, `å¯¶ç®±ç²å¾—: ${reward.name}`);
  }, 1200);
}

// === ä¿®æ­£æŒ‰éˆ•ç¶å®š ===
const chestBtn = document.getElementById("buy-chest-btn");
chestBtn.innerText = "é–‹å•Ÿé«˜ç´šå¯¶ç®±";
chestBtn.onclick = openChest; // âœ… ä¸è¦å†ç”¨ removeEventListener

// === é é¢è¼‰å…¥æ™‚åŒæ­¥æ›´æ–°å¯¶ç®±æ•¸ ===
window.addEventListener("load", async () => {
  await updateChestDisplay();
});


async function buyChestBundle(cost, amount) {
  let coins = await loadBalance();
  if (coins < cost) {
    alert("âŒ Fayå¹£ä¸è¶³ï¼");
    return;
  }
  coins -= cost;
  await saveBalance(coins);

  let chests = await loadChests();
  chests += amount;
  await saveChests(chests);
  await updateChestDisplay();

  alert(`âœ… æˆåŠŸè³¼è²· ${amount} é¡†å¯¶ç®±ï¼ç›®å‰é¤˜é¡ï¼š${coins} Fayå¹£`);
}

async function recordChestReward(userEmail, rewardName) {
  if (!userEmail) return;
  try {
    await db.collection("chestRewardsHistory").add({
      userEmail: userEmail,
      reward: rewardName,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  } catch (err) { console.error(err); }
}

let firstLoad = true;
function listenToChestRewards() {
  db.collection("chestRewardsHistory").orderBy("timestamp","desc").limit(5)
    .onSnapshot(snapshot=>{
      // é¦–æ¬¡è¼‰å…¥ â†’ åªå»ºç«‹ baselineï¼Œä¸é¡¯ç¤º
      if (firstLoad) {
        firstLoad = false;
        return;
      }
      snapshot.docChanges().forEach(change=>{
        if (change.type==="added") {
          const data = change.doc.data();
          showRewardAnnouncement(data.userEmail, data.reward);
        }
      });
    });
}


function showRewardAnnouncement(userEmail, reward) {
  const shortEmail = userEmail ? userEmail.replace(/(.{3}).+(@.+)/, "$1***$2") : "ç©å®¶";
  const msg = `ğŸ‰ ${shortEmail} æŠ½ä¸­äº† ${reward}ï¼`;
  const toast = document.createElement("div");
  toast.className="reward-toast";
  toast.innerText=msg;
  document.body.appendChild(toast);
  setTimeout(()=>toast.classList.add("show"),100);
  setTimeout(()=>{
    toast.classList.remove("show");
    setTimeout(()=>toast.remove(),500);
  },5000);
}
function sendRewardEmail(userEmail, rewardName, templateId, sourceType) {
  const templateParams = {
    user: userEmail || "æœªçŸ¥ç©å®¶",
    reward: rewardName,
    type: sourceType || "ç³»çµ±çå‹µ",   // æ–°å¢ä¾†æºè³‡è¨Š
    time: new Date().toLocaleString()
  };

  emailjs.send("service_g83kh8j", templateId, templateParams)
    .then(res => console.log("âœ… Email ç™¼é€æˆåŠŸ:", res))
    .catch(err => console.error("âŒ Email ç™¼é€å¤±æ•—:", err));
}






// === æ™®é€šå¯¶ç®±çå‹µæ±  ===
const normalChestRewards = [
  { name: "YTå½±ç‰‡ç‰‡å°¾æ”¾ä½ çš„åå­—æ„Ÿè¬", type: "item", chance: 40 },
  { name: "YTå½±ç‰‡ç‰‡å°¾çµ¦ä½ æ”¾10ç§’çš„å»£å‘Š", type: "item", chance: 15 },
  { name: "æ±ºå®šä¸‹æ¬¡å°æ´»å‹•é¡Œæ", type: "item", chance: 15 },
  { name: "å¹«ä½ è¦åŠƒ 1 å€‹å½±ç‰‡ä¸»é¡Œæ–¹å‘", type: "item", chance: 10 },
  { name: "è®“ä½ æ±ºå®šä¸€æ¬¡ç¶²ç«™é¦–é å°å…¬å‘Šæ–‡å­—", type: "item", chance: 10 },
  { name: "ç›´æ¥å®Œæˆä¸€å€‹çå‹µ300Fayå¹£ä»¥ä¸‹çš„ä¸€èˆ¬ä»»å‹™", type: "item", chance: 10 },
];

// åŠ æ¬Šéš¨æ©ŸæŠ½ç (æ™®é€šå¯¶ç®±)
function getNormalReward() {
  const totalChance = normalChestRewards.reduce((sum, r) => sum + r.chance, 0);
  let rand = Math.random() * totalChance;
  for (let r of normalChestRewards) {
    rand -= r.chance;
    if (rand <= 0) return r;
  }
  return normalChestRewards[normalChestRewards.length - 1];
}

// === æ™®é€šå¯¶ç®±æ•¸é‡ ===
async function loadNormalChests() {
  const email = localStorage.getItem("userEmail");
  if (!email) return 0;
  try {
    const snapshot = await db.collection("userLoginRewards").where("userEmail", "==", email).get();
    if (!snapshot.empty) {
      return snapshot.docs[0].data().normalChests || 0;
    }
  } catch (e) { console.error(e); }
  return 0;
}
async function saveNormalChests(value) {
  const email = localStorage.getItem("userEmail");
  if (!email) return;
  try {
    const snapshot = await db.collection("userLoginRewards").where("userEmail", "==", email).get();
    if (!snapshot.empty) {
      await db.collection("userLoginRewards").doc(snapshot.docs[0].id).update({ normalChests: value });
    }
  } catch (e) { console.error(e); }
}
async function updateNormalChestDisplay() {
  const chests = await loadNormalChests();
  document.getElementById("normal-chest-count").innerText = chests;
}

// === é–‹å•Ÿæ™®é€šå¯¶ç®± ===
async function openNormalChest() {
  let chests = await loadNormalChests();
  if (chests <= 0) {
    alert("âŒ æ²’æœ‰æ™®é€šå¯¶ç®±å¯ä»¥æ‰“é–‹ï¼");
    return;
  }

  chests -= 1;
  await saveNormalChests(chests);
  await updateNormalChestDisplay();

  const chest = document.getElementById("normal-chest-box");
  chest.classList.add("chest-open");

  setTimeout(async () => {
    chest.classList.remove("chest-open");
    const reward = getNormalReward();
    let balance = await loadBalance();
    let msg = "";

    if (reward.type === "coins") {
      balance += reward.amount;
      await saveBalance(balance);
      msg = `ğŸ‰ æ­å–œç²å¾— ${reward.name}ï¼ç›®å‰é¤˜é¡ï¼š${balance}`;
    } else {
      msg = `ğŸ‰ æ­å–œç²å¾— ${reward.name}ï¼`;
      const email = localStorage.getItem("userEmail");
      if (email && email !== "faywooooo@gmail.com") {
        sendRewardEmail(email, reward.name, "template_7r9kdt9", "æ™®é€šå¯¶ç®±");

      }
    }

    document.getElementById("normal-reward-result").innerText = msg;
    recordChestReward(localStorage.getItem("userEmail"), reward.name);
    uploadRecord(getUserId(), balance, `æ™®é€šå¯¶ç®±ç²å¾—: ${reward.name}`);
  }, 1200);
}

// === ç¶å®šæ™®é€šå¯¶ç®±æŒ‰éˆ• ===
document.getElementById("buy-normal-chest-btn").onclick = openNormalChest;

// === è³¼è²·æ™®é€šå¯¶ç®± ===
async function buyNormalChestBundle(cost, amount) {
  let coins = await loadBalance();
  if (coins < cost) {
    alert("âŒ Fayå¹£ä¸è¶³ï¼");
    return;
  }
  coins -= cost;
  await saveBalance(coins);

  let chests = await loadNormalChests();
  chests += amount;
  await saveNormalChests(chests);
  await updateNormalChestDisplay();

  alert(`âœ… æˆåŠŸè³¼è²· ${amount} é¡†æ™®é€šå¯¶ç®±ï¼ç›®å‰é¤˜é¡ï¼š${coins} Fayå¹£`);
}

// é é¢è¼‰å…¥æ™‚æ›´æ–°é¡¯ç¤º
window.addEventListener("load", async () => {
  await updateNormalChestDisplay();
});
// ğŸ”¹ ç©å®¶ç«¯å³æ™‚æ›´æ–°æ™®é€šå¯¶ç®±æ•¸é‡
window.addEventListener('normalChestChanged', async (event) => {
  const email = localStorage.getItem('userEmail');
  if (email && event.detail.email === email) {
    document.getElementById("normal-chest-count").innerText = event.detail.count;
  }
});

// ğŸ”¹ ç©å®¶ç«¯å³æ™‚æ›´æ–°é«˜ç´šå¯¶ç®±æ•¸é‡
window.addEventListener('advancedChestChanged', async (event) => {
  const email = localStorage.getItem('userEmail');
  if (email && event.detail.email === email) {
    document.getElementById("chest-count").innerText = event.detail.count;
  }
});

</script>
<script>
  const guarantee = [1500]; // ä¿å¤¾é–€æª»
let prizePool = [
...normalChestRewards.map(r => r.name),
...chestRewards.map(r => r.name)
];

  
  function renderPrizes(){
    const bed = document.getElementById("prizeBed");
    bed.innerHTML = "";
    prizePool.forEach(p=>{
      const d = document.createElement("div");
      d.className = "prize";
      d.innerText = p;
      bed.appendChild(d);
    });
  }
  
  function updateProgressBar(){
    let pct = (clawProgress % Math.max(...guarantee)) / Math.max(...guarantee) * 100;
    document.getElementById("progressFill").style.width = pct+"%";
  }
  
async function playClawMachine() {
  const email = localStorage.getItem("userEmail");
  if (!email) { alert("è«‹å…ˆç™»å…¥"); return; }

  let balance = await loadBalance();
  if (balance < 10) {
    alert("âŒ Fayå¹£ä¸è¶³ï¼Œç„¡æ³•éŠç©ï¼");
    return;
  }
  balance -= 10;
  await saveBalance(balance);

  const progressRef = db.collection("systemSettings").doc("clawMachine");
  await db.runTransaction(async (t) => {
    const doc = await t.get(progressRef);
    let current = doc.exists ? doc.data().progress || 0 : 0;
    current += 10;
    t.set(progressRef, { progress: current }, { merge: true });
  });

  const clawArm = document.getElementById("clawArm");
  const clawGrabber = document.getElementById("clawGrabber");
  const hole = document.getElementById("prizeHole");

  clawArm.style.transition = "top 1s ease-in-out";
  clawArm.style.top = "200px"; // çˆªå­å¾€ä¸‹

  setTimeout(() => {
    clawGrabber.classList.add("claw-grab");

    // é¸ä¸­çå“
    let won = prizePool[Math.floor(Math.random() * prizePool.length)];
    let target = [...document.querySelectorAll("#prizeBed .ticket")]
                   .find(p => p.innerText === won);

    if (target) {
      // æŠŠçå“ç§»åˆ°çˆªå­ä¸Š
      target.style.transition = "all 1s ease";
      target.style.position = "absolute";
      target.style.top = "220px";
      target.style.left = "50%";
      target.style.transform = "translateX(-50%) scale(1)";
      clawArm.appendChild(target);
    }
    // æˆ–æ¥µä½æ©Ÿç‡ç›´æ¥ä¸­
    if (!won && Math.random() < 0.01) {
      won = prizePool[Math.floor(Math.random() * prizePool.length)];
    }
    // çˆªå­å¾€ä¸Š
    setTimeout(() => {
      clawArm.style.top = "-120px";

      setTimeout(() => {
  clawArm.style.top = "-120px";

  // ç§»åˆ°æ´å£
  setTimeout(() => {
    clawArm.style.left = "50%";

    if (target) {
if (Math.random() < 0.90) {
  // æ‰å›å» â†’ æ’­æ”¾å¾€å¾Œç”©å‹•ç•«
  target.classList.add("fall-back");

  target.addEventListener("animationend", () => {
    target.classList.remove("fall-back");

    // æ‰å› prizeBed éš¨æ©Ÿä½ç½®
    target.style.position = "absolute";
    target.style.top = Math.random() * 40 + "%";
    target.style.left = Math.random() * 80 + "%";
    target.style.transform = `rotate(${Math.floor(Math.random()*60-30)}deg) scale(${0.8+Math.random()*0.6})`;
    document.getElementById("prizeBed").appendChild(target);
  }, { once: true });

  document.getElementById("clawResult").innerText = "âŒ å†æ¥å†å²";
}
 else {
        // 4% æˆåŠŸæ”¾å…¥æ´å£
        target.style.top = "300px";
        target.style.left = hole.offsetLeft + hole.offsetWidth/2 + "px";
        target.style.transition = "all 1s ease";

        setTimeout(() => {
          target.remove();
          document.getElementById("clawResult").innerText = "ğŸ‰ æ­å–œç²å¾—ï¼šã€Œ" + won + "ã€";

          db.collection("clawRewardsHistory").add({
            userEmail: email,
            reward: won,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });

if (email && email !== "faywooooo@gmail.com") {
  sendRewardEmail(email, won, "template_7r9kdt9", "æŠ“å¨ƒå¨ƒæ©Ÿ");
}
 }, 1000);
      }
    }

  }, 1200);

}, 1000);

    }, 1000);

  }, 1000);
  let currentProgress = globalProgress || 0;
let won;

if (currentProgress >= guarantee[0]) {
  won = prizePool[Math.floor(Math.random() * prizePool.length)];
  // âœ… é‡ç½®é€²åº¦
  await db.collection("systemSettings").doc("clawMachine").set({ progress: 0 }, { merge: true });

  document.getElementById("clawResult").innerText = "ğŸ¯ ä¿å¤¾æˆåŠŸï¼šã€Œ" + won + "ã€";
  db.collection("clawRewardsHistory").add({
    userEmail: email,
    reward: won,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  if (email && email !== "faywooooo@gmail.com") {
    sendRewardEmail(email, won, "template_7r9kdt9", "æŠ“å¨ƒå¨ƒæ©Ÿ");
  }
  return; // ç›´æ¥çµæŸé€™æ¬¡æµç¨‹
}


}


  
  document.getElementById("playClaw").addEventListener("click",playClawMachine);

// é¡¯ç¤ºä¸­ççš„ prize ç™¼å…‰
function highlightPrize(name){
  const prizes = document.querySelectorAll("#prizeBed .prize");
  prizes.forEach(p=>{
    if(p.innerText === name){
      p.classList.add("win");
      setTimeout(()=>p.classList.remove("win"), 2000);
    }
  });
}
function renderPrizes(){
  const bed = document.getElementById("prizeBed");
  bed.innerHTML = "";
  prizePool.forEach(p=>{
    const d = document.createElement("div");

    // 50% ç”Ÿæˆä¸€èˆ¬å·ï¼Œ50% ç”Ÿæˆæ²æ²å·
    const isRoll = Math.random() < 0.5;
    d.className = isRoll ? "ticket roll" : "ticket";
    d.innerText = p;

    // éš¨æ©Ÿä½ç½® & æ—‹è½‰
    const x = Math.random() * 80; // %
    const y = Math.random() * 40; // %
    const rot = Math.floor(Math.random()*60 - 30); // -30Â° ~ 30Â°
    const scale = 0.8 + Math.random()*0.6; // 0.8 ~ 1.4 å€

    d.style.position = "absolute";
    d.style.left = x+"%";
    d.style.top = y+"%";
    d.style.transform = `rotate(${rot}deg) scale(${scale})`;

    bed.appendChild(d);
  });
}
function highlightPrize(name){
  const prizes = document.querySelectorAll("#prizeBed .ticket");
  prizes.forEach(p=>{
    if(p.innerText === name){
      p.classList.add("win");
      setTimeout(()=> {
        p.remove(); // å‹•ç•«çµæŸå¾Œç§»é™¤
      }, 1500);
    }
  });
}
// ğŸ”¹ å³æ™‚ç›£è½æŠ“å¨ƒå¨ƒä¸­çç´€éŒ„
let lastClawTimestamp = null;

function listenToClawRewards() {
  db.collection("clawRewardsHistory").orderBy("timestamp","desc").limit(5)
    .onSnapshot(snapshot=>{
      snapshot.docChanges().forEach(change=>{
        if (change.type === "added") {
          const data = change.doc.data();

          // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¼‰å…¥ï¼Œè¨˜ä½æœ€æ–°çš„ timestampï¼Œä¸é¡¯ç¤º
          if (!lastClawTimestamp) {
            lastClawTimestamp = data.timestamp?.toMillis?.() || Date.now();
            return;
          }

          // ä¹‹å¾Œåªé¡¯ç¤ºã€Œæ¯” baseline æ›´æ–°çš„ã€
          const ts = data.timestamp?.toMillis?.() || 0;
          if (ts > lastClawTimestamp) {
            showClawAnnouncement(data.userEmail, data.reward);
            lastClawTimestamp = ts;
          }
        }
      });
    });
}


// ğŸ”¹ é¡¯ç¤ºå…¬å‘Š
function showClawAnnouncement(userEmail, reward) {
  const shortEmail = userEmail ? userEmail.replace(/(.{3}).+(@.+)/, "$1***$2") : "ç©å®¶";
  const msg = `ğŸ‰ ${shortEmail} åœ¨æŠ“å¨ƒå¨ƒæ©Ÿå¤¾ä¸­äº† ${reward}ï¼`;
  const toast = document.createElement("div");
  toast.className="reward-toast";
  toast.innerText=msg;
  document.body.appendChild(toast);
  setTimeout(()=>toast.classList.add("show"),100);
  setTimeout(()=>{
    toast.classList.remove("show");
    setTimeout(()=>toast.remove(),500);
  },5000);
}

// ğŸ”¹ åˆå§‹åŒ–æ™‚å•Ÿå‹•ç›£è½
listenToClawRewards();

// ğŸ”¹ å³æ™‚ç›£è½ä¿å¤¾é€²åº¦
function listenClawProgress() {
  db.collection("systemSettings").doc("clawMachine")
    .onSnapshot(doc => {
      if (doc.exists) {
        globalProgress = doc.data().progress || 0;
        updateProgressBar();
      }
    });
}
if (Math.random() < 0.90) {
  // å¤±æ•— â†’ çå“æ‰å› prizeBed
} else {
  // æˆåŠŸ â†’ æ”¾åˆ°æ´å£
}

// ğŸ”¹ æ›´æ–°é€²åº¦æ¢
function updateProgressBar() {
  let pct = (globalProgress % Math.max(...guarantee)) / Math.max(...guarantee) * 100;
  document.getElementById("progressFill").style.width = pct + "%";
}

// ğŸ”¹ æŠ“å¨ƒå¨ƒæµç¨‹ï¼ˆæ–°å¢æ‰£ Fay å¹£ + å…¨æœé€²åº¦ï¼‰
renderPrizes();
listenClawProgress();
listenToClawRewards();
document.getElementById("playClaw").addEventListener("click", playClawMachine);
async function buyGuaranteeClaw(cost) {
  let coins = await loadBalance();
  if (coins < cost) {
    alert("âŒ Fayå¹£ä¸è¶³ï¼");
    return;
  }
  coins -= cost;
  await saveBalance(coins);

  // âœ… ç›´æ¥ä¿å¤¾æˆåŠŸ
  const email = localStorage.getItem("userEmail");
  const won = prizePool[Math.floor(Math.random() * prizePool.length)];

  document.getElementById("clawResult").innerText = "ğŸ¯ ä¿å¤¾è³¼è²·æˆåŠŸï¼šã€Œ" + won + "ã€";
  db.collection("clawRewardsHistory").add({
    userEmail: email,
    reward: won,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  if (email && email !== "faywooooo@gmail.com") {
    sendRewardEmail(email, won, "template_7r9kdt9", "ä¿å¤¾è³¼è²·");
  }

  // âœ… é‡ç½®ä¿å¤¾é€²åº¦
  await db.collection("systemSettings").doc("clawMachine").set({ progress: 0 }, { merge: true });
}
async function redeemTool(price) {
  let balance = await loadBalance();
  if (balance >= price) {
    balance -= price;
    await saveBalance(balance);
    document.getElementById('coin-balance').textContent = balance;

    // Firestore å¢åŠ  5 æ¬¡é¡åº¦
    const email = localStorage.getItem('userEmail');
    if (!email) return;

    const snapshot = await db.collection('userLoginRewards').where('userEmail', '==', email).get();
    if (!snapshot.empty) {
      const docRef = db.collection('userLoginRewards').doc(snapshot.docs[0].id);
      const data = snapshot.docs[0].data();
      let quota = data.toolQuota || 0;
      quota += 5;
      await docRef.update({ toolQuota: quota });
      alert(`âœ… å·²æˆåŠŸå…Œæ› 5 æ¬¡ AI è©•ä¼°å·¥å…·é¡åº¦ï¼å‰©é¤˜ Fayå¹£ï¼š${balance}ï¼Œç¸½é¡åº¦ï¼š${quota} æ¬¡`);
    }
  } else {
    alert('âŒ Fayå¹£ä¸è¶³ï¼Œç„¡æ³•å…Œæ›ï¼');
  }
}
async function loadToolQuota() {
  const email = localStorage.getItem('userEmail');
  if (!email) return;
  try {
    const snapshot = await db.collection('userLoginRewards').where('userEmail', '==', email).get();
    if (!snapshot.empty) {
      const data = snapshot.docs[0].data();
      const quota = data.toolQuota || 0;
      document.getElementById('tool-quota').textContent = quota;
    }
  } catch (e) {
    console.error("âŒ ç„¡æ³•è®€å–å·¥å…·é¡åº¦", e);
  }
}

// é é¢è¼‰å…¥æ™‚æ›´æ–°ä¸€æ¬¡
window.addEventListener("load", async () => {
  await loadBalance();
  await fetchItems();
  await loadToolQuota(); // âœ… é¡åº¦é¡¯ç¤º
  setInterval(fetchItems, 5000);
});


  </script>
  <script>
    const currentEmail = localStorage.getItem('userEmail') || '';
    
    if (currentEmail.toLowerCase() !== 'faywooooo@gmail.com') {
      // ç¦æ­¢ F12ã€Ctrl+Sã€Ctrl+U
      document.addEventListener('keydown', function (e) {
        if (e.key === 'F12') {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
        if (e.ctrlKey && (e.key.toLowerCase() === 's' || e.key.toLowerCase() === 'u')) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      });
    
      // ç¦æ­¢å³éµé¸å–®
      document.addEventListener('contextmenu', function (e) {
        e.preventDefault();
        return false;
      });
    }
    </script>
    
</body>
</html>
