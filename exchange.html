<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Fay幣兌換區 - FayWooooo</title>
    <link rel="icon" href="logo.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  emailjs.init("Rna6NHThG_VW9eyRE"); // ⚠️ 填你的 Public Key
</script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    @font-face {
    font-family: 'hanwangheiheavy';
    src: url('https://www.moedict.tw/fonts/truetype/wang/wt014.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
  }
    body {
      background-image: linear-gradient(rgb(8, 19, 41), rgb(0, 0, 0));
      color: white;
      font-family: 'hanwangheiheavy', sans-serif;
      margin: 20px;
      text-align: center;
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }
    .exchange-container {
      background: rgba(255,255,255,0.07);
      padding: 20px;
      border-radius: 20px;
      max-width: 90%;
      margin: 50px auto;
      box-shadow: 0 8px 25px rgba(0,0,0,0.5);
      position: relative;
    }
    h1 { color: gold; }
    .balance {
      font-size: 20px;
      margin-bottom: 20px;
    }
    .items-wrapper {
      display: flex;
      overflow: hidden;
      width: 100%;
      position: relative;
    }
    .items-container {
      display: flex;
      transition: transform 0.5s ease;
      width: 100%;
    }
    .item {
      border: 1px solid gold;
      padding: 15px;
      border-radius: 12px;
      margin: 0 10px;
      min-width: 250px;
      max-width: 250px;
      flex-shrink: 0;
      background: rgba(255,255,255,0.05);
      user-select: none;
    }
    button {
      background-color: gold;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      margin-top: 8px;
    }
    button:disabled {
      background-color: gray;
      cursor: not-allowed;
    }
    .nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
      z-index: 5;
    }
    .nav-btn:hover {
      background: gold;
      color: black;
    }
    #prev-btn { left: -10px; }
    #next-btn { right: -10px; }
    @media (max-width:768px){
      .item {
        min-width: 200px;
        max-width: 200px;
      }
    }
    .admin-panel {
      background: rgba(255, 0, 0, 0.1);
      border: 2px solid #ff4444;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
      display: none;
    }

    .admin-title {
      color: #ff6666;
      font-size: 24px;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .admin-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      align-items: center;
    }

    .admin-input {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      width: 200px;
    }

    .admin-button {
      background: linear-gradient(45deg, #ff4444, #ff6666);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .admin-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 68, 68, 0.4);
    }

    .admin-select {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
    }

    .admin-info {
      color: #ffaaaa;
      font-size: 12px;
      margin-top: 10px;
    }
    .chest-container {
  background: rgba(255,255,255,0.05);
  padding: 20px;
  border-radius: 15px;
  margin-top: 30px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.5);
}
#buy-chest-btn {
  background: linear-gradient(45deg, gold);
  color: black;
  border: none;
  padding: 12px 25px;
  font-size: 18px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
}
#buy-chest-btn:hover {
  transform: scale(1.1);
  background: linear-gradient(45deg, orange);
}
.chest-box {
  margin: 20px auto;
  width: 120px;
  height: 100px;
  position: relative;
  perspective: 1000px;
}
.chest-lid {
  width: 120px;
  height: 40px;
  background: rgb(24, 0, 113);
  border: 3px solid #ffffff;
  position: absolute;
  top: 0;
  transform-origin: bottom;
  transition: transform 0.8s ease;
  border-radius: 5px 5px 0 0;
}
.chest-body {
  width: 120px;
  height: 60px;
  background: rgb(0, 0, 0);
  border: 3px solid #ffffff;
  position: absolute;
  bottom: 0;
  border-radius: 0 0 5px 5px;
}
.chest-open .chest-lid {
  transform: rotateX(-120deg);
}

/* 抽獎公告 Toast */
.reward-toast {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%) translateY(50px);
  background: rgba(0,0,0,0.8);
  color: gold;
  padding: 12px 25px;
  border-radius: 10px;
  font-size: 18px;
  opacity: 0;
  transition: all 0.5s ease;
  z-index: 10000;
}
.reward-toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

  </style>
</head>
<body>
  <script>
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      alert('⚠️ 請先登入才能查看任務');
      window.location.href = 'index.html';
    }
  </script>
  
  <h1 style="font-size: 55px;font-weight:normal;color:white;">Fay幣兌換區</h1>
  
  <div id="admin-panel" class="admin-panel">
    <div class="admin-title">官方管理面板</div>
    <div class="admin-controls">
      <input type="text" id="user-email-input" class="admin-input" placeholder="輸入帳號 Email" list="user-suggestions"/>
      <datalist id="user-suggestions"></datalist>

      <select id="action-select" class="admin-select">
        <option value="add">增加 Fay幣</option>
        <option value="subtract">減少 Fay幣</option>
        <option value="reset">歸零</option>
      </select>

      <input type="number" id="coin-amount-input" class="admin-input" placeholder="輸入數量" />
      <button onclick="applyAdminAction()" class="admin-button">執行</button>
    </div>
    <div class="admin-info">⚠️ 此功能僅限官方帳號使用</div>
  </div>

  <div class="exchange-container">
    <div class="balance">目前餘額：<span id="coin-balance">0</span> Fay幣</div>
    <div class="items-wrapper">
      <div id="items-container" class="items-container"></div>
    </div>
    <!-- ===== 普通寶箱系統 ===== -->
<div class="chest-container">
  <p>剩餘普通寶箱數量：<span id="normal-chest-count">0</span> 顆</p>
  <h2 style="color:lightblue;">普通寶箱</h2>
  <button id="buy-normal-chest-btn">開啟普通寶箱</button>

  <div id="normal-chest-box" class="chest-box">
    <div class="chest-lid"></div>
    <div class="chest-body"></div>
  </div>
  <p id="normal-reward-result" style="margin-top:15px;font-size:18px;color:lightgreen;"></p>
  <button onclick="buyNormalChestBundle(200, 1)">購買 1 顆普通寶箱 (200 Fay幣)</button><br>
  <button onclick="buyNormalChestBundle(380, 2)">購買 2 顆普通寶箱 (380 Fay幣)</button>
</div>

    <!-- ===== 高級寶箱系統 ===== -->
<div class="chest-container">
  <p>剩餘高級寶箱數量：<span id="chest-count">0</span> 顆</p>
  <h2 style="color:gold;">高級寶箱</h2>
  <button id="buy-chest-btn">開啟高級寶箱</button>

  <div id="chest-box" class="chest-box">
    <div class="chest-lid"></div>
    <div class="chest-body"></div>
  </div>
  <p id="reward-result" style="margin-top:15px;font-size:18px;color:lightgreen;"></p>
    <button onclick="buyChestBundle(500, 1)">購買 1 顆高級寶箱 (500 Fay幣)</button><br>
  <button onclick="buyChestBundle(1000, 2)">購買 3 顆高級寶箱 (1000 Fay幣)</button>
</div>

  </div>
  
  <button style="margin-top:20px;" onclick="window.location.href='index.html'">回首頁</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // 確保登入狀態
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      alert('⚠️ 請先登入才能進入此頁面');
      window.location.href = 'index.html';
    }

    const userEmail = localStorage.getItem('userEmail') || '';
    const userName = localStorage.getItem('userName') || '';
    const userId = localStorage.getItem('userId') || '';

    const firebaseConfig = {
      apiKey: "AIzaSyAw3NxfRft4pke6TUl9gQ4a8P0LEm30zWo",
      authDomain: "faycoin-bb878.firebaseapp.com",
      projectId: "faycoin-bb878",
      storageBucket: "faycoin-bb878.appspot.com",
      messagingSenderId: "665116400856",
      appId: "1:665116400856:web:a263d792c69129400d8bad",
      measurementId: "G-ZSZZD4W1HX"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/1D62EhlL1CFk7RXxu7NE-3HrWd6Ci6ZlMMaWXCMa2w5w/gviz/tq?tqx=out:csv';
    const PROXY_URL = 'https://corsproxy.io/?';

    let itemsData = [];
    const itemsPerPage = 3;
    let currentPage = 0;

    async function fetchItems() {
      try {
        const response = await fetch(PROXY_URL + encodeURIComponent(SHEET_CSV_URL));
        if (!response.ok) throw new Error('無法載入商品資料');
        const csvText = await response.text();
        itemsData = parseCSV(csvText);
        renderItems();
      } catch (error) {
        console.error('讀取試算表失敗：', error);
      }
    }

    function parseCSV(text) {
      const lines = text.split('\n').filter(l => l.trim() !== '');
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const parts = lines[i].split(',');
        if (parts.length >= 2) {
          let name = parts[0].trim();
          let priceStr = parts[1].trim();

          if (name.startsWith('"') && name.endsWith('"')) name = name.slice(1, -1);
          if (priceStr.startsWith('"') && priceStr.endsWith('"')) priceStr = priceStr.slice(1, -1);

          const price = parseInt(priceStr);
          if (name && !isNaN(price)) data.push({ name, price });
        }
      }
      return data;
    }

    function renderItems() {
      const container = document.getElementById('items-container');
      container.innerHTML = '';
      itemsData.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <h3>${item.name}</h3>
          <p>價格：${item.price} Fay幣</p>
          <button onclick="redeem(${item.price})">立即兌換</button>
        `;
        container.appendChild(div);
      });
      updatePage();
    }

    function updatePage() {
      const container = document.getElementById('items-container');
      const totalPages = Math.ceil(itemsData.length / itemsPerPage);
      const offset = -currentPage * (itemsPerPage * 270);
      container.style.transform = `translateX(${offset}px)`;
    }

    function nextPage() {
      const totalPages = Math.ceil(itemsData.length / itemsPerPage);
      currentPage = (currentPage + 1) % totalPages;
      updatePage();
    }

    function prevPage() {
      const totalPages = Math.ceil(itemsData.length / itemsPerPage);
      currentPage = (currentPage - 1 + totalPages) % totalPages;
      updatePage();
    }

    // 🔹 修正：統一使用 Firebase 載入餘額
    async function loadBalance() {
      const email = localStorage.getItem('userEmail');
      if (!email) {
        document.getElementById('coin-balance').textContent = 0;
        return 0;
      }

      try {
        const snapshot = await db.collection('userLoginRewards')
          .where('userEmail', '==', email)
          .get();

        let coins = 0;
        if (!snapshot.empty) {
          coins = snapshot.docs[0].data().coins || 0;
        }

        // 同步更新本地儲存和畫面
        localStorage.setItem(`fayCoins_${email}`, coins);
        localStorage.setItem('fayCoinBalance', coins.toString());
        document.getElementById('coin-balance').textContent = coins;
        
        return coins;
      } catch (error) {
        console.error('載入餘額失敗：', error);
        // 如果 Firebase 失敗，嘗試從本地儲存讀取
        const localCoins = parseInt(localStorage.getItem(`fayCoins_${email}`) || '0');
        document.getElementById('coin-balance').textContent = localCoins;
        return localCoins;
      }
    }

    // 🔹 修正：同步更新 Firebase 和本地儲存
    async function saveBalance(value) {
      const email = localStorage.getItem('userEmail');
      if (!email) return;

      // 更新本地儲存
      localStorage.setItem(`fayCoins_${email}`, value);
      localStorage.setItem('fayCoinBalance', value.toString());

      // 更新 Firebase
      try {
        const snapshot = await db.collection('userLoginRewards')
          .where('userEmail', '==', email)
          .get();

        if (!snapshot.empty) {
          await db.collection('userLoginRewards')
            .doc(snapshot.docs[0].id)
            .update({ coins: value });
        }
      } catch (error) {
        console.error('儲存餘額失敗：', error);
      }

      // 發送事件通知其他頁面
      window.dispatchEvent(new CustomEvent('fayCoinChanged', {
        detail: { newBalance: value }
      }));
    }

    async function redeem(price) {
      let balance = await loadBalance();
      const item = itemsData.find(it => it.price === price)?.name || '未知商品';

      if (balance >= price) {
        balance -= price;
        await saveBalance(balance);
        document.getElementById('coin-balance').textContent = balance;
        alert(`✅ 兌換成功！剩餘 Fay幣：${balance}`);
        uploadRecord(getUserId(), balance, item);
      } else {
        alert('❌ Fay幣不足，無法兌換！');
      }
    }

    function getUserId() {
      let uid = localStorage.getItem('userId');
      if (!uid) {
        uid = 'user_' + Math.random().toString(36).substring(2, 12);
        localStorage.setItem('userId', uid);
      }
      return uid;
    }

    function uploadRecord(userId, coins, item) {
      db.collection('exchangeRecords').add({
        userId: userId,
        coins: coins,
        item: item,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        console.log('✅ 已寫入 Firestore');
      }).catch(err => {
        console.error('❌ Firestore 寫入失敗', err);
      });
    }

    // 🔹 修正：優化管理員操作提示訊息
    async function applyAdminAction() {
      let email = document.getElementById('user-email-input').value.trim();

      if (!email) {
        alert('請輸入帳號 Email');
        return;
      }

      email = email.toLowerCase();
      const action = document.getElementById('action-select').value;
      const amount = parseInt(document.getElementById('coin-amount-input').value) || 0;

      if ((action === 'add' || action === 'subtract') && amount <= 0) {
        alert('請輸入有效數字');
        return;
      }

      try {
        console.log("🔍 正在查詢帳號：", email);

        const userRef = db.collection('userLoginRewards')
                          .where('userEmail', '==', email);
        const snapshot = await userRef.get();

        if (snapshot.empty) {
          console.warn("❌ 查無資料，列出所有帳號供檢查：");
          const allUsers = await db.collection('userLoginRewards').get();
          allUsers.forEach(doc => console.log("📌", doc.data().userEmail));
          alert('找不到該帳號，請確認 Email 是否正確');
          return;
        }

        snapshot.forEach(async (doc) => {
          let balance = doc.data().coins || 0;

          if (action === 'add') {
            balance += amount;
          } else if (action === 'subtract') {
            balance = Math.max(0, balance - amount);
          } else if (action === 'reset') {
            balance = 0;
          }

          await db.collection('userLoginRewards').doc(doc.id).update({ coins: balance });
          
          // 🔹 優化提示訊息：只顯示最終餘額
          alert(`✅ ${email} 的 Fay幣餘額已調整為：${balance}`);
          
          // 如果是目前登入者，同步更新畫面
          if (email === localStorage.getItem('userEmail')) {
            document.getElementById('coin-balance').textContent = balance;
            localStorage.setItem(`fayCoins_${email}`, balance);
            localStorage.setItem('fayCoinBalance', balance.toString());
          }

          uploadRecord(email, balance, `【官方操作-${action}】`);
          
          // 清空輸入框
          document.getElementById('coin-amount-input').value = '';
        });
      } catch (err) {
        console.error("❌ Firebase 更新失敗", err);
        alert('操作失敗，請檢查控制台');
      }
    }

    // 載入所有使用者帳號供管理員選擇
    async function loadAllUsersFromFirebase() {
      try {
        const snapshot = await db.collection('userLoginRewards').get();
        const datalist = document.getElementById("user-suggestions");
        datalist.innerHTML = "";

        snapshot.forEach(doc => {
          const email = doc.data().userEmail;
          if (email) {
            const option = document.createElement("option");
            option.value = email;
            datalist.appendChild(option);
          }
        });
      } catch (err) {
        console.error("❌ 讀取帳號清單失敗", err);
      }
    }
function enableResponsiveDrag(wrapperSelector, containerSelector, updateFunc) {
  const wrapper = document.querySelector(wrapperSelector);
  const container = document.querySelector(containerSelector);

  let isDown = false;
  let startX, currentTranslate = 0, prevTranslate = 0, animationID;
  let currentIndex = 0;

  // 判斷裝置大小（小於 768px 視為手機）
  function isMobile() {
    return window.innerWidth <= 768;
  }

  function setSliderPosition() {
    container.style.transform = `translateX(${currentTranslate}px)`;
  }

  function animation() {
    setSliderPosition();
    if (isDown) requestAnimationFrame(animation);
  }

  // 桌機滑鼠
  wrapper.addEventListener("mousedown", (e) => {
    isDown = true;
    startX = e.pageX;
    wrapper.style.cursor = "grabbing";
    animationID = requestAnimationFrame(animation);
  });

  wrapper.addEventListener("mousemove", (e) => {
    if (!isDown) return;
    const x = e.pageX;
    const dx = x - startX;
    currentTranslate = prevTranslate + dx;
  });

  wrapper.addEventListener("mouseup", (e) => {
    cancelAnimationFrame(animationID);
    isDown = false;
    wrapper.style.cursor = "grab";

    const dx = e.pageX - startX;

    if (!isMobile()) {
      // 桌機翻頁：一次 2 格
      if (dx < -50) currentIndex += 2;
      if (dx > 50) currentIndex -= 2;
      if (currentIndex < 0) currentIndex = 0;
      const maxIndex = container.children.length - 2;
      if (currentIndex > maxIndex) currentIndex = maxIndex;

      const itemWidth = container.children[0].offsetWidth + 20;
      currentTranslate = -currentIndex * itemWidth;
      prevTranslate = currentTranslate;
      setSliderPosition();
      if (typeof updateFunc === "function") updateFunc();
    } else {
      prevTranslate = currentTranslate;
    }
  });

  wrapper.addEventListener("mouseleave", () => {
    if (isDown) {
      isDown = false;
      wrapper.style.cursor = "grab";
      cancelAnimationFrame(animationID);
    }
  });

  // 手機觸控
  wrapper.addEventListener("touchstart", (e) => {
    isDown = true;
    startX = e.touches[0].clientX;
    animationID = requestAnimationFrame(animation);
  });

  wrapper.addEventListener("touchmove", (e) => {
    if (!isDown) return;
    const x = e.touches[0].clientX;
    const dx = x - startX;
    if (isMobile()) {
      currentTranslate = prevTranslate + dx;
    }
  });

  wrapper.addEventListener("touchend", (e) => {
    cancelAnimationFrame(animationID);
    isDown = false;

    const dx = e.changedTouches[0].clientX - startX;

    if (!isMobile()) {
      // 桌機翻頁：一次 2 格
      if (dx < -50) currentIndex += 2;
      if (dx > 50) currentIndex -= 2;
      if (currentIndex < 0) currentIndex = 0;
      const maxIndex = container.children.length - 2;
      if (currentIndex > maxIndex) currentIndex = maxIndex;

      const itemWidth = container.children[0].offsetWidth + 20;
      currentTranslate = -currentIndex * itemWidth;
    }
    prevTranslate = currentTranslate;
    setSliderPosition();
  });
}

// 啟用
window.addEventListener("load", () => {
  if (document.getElementById("items-container")) {
    enableResponsiveDrag(".items-wrapper", "#items-container", updatePage);
  }
  if (document.getElementById("carousel")) {
    enableResponsiveDrag(".carousel-wrapper", "#carousel", updateCarousel);
  }
});

    // 🔹 頁面載入時初始化
    window.onload = async () => {
  await loadBalance();
  await fetchItems();
  setInterval(fetchItems, 5000);

  const email = localStorage.getItem('userEmail');
  const adminEmails = ["faywooooo@gmail.com", "faywooooobs@gmail.com"]; // 允許多個帳號
  const isAdmin = adminEmails.includes(email);

  if (isAdmin) {
    document.getElementById('admin-panel').style.display = 'block';
    loadAllUsersFromFirebase();
  }

  listenToChestRewards(); // 啟動公告監聽
};


    // 監聽 Fay幣變化事件（來自其他頁面）
    window.addEventListener('fayCoinChanged', async (event) => {
      const newBalance = event.detail.newBalance;
      document.getElementById('coin-balance').textContent = newBalance;
    });
    // 在購買按鈕的點擊事件中
if (handlePurchase('商品名稱', 50)) {
  // 購買成功的處理
}
// 現在仍然可以這樣用，會自動同步
addFayCoins(15);
  </script>
  <script type="module">
  import './faycoin-sync.js';
</script>


<script>
const key = `forceReload:${location.pathname.split('/').pop()}`;
const lastReload = localStorage.getItem(key);
if (lastReload) {
  localStorage.removeItem(key);
  location.reload();
}
const reloadKey = `forceReload:${location.pathname.split('/').pop()}`;
const reloadValue = localStorage.getItem(reloadKey);
if (reloadValue) {
  localStorage.removeItem(reloadKey);
  location.reload();
}
// Fay寶箱獎勵池 (含機率)
const chestRewards = [
{ name: "教你做吸睛縮圖(基礎技巧)", type: "item", chance: 15 },
{ name: "教你免費工具做專業縮圖", type: "item", chance: 15 },
{ name: "教你用手機快速剪影片", type: "item", chance: 12 },
{ name: "教你高級剪輯技巧", type: "item", chance: 8 },
{ name: "頻道診斷一次(幫你看優缺點)", type: "item", chance: 8 },
{ name: "量身規劃你的影片主題方向", type: "item", chance: 8 },
{ name: "教你頻道經營(30分鐘)", type: "item", chance: 8 },
{ name: "@你叫你爸爸5次", type: "item", chance: 8 },
{ name: "給你管+讓全部管可以@All", type: "item", chance: 6 },
{ name: "讓你決定下部影片題材", type: "item", chance: 6 },
{ name: "我幫你做一個專屬宣傳片", type: "item", chance: 6 }

];
// 加權隨機抽獎
function getWeightedReward() {
  const totalChance = chestRewards.reduce((sum, r) => sum + r.chance, 0);
  let rand = Math.random() * totalChance;
  for (let r of chestRewards) {
    rand -= r.chance;
    if (rand <= 0) return r;
  }
  return chestRewards[chestRewards.length - 1];
}

// === Fay寶箱數量 ===
async function loadChests() {
  const email = localStorage.getItem("userEmail");
  if (!email) return 0;
  try {
    const snapshot = await db.collection("userLoginRewards").where("userEmail", "==", email).get();
    if (!snapshot.empty) {
      return snapshot.docs[0].data().chests || 0;
    }
  } catch (e) { console.error(e); }
  return 0;
}
async function saveChests(value) {
  const email = localStorage.getItem("userEmail");
  if (!email) return;
  try {
    const snapshot = await db.collection("userLoginRewards").where("userEmail", "==", email).get();
    if (!snapshot.empty) {
      await db.collection("userLoginRewards").doc(snapshot.docs[0].id).update({ chests: value });
    }
  } catch (e) { console.error(e); }
}
async function updateChestDisplay() {
  const chests = await loadChests();
  document.getElementById("chest-count").innerText = chests;
}

// === 開啟寶箱（一次只開一顆） ===
// === 開啟寶箱（一次只開一顆） ===
async function openChest() {
  let chests = await loadChests();
  if (chests <= 0) {
    alert("❌ 沒有寶箱可以打開！");
    return;
  }

  // 扣除一顆寶箱
  chests -= 1;
  await saveChests(chests);
  await updateChestDisplay();

  // 播放動畫
  const chest = document.getElementById("chest-box");
  chest.classList.add("chest-open");

  setTimeout(async () => {
    chest.classList.remove("chest-open");
    const reward = getWeightedReward();
    let balance = await loadBalance();
    let msg = "";

    if (reward.type === "coins") {
      // 加 Fay 幣
      balance += reward.amount;
      await saveBalance(balance);
      msg = `🎉 恭喜獲得 ${reward.name}！目前餘額：${balance}`;
    } else {
      // 獲得物品
      msg = `🎉 恭喜獲得 ${reward.name}！`;

      const email = localStorage.getItem("userEmail");
      if (email && email !== "faywooooo@gmail.com") {
        sendRewardEmail(email, reward.name);
      }
    }

    // 顯示結果
    document.getElementById("reward-result").innerText = msg;

    // Firestore 紀錄
    recordChestReward(localStorage.getItem("userEmail"), reward.name);
    uploadRecord(getUserId(), balance, `寶箱獲得: ${reward.name}`);
  }, 1200);
}

// === 修正按鈕綁定 ===
const chestBtn = document.getElementById("buy-chest-btn");
chestBtn.innerText = "開啟高級寶箱";
chestBtn.onclick = openChest; // ✅ 不要再用 removeEventListener

// === 頁面載入時同步更新寶箱數 ===
window.addEventListener("load", async () => {
  await updateChestDisplay();
});


async function buyChestBundle(cost, amount) {
  let coins = await loadBalance();
  if (coins < cost) {
    alert("❌ Fay幣不足！");
    return;
  }
  coins -= cost;
  await saveBalance(coins);

  let chests = await loadChests();
  chests += amount;
  await saveChests(chests);
  await updateChestDisplay();

  alert(`✅ 成功購買 ${amount} 顆寶箱！目前餘額：${coins} Fay幣`);
}

async function recordChestReward(userEmail, rewardName) {
  if (!userEmail) return;
  try {
    await db.collection("chestRewardsHistory").add({
      userEmail: userEmail,
      reward: rewardName,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  } catch (err) { console.error(err); }
}

let firstLoad = true;
function listenToChestRewards() {
  db.collection("chestRewardsHistory").orderBy("timestamp","desc").limit(5)
    .onSnapshot(snapshot=>{
      // 首次載入 → 只建立 baseline，不顯示
      if (firstLoad) {
        firstLoad = false;
        return;
      }
      snapshot.docChanges().forEach(change=>{
        if (change.type==="added") {
          const data = change.doc.data();
          showRewardAnnouncement(data.userEmail, data.reward);
        }
      });
    });
}


function showRewardAnnouncement(userEmail, reward) {
  const shortEmail = userEmail ? userEmail.replace(/(.{3}).+(@.+)/, "$1***$2") : "玩家";
  const msg = `🎉 ${shortEmail} 抽中了 ${reward}！`;
  const toast = document.createElement("div");
  toast.className="reward-toast";
  toast.innerText=msg;
  document.body.appendChild(toast);
  setTimeout(()=>toast.classList.add("show"),100);
  setTimeout(()=>{
    toast.classList.remove("show");
    setTimeout(()=>toast.remove(),500);
  },5000);
}
function sendRewardEmail(userEmail, rewardName) {
  const templateParams = {
    user: userEmail || "未知玩家",
    reward: rewardName,
    time: new Date().toLocaleString()
  };

  emailjs.send("service_g83kh8j", "template_7r9kdt9", templateParams)
    .then(function(response) {
      console.log("✅ Email 發送成功:", response.status, response.text);
    }, function(error) {
      console.error("❌ Email 發送失敗:", error);
    });
}
// === 普通寶箱獎勵池 ===
const normalChestRewards = [
  { name: "YT影片片尾放你的名字感謝", type: "item", chance: 40 },
  { name: "YT影片片尾給你放10秒的廣告", type: "item", chance: 15 },
  { name: "決定下次小活動題材", type: "item", chance: 15 },
  { name: "幫你規劃 1 個影片主題方向", type: "item", chance: 10 },
  { name: "讓你決定一次網站首頁小公告文字", type: "item", chance: 10 },
  { name: "直接完成一個獎勵300Fay幣以下的一般任務", type: "item", chance: 10 },
];

// 加權隨機抽獎 (普通寶箱)
function getNormalReward() {
  const totalChance = normalChestRewards.reduce((sum, r) => sum + r.chance, 0);
  let rand = Math.random() * totalChance;
  for (let r of normalChestRewards) {
    rand -= r.chance;
    if (rand <= 0) return r;
  }
  return normalChestRewards[normalChestRewards.length - 1];
}

// === 普通寶箱數量 ===
async function loadNormalChests() {
  const email = localStorage.getItem("userEmail");
  if (!email) return 0;
  try {
    const snapshot = await db.collection("userLoginRewards").where("userEmail", "==", email).get();
    if (!snapshot.empty) {
      return snapshot.docs[0].data().normalChests || 0;
    }
  } catch (e) { console.error(e); }
  return 0;
}
async function saveNormalChests(value) {
  const email = localStorage.getItem("userEmail");
  if (!email) return;
  try {
    const snapshot = await db.collection("userLoginRewards").where("userEmail", "==", email).get();
    if (!snapshot.empty) {
      await db.collection("userLoginRewards").doc(snapshot.docs[0].id).update({ normalChests: value });
    }
  } catch (e) { console.error(e); }
}
async function updateNormalChestDisplay() {
  const chests = await loadNormalChests();
  document.getElementById("normal-chest-count").innerText = chests;
}

// === 開啟普通寶箱 ===
async function openNormalChest() {
  let chests = await loadNormalChests();
  if (chests <= 0) {
    alert("❌ 沒有普通寶箱可以打開！");
    return;
  }

  chests -= 1;
  await saveNormalChests(chests);
  await updateNormalChestDisplay();

  const chest = document.getElementById("normal-chest-box");
  chest.classList.add("chest-open");

  setTimeout(async () => {
    chest.classList.remove("chest-open");
    const reward = getNormalReward();
    let balance = await loadBalance();
    let msg = "";

    if (reward.type === "coins") {
      balance += reward.amount;
      await saveBalance(balance);
      msg = `🎉 恭喜獲得 ${reward.name}！目前餘額：${balance}`;
    } else {
      msg = `🎉 恭喜獲得 ${reward.name}！`;
      const email = localStorage.getItem("userEmail");
      if (email && email !== "faywooooo@gmail.com") {
        sendRewardEmail(email, reward.name);
      }
    }

    document.getElementById("normal-reward-result").innerText = msg;
    recordChestReward(localStorage.getItem("userEmail"), reward.name);
    uploadRecord(getUserId(), balance, `普通寶箱獲得: ${reward.name}`);
  }, 1200);
}

// === 綁定普通寶箱按鈕 ===
document.getElementById("buy-normal-chest-btn").onclick = openNormalChest;

// === 購買普通寶箱 ===
async function buyNormalChestBundle(cost, amount) {
  let coins = await loadBalance();
  if (coins < cost) {
    alert("❌ Fay幣不足！");
    return;
  }
  coins -= cost;
  await saveBalance(coins);

  let chests = await loadNormalChests();
  chests += amount;
  await saveNormalChests(chests);
  await updateNormalChestDisplay();

  alert(`✅ 成功購買 ${amount} 顆普通寶箱！目前餘額：${coins} Fay幣`);
}

// 頁面載入時更新顯示
window.addEventListener("load", async () => {
  await updateNormalChestDisplay();
});

</script>

</body>
</html>
