<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>任務地圖 - FayWooooo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="logo.ico" type="image/x-icon">
  <!-- ✅ SEO 基礎 -->
  <meta name="description" content="FayWooooo 官方任務地圖，完成挑戰獲得 Fay 幣與寶箱，參與冒險解鎖獎勵！">
  <meta name="keywords" content="FayWooooo, Fay幣, 任務地圖, 寶箱, 遊戲, 挑戰, 獎勵系統">
  <meta name="author" content="FayWooooo Team">
  <style>
        @font-face {
    font-family: 'hanwangheiheavy';
    src: url('https://www.moedict.tw/fonts/truetype/wang/wt014.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
  }
    body {
      background: linear-gradient(to bottom, #001f3f, #000);
      color: white;
      font-family: 'hanwangheiheavy';
      text-align: center;
      padding: 20px;
    }
    h1 { color: gold; }

    .map {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-gap: 15px;
      column-gap: 20px;
      margin: 20px auto;
      max-width: 1200px;
    }
    .cell {
      width: 200px;
      height: 160px;
      border: 3px solid gold;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 10px;
      background: rgb(161, 205, 255);
      text-align: left;
      font-size: 13px;
      position: relative;
    }
    .cell h3 { margin: 0; font-size: 22px; color: black; font-weight: normal;}
    .cell h4 { margin: 0; font-size: 18px; color: black; font-weight: normal}
    .cell p { margin: 2px 0; font-size: 14px; color: black; font-weight: normal}
    .cell span { font-size: 16px; font-weight: bold; color: rgb(255,230,0); background:black; text-align:center; display:block; padding:5px; }

    .cell.active {
      background: rgb(104, 255, 139);
      color: black;
      font-weight: bold;
    }
    .cell.active h3{
      font-weight: bold;
    }
    .cell.active h4{
      font-weight: bold;
    }
    .cell.active p{
      font-weight: bold;
    }
    .btn {
      background: gold;
      color: black;
      border: none;
      padding: 12px 25px;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 20px;
      font-size: 16px;
      font-weight: bold;
    }
    .btn:disabled {
      background: gray;
      cursor: not-allowed;
    }
    .admin-panel {
      background: rgba(255, 0, 0, 0.1);
      border: 2px solid #ff4444;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .admin-title {
      color: #ff6666;
      font-size: 20px;
      margin-bottom: 10px;
      font-weight: bold;
    }
    .admin-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .admin-input, .admin-select {
      padding: 8px 12px;
      border-radius: 5px;
      border: none;
      font-size: 14px;
    }
    .admin-button {
      background: linear-gradient(45deg, #ff4444, #ff6666);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>任務地圖</h1>
  <p>目前 Fay幣：<span id="coin-balance">0</span></p>
  <div class="map" id="map"></div>

  <div id="admin-panel" class="admin-panel" style="display:none;">
    <div class="admin-title">官方管理面板</div>
    <div class="admin-controls">
      <input type="text" id="user-email-input" class="admin-input" placeholder="(留空=所有帳號)" />
      <select id="action-select" class="admin-select">
        <option value="addCoins">增加 Fay幣</option>
        <option value="removeCoins">減少 Fay幣</option>
        <option value="resetCoins">Fay幣歸零</option>
        <option value="addProgress">增加進度</option>
        <option value="removeProgress">減少進度</option>
        <option value="resetProgress">進度歸零</option>
      </select>
      <input type="number" id="action-value" class="admin-input" placeholder="輸入數值 (可留空)" />
      <button onclick="applyAdminAction()" class="admin-button">執行</button>
    </div>
    <div class="admin-info">⚠️ 此功能僅限官方帳號使用</div>
  </div>

  <p id="message"></p>
  <button class="btn" onclick="window.location.href='index.html'">回首頁</button>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAw3NxfRft4pke6TUl9gQ4a8P0LEm30zWo",
      authDomain: "faycoin-bb878.firebaseapp.com",
      projectId: "faycoin-bb878",
      storageBucket: "faycoin-bb878.appspot.com",
      messagingSenderId: "665116400856",
      appId: "1:665116400856:web:a263d792c69129400d8bad",
      measurementId: "G-ZSZZD4W1HX"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const userEmail = localStorage.getItem('userEmail');
    let coins = 0;
    let progress = 0;
    const maxStep = 10;

    const map = document.getElementById('map');
    const balanceEl = document.getElementById('coin-balance');
    const messageEl = document.getElementById('message');

    // 每格內容
    const steps = [
      { title:"1 起點", subtitle:"冒險開始", desc:"準備好出發吧！", reward:"10 Fay幣" },
      { title:"2 森林小徑", subtitle:"危險叢林", desc:"推薦官網給 5 位好友", reward:"300 Fay幣" },
      { title:"3 神秘湖泊", subtitle:"水之試煉", desc:"成功讓10個朋友訂閱我", reward:"300 Fay幣" },
      { title:"4 古代遺跡", subtitle:"文明遺跡", desc:"分享任務完成截圖給5個朋友", reward:"300 Fay幣" },
      { title:"5 熔岩洞穴", subtitle:"火焰挑戰", desc:"完成10次 PK 小遊戲(截圖給我看)", reward:"300 Fay幣" },
      { title:"6 冰雪山谷", subtitle:"寒冷極地", desc:"兌換 5 次 Fay 幣獎勵", reward:"300 Fay幣" },
      { title:"7 巨龍巢穴", subtitle:"最終挑戰", desc:"提供我 5 個官網改進意見", reward:"300 Fay幣" },
      { title:"8 天空之城", subtitle:"雲端宮殿", desc:"在聊天室打出「FayWooooo最強！」", reward:"300 Fay幣" },
      { title:"9 聖光殿堂", subtitle:"光之試煉", desc:"開啟3個普通寶箱", reward:"300 Fay幣" },
      { title:"10 最終寶藏", subtitle:"榮耀加冕", desc:"開啟3個高級寶箱", reward:"1000 Fay幣 + 高級寶箱" },
    ];

    // 畫地圖
    function renderMap() {
      map.innerHTML = '';
      steps.forEach((step, i) => {
        const cell = document.createElement('div');
        cell.className = 'cell' + (i === progress ? ' active' : '');
        cell.innerHTML = `
          <h3>${step.title}</h3>
          <h4>${step.subtitle}</h4>
          <p>${step.desc}</p>
          <span>${step.reward}</span>
        `;
        map.appendChild(cell);
      }); 
    }

    // 即時監聽使用者資料（coins + progress）
    function listenUserData() {
      if (!userEmail) return;
      db.collection('userLoginRewards')
        .where('userEmail','==',userEmail)
        .onSnapshot(snapshot => {
          if (!snapshot.empty) {
            const data = snapshot.docs[0].data();
            coins = data.coins || 0;
            progress = data.treasureProgress || 0;
            balanceEl.textContent = coins;
            renderMap();

            // 顯示即時獎勵訊息
            if (progress < steps.length) {
              messageEl.textContent = `你已到達：${steps[progress].title}，獲得 ${steps[progress].reward}`;
            }
          }
        });
    }

    // 發放獎勵（進度改變時）
    async function grantReward(docId, stepIndex) {
      let rewardValue = 0;
      const match = steps[stepIndex].reward.match(/(\d+)\s*Fay幣/);
      if (match) rewardValue = parseInt(match[1]);

      let update = { coins: firebase.firestore.FieldValue.increment(rewardValue) };

      // 如果是最終寶藏，額外+1000 Fay幣 + 1 寶箱
      if (stepIndex === steps.length - 1) {
        update.coins = firebase.firestore.FieldValue.increment(rewardValue + 1000);
        update.chests = firebase.firestore.FieldValue.increment(1);
      }

      await db.collection('userLoginRewards').doc(docId).update(update);
    }

    // 管理員操作
    async function applyAdminAction() {
      const email = document.getElementById('user-email-input').value.trim().toLowerCase();
      const action = document.getElementById('action-select').value;
      const value = parseInt(document.getElementById('action-value').value) || 0;

      let query = db.collection('userLoginRewards');
      if (email) query = query.where('userEmail', '==', email);

      const snapshot = await query.get();
      if (snapshot.empty) {
        alert('找不到帳號');
        return;
      }

      snapshot.forEach(async (doc) => {
        const data = doc.data();
        let update = {};

        switch(action) {
          case "addCoins":
            update.coins = (data.coins || 0) + value;
            break;
          case "removeCoins":
            update.coins = Math.max(0, (data.coins || 0) - value);
            break;
          case "resetCoins":
            update.coins = 0;
            break;
          case "addProgress":
            update.treasureProgress = Math.min(maxStep-1, (data.treasureProgress || 0) + value);
            break;
          case "removeProgress":
            update.treasureProgress = Math.max(0, (data.treasureProgress || 0) - value);
            break;
          case "resetProgress":
            update.treasureProgress = 0;
            break;
        }

        await db.collection('userLoginRewards').doc(doc.id).update(update);

        // 自動發放獎勵
        if (update.treasureProgress !== undefined) {
          await grantReward(doc.id, update.treasureProgress);
        }
      });

      alert("✅ 操作完成");
    }

    // 啟動
    window.addEventListener("load", () => {
      const email = localStorage.getItem('userEmail');
      // 👉 如果沒登入，直接跳回首頁
    if (!email) {
      window.location.href = "index.html";
      return;
    }
      const adminEmails = ["faywooooo@gmail.com", "faywooooobs@gmail.com"];
      if (adminEmails.includes(email)) {
        document.getElementById('admin-panel').style.display = 'block';
      }
      listenUserData(); // 即時監聽
    });
  </script>
  
</body>
</html>
