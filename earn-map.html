<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä»»å‹™åœ°åœ– - FayWooooo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="logo.ico" type="image/x-icon">
  <!-- âœ… SEO åŸºç¤ -->
  <meta name="description" content="FayWooooo å®˜æ–¹ä»»å‹™åœ°åœ–ï¼Œå®ŒæˆæŒ‘æˆ°ç²å¾— Fay å¹£èˆ‡å¯¶ç®±ï¼Œåƒèˆ‡å†’éšªè§£é–çå‹µï¼">
  <meta name="keywords" content="FayWooooo, Fayå¹£, ä»»å‹™åœ°åœ–, å¯¶ç®±, éŠæˆ², æŒ‘æˆ°, çå‹µç³»çµ±">
  <meta name="author" content="FayWooooo Team">
  <style>
        @font-face {
    font-family: 'hanwangheiheavy';
    src: url('https://www.moedict.tw/fonts/truetype/wang/wt014.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
  }
    body {
      background: linear-gradient(to bottom, #001f3f, #000);
      color: white;
      font-family: 'hanwangheiheavy';
      text-align: center;
      padding: 20px;
    }
    h1 { color: gold; }

    .map {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-gap: 15px;
      column-gap: 20px;
      margin: 20px auto;
      max-width: 1200px;
    }
    .cell {
      width: 200px;
      height: 160px;
      border: 3px solid gold;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 10px;
      background: rgb(161, 205, 255);
      text-align: left;
      font-size: 13px;
      position: relative;
    }
    .cell h3 { margin: 0; font-size: 22px; color: black; font-weight: normal;}
    .cell h4 { margin: 0; font-size: 18px; color: black; font-weight: normal}
    .cell p { margin: 2px 0; font-size: 14px; color: black; font-weight: normal}
    .cell span { font-size: 16px; font-weight: bold; color: rgb(255,230,0); background:black; text-align:center; display:block; padding:5px; }

    .cell.active {
      background: rgb(104, 255, 139);
      color: black;
      font-weight: bold;
    }
    .cell.active h3{
      font-weight: bold;
    }
    .cell.active h4{
      font-weight: bold;
    }
    .cell.active p{
      font-weight: bold;
    }
    .btn {
      background: gold;
      color: black;
      border: none;
      padding: 12px 25px;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 20px;
      font-size: 16px;
      font-weight: bold;
    }
    .btn:disabled {
      background: gray;
      cursor: not-allowed;
    }
    .admin-panel {
      background: rgba(255, 0, 0, 0.1);
      border: 2px solid #ff4444;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .admin-title {
      color: #ff6666;
      font-size: 20px;
      margin-bottom: 10px;
      font-weight: bold;
    }
    .admin-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .admin-input, .admin-select {
      padding: 8px 12px;
      border-radius: 5px;
      border: none;
      font-size: 14px;
    }
    .admin-button {
      background: linear-gradient(45deg, #ff4444, #ff6666);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ä»»å‹™åœ°åœ–</h1>
  <p>ç›®å‰ Fayå¹£ï¼š<span id="coin-balance">0</span></p>
  <div class="map" id="map"></div>

  <div id="admin-panel" class="admin-panel" style="display:none;">
    <div class="admin-title">å®˜æ–¹ç®¡ç†é¢æ¿</div>
    <div class="admin-controls">
      <input type="text" id="user-email-input" class="admin-input" placeholder="(ç•™ç©º=æ‰€æœ‰å¸³è™Ÿ)" />
      <select id="action-select" class="admin-select">
        <option value="addCoins">å¢åŠ  Fayå¹£</option>
        <option value="removeCoins">æ¸›å°‘ Fayå¹£</option>
        <option value="resetCoins">Fayå¹£æ­¸é›¶</option>
        <option value="addProgress">å¢åŠ é€²åº¦</option>
        <option value="removeProgress">æ¸›å°‘é€²åº¦</option>
        <option value="resetProgress">é€²åº¦æ­¸é›¶</option>
      </select>
      <input type="number" id="action-value" class="admin-input" placeholder="è¼¸å…¥æ•¸å€¼ (å¯ç•™ç©º)" />
      <button onclick="applyAdminAction()" class="admin-button">åŸ·è¡Œ</button>
    </div>
    <div class="admin-info">âš ï¸ æ­¤åŠŸèƒ½åƒ…é™å®˜æ–¹å¸³è™Ÿä½¿ç”¨</div>
  </div>

  <p id="message"></p>
  <button class="btn" onclick="window.location.href='index.html'">å›é¦–é </button>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAw3NxfRft4pke6TUl9gQ4a8P0LEm30zWo",
      authDomain: "faycoin-bb878.firebaseapp.com",
      projectId: "faycoin-bb878",
      storageBucket: "faycoin-bb878.appspot.com",
      messagingSenderId: "665116400856",
      appId: "1:665116400856:web:a263d792c69129400d8bad",
      measurementId: "G-ZSZZD4W1HX"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const userEmail = localStorage.getItem('userEmail');
    let coins = 0;
    let progress = 0;
    const maxStep = 10;

    const map = document.getElementById('map');
    const balanceEl = document.getElementById('coin-balance');
    const messageEl = document.getElementById('message');

    // æ¯æ ¼å…§å®¹
    const steps = [
      { title:"1 èµ·é»", subtitle:"å†’éšªé–‹å§‹", desc:"æº–å‚™å¥½å‡ºç™¼å§ï¼", reward:"10 Fayå¹£" },
      { title:"2 æ£®æ—å°å¾‘", subtitle:"å±éšªå¢æ—", desc:"æ¨è–¦å®˜ç¶²çµ¦ 5 ä½å¥½å‹", reward:"300 Fayå¹£" },
      { title:"3 ç¥ç§˜æ¹–æ³Š", subtitle:"æ°´ä¹‹è©¦ç…‰", desc:"æˆåŠŸè®“10å€‹æœ‹å‹è¨‚é–±æˆ‘", reward:"300 Fayå¹£" },
      { title:"4 å¤ä»£éºè·¡", subtitle:"æ–‡æ˜éºè·¡", desc:"åˆ†äº«ä»»å‹™å®Œæˆæˆªåœ–çµ¦5å€‹æœ‹å‹", reward:"300 Fayå¹£" },
      { title:"5 ç†”å²©æ´ç©´", subtitle:"ç«ç„°æŒ‘æˆ°", desc:"å®Œæˆ10æ¬¡ PK å°éŠæˆ²(æˆªåœ–çµ¦æˆ‘çœ‹)", reward:"300 Fayå¹£" },
      { title:"6 å†°é›ªå±±è°·", subtitle:"å¯’å†·æ¥µåœ°", desc:"å…Œæ› 5 æ¬¡ Fay å¹£çå‹µ", reward:"300 Fayå¹£" },
      { title:"7 å·¨é¾å·¢ç©´", subtitle:"æœ€çµ‚æŒ‘æˆ°", desc:"æä¾›æˆ‘ 5 å€‹å®˜ç¶²æ”¹é€²æ„è¦‹", reward:"300 Fayå¹£" },
      { title:"8 å¤©ç©ºä¹‹åŸ", subtitle:"é›²ç«¯å®®æ®¿", desc:"åœ¨èŠå¤©å®¤æ‰“å‡ºã€ŒFayWoooooæœ€å¼·ï¼ã€", reward:"300 Fayå¹£" },
      { title:"9 è–å…‰æ®¿å ‚", subtitle:"å…‰ä¹‹è©¦ç…‰", desc:"é–‹å•Ÿ3å€‹æ™®é€šå¯¶ç®±", reward:"300 Fayå¹£" },
      { title:"10 æœ€çµ‚å¯¶è—", subtitle:"æ¦®è€€åŠ å†•", desc:"é–‹å•Ÿ3å€‹é«˜ç´šå¯¶ç®±", reward:"1000 Fayå¹£ + é«˜ç´šå¯¶ç®±" },
    ];

    // ç•«åœ°åœ–
    function renderMap() {
      map.innerHTML = '';
      steps.forEach((step, i) => {
        const cell = document.createElement('div');
        cell.className = 'cell' + (i === progress ? ' active' : '');
        cell.innerHTML = `
          <h3>${step.title}</h3>
          <h4>${step.subtitle}</h4>
          <p>${step.desc}</p>
          <span>${step.reward}</span>
        `;
        map.appendChild(cell);
      }); 
    }

    // å³æ™‚ç›£è½ä½¿ç”¨è€…è³‡æ–™ï¼ˆcoins + progressï¼‰
    function listenUserData() {
      if (!userEmail) return;
      db.collection('userLoginRewards')
        .where('userEmail','==',userEmail)
        .onSnapshot(snapshot => {
          if (!snapshot.empty) {
            const data = snapshot.docs[0].data();
            coins = data.coins || 0;
            progress = data.treasureProgress || 0;
            balanceEl.textContent = coins;
            renderMap();

            // é¡¯ç¤ºå³æ™‚çå‹µè¨Šæ¯
            if (progress < steps.length) {
              messageEl.textContent = `ä½ å·²åˆ°é”ï¼š${steps[progress].title}ï¼Œç²å¾— ${steps[progress].reward}`;
            }
          }
        });
    }

    // ç™¼æ”¾çå‹µï¼ˆé€²åº¦æ”¹è®Šæ™‚ï¼‰
    async function grantReward(docId, stepIndex) {
      let rewardValue = 0;
      const match = steps[stepIndex].reward.match(/(\d+)\s*Fayå¹£/);
      if (match) rewardValue = parseInt(match[1]);

      let update = { coins: firebase.firestore.FieldValue.increment(rewardValue) };

      // å¦‚æœæ˜¯æœ€çµ‚å¯¶è—ï¼Œé¡å¤–+1000 Fayå¹£ + 1 å¯¶ç®±
      if (stepIndex === steps.length - 1) {
        update.coins = firebase.firestore.FieldValue.increment(rewardValue + 1000);
        update.chests = firebase.firestore.FieldValue.increment(1);
      }

      await db.collection('userLoginRewards').doc(docId).update(update);
    }

    // ç®¡ç†å“¡æ“ä½œ
    async function applyAdminAction() {
      const email = document.getElementById('user-email-input').value.trim().toLowerCase();
      const action = document.getElementById('action-select').value;
      const value = parseInt(document.getElementById('action-value').value) || 0;

      let query = db.collection('userLoginRewards');
      if (email) query = query.where('userEmail', '==', email);

      const snapshot = await query.get();
      if (snapshot.empty) {
        alert('æ‰¾ä¸åˆ°å¸³è™Ÿ');
        return;
      }

      snapshot.forEach(async (doc) => {
        const data = doc.data();
        let update = {};

        switch(action) {
          case "addCoins":
            update.coins = (data.coins || 0) + value;
            break;
          case "removeCoins":
            update.coins = Math.max(0, (data.coins || 0) - value);
            break;
          case "resetCoins":
            update.coins = 0;
            break;
          case "addProgress":
            update.treasureProgress = Math.min(maxStep-1, (data.treasureProgress || 0) + value);
            break;
          case "removeProgress":
            update.treasureProgress = Math.max(0, (data.treasureProgress || 0) - value);
            break;
          case "resetProgress":
            update.treasureProgress = 0;
            break;
        }

        await db.collection('userLoginRewards').doc(doc.id).update(update);

        // è‡ªå‹•ç™¼æ”¾çå‹µ
        if (update.treasureProgress !== undefined) {
          await grantReward(doc.id, update.treasureProgress);
        }
      });

      alert("âœ… æ“ä½œå®Œæˆ");
    }

    // å•Ÿå‹•
    window.addEventListener("load", () => {
      const email = localStorage.getItem('userEmail');
      // ğŸ‘‰ å¦‚æœæ²’ç™»å…¥ï¼Œç›´æ¥è·³å›é¦–é 
    if (!email) {
      window.location.href = "index.html";
      return;
    }
      const adminEmails = ["faywooooo@gmail.com", "faywooooobs@gmail.com"];
      if (adminEmails.includes(email)) {
        document.getElementById('admin-panel').style.display = 'block';
      }
      listenUserData(); // å³æ™‚ç›£è½
    });
  </script>
  
</body>
</html>
