<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>打怪遊戲 - FayWooooo</title>
<style>
  body {
    background:#111;
    color:white;
    font-family:sans-serif;
    margin:0;
    overflow:hidden;
    display:flex;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    text-align:center;
  }
  #container {
    width:90%;       /* 左右各留5% */
    max-width:1200px; /* 大螢幕不會太寬 */
    margin:0 auto;
    text-align:center;
  }
  h1 { font-size:5vw; margin:2vh 0; color:gold; }
  #info { font-size:3vw; margin:1vh 0; }
  #guide { font-size:2.5vw; color:#ccc; margin:2vh 0; }
  #startBtn {
    padding:2vh 4vw;
    font-size:3vw;
    cursor:pointer;
    border-radius:10px;
    margin:2vh 0;
  }
  #gameCanvas {
    display:none;
    width:100%;
    height:auto;
    aspect-ratio:16/9;
    border:2px solid gold;
    margin:2vh auto;
  }
  /* 手機搖桿 + 按鈕 */
  #joystick {
    position:fixed; bottom:12vh; left:8vw;
    width:18vw; height:18vw;
    background:rgba(200,200,200,0.2);
    border-radius:50%;
    touch-action:none;
    display:none;
  }
  #stick {
    position:absolute; top:35%; left:35%;
    width:30%; height:30%;
    background:rgba(255,255,255,0.6);
    border-radius:50%;
  }
  #buttons {
    position:fixed; bottom:10vh; right:8vw;
    display:none;
  }
  .btn {
    width:15vw; height:15vw; border-radius:50%;
    background:rgba(255,255,255,0.6);
    margin:3vw;
    font-size:5vw;
    font-weight:bold;
    touch-action:none;
  }
  #endScreen {
    display:none;
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.8);
    color:white;
    font-size:8vw;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    z-index:100;
    text-align:center;
  }
  @media (min-width:768px) {
    h1 { font-size:32px; }
    #info { font-size:18px; }
    #guide { font-size:16px; }
    #startBtn { font-size:18px; }
  }
  @media (min-width: 1024px) {
  #gameCanvas {
    max-width: 800px;   /* 電腦版最大寬度 */
    height: auto;
    margin: 20px auto;
    display: block;
  }
}

</style>


</head>
<body>
  <h1 style="color:gold;">打怪遊戲</h1>
  <div id="info">
    血量：<span id="hp">100</span> | Fay幣：<span id="coins">0</span> | 子彈：<span id="ammo">3</span>/3 | 大招能量：<span id="ult">0</span>/6
  </div>
  <button id="startBtn">開始遊戲</button>
  <div id="guide">
    操作方式：WASD移動｜空白鍵射擊｜B鍵大招<br>
    規則：擊敗敵人即可獲勝，每日最多5場
  </div>
  <canvas id="gameCanvas" width="600" height="400" style="display:none;"></canvas>
  <div id="joystick"><div id="stick"></div></div>
  <div id="buttons">
    <button id="attackBtn" class="btn">普攻</button>
    <button id="ultBtn" class="btn">大招</button>
  </div>
  <div id="endScreen"><div id="resultText"></div></div>
  <a href="index.html"><button style="background-color: white;width: 100px;height: 50px;border-radius: 10px;cursor: pointer;">回首頁</button></a>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
  // 登入檢查
  if (localStorage.getItem('isLoggedIn') !== 'true') {
    alert('⚠️ 請先登入才能遊玩');
    window.location.href='index.html';
  }

  // === 一天最多 5 場 ===
  const todayKey = "playCount_" + new Date().toISOString().slice(0,10);
  let playCount = parseInt(localStorage.getItem(todayKey) || "0");
  if(playCount>=5){
    document.getElementById("startBtn").disabled=true;
    document.getElementById("startBtn").innerText="今天已達 5 場上限";
  }

  // Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAw3NxfRft4pke6TUl9gQ4a8P0LEm30zWo",
    authDomain: "faycoin-bb878.firebaseapp.com",
    projectId: "faycoin-bb878"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const email = localStorage.getItem("userEmail") || "";
  let coins=0;

  async function loadBalance(){
    if(!email) return 0;
    const snap = await db.collection("userLoginRewards").where("userEmail","==",email).get();
    if(!snap.empty) coins=snap.docs[0].data().coins||0;
    document.getElementById("coins").textContent=coins;
    return coins;
  }
  async function saveBalance(value){
    if(!email) return;
    const snap = await db.collection("userLoginRewards").where("userEmail","==",email).get();
    if(!snap.empty) await db.collection("userLoginRewards").doc(snap.docs[0].id).update({ coins:value });
    coins=value;
    document.getElementById("coins").textContent=coins;
  }

  // === 遊戲物件 ===
  const canvas=document.getElementById("gameCanvas"), ctx=canvas.getContext("2d");
  const imgPlayer=new Image(); imgPlayer.src="img/player.png";
  const imgEnemy=new Image(); imgEnemy.src="img/enemy.png";
  const imgBullet=new Image(); imgBullet.src="img/bullet.png";

  let player={x:300,y:200,hp:100,maxHp:100,lastShot:0};
  let enemy={x:100,y:100,hp:120,maxHp:120,lastAttack:0};
  let bullets=[], enemyBullets=[], explosions=[];
  let ammo=3, maxAmmo=3, reloadTime=600;
  let hitCount=0; // 蓄大招計數
  let gameOver=false;

  // 子彈回復
  setInterval(()=>{ if(ammo<maxAmmo){ ammo++; updateUI(); } }, reloadTime);

  function updateUI(){
    document.getElementById("ammo").textContent=ammo;
    document.getElementById("hp").textContent=Math.max(0,player.hp.toFixed(0));
    document.getElementById("ult").textContent=hitCount;
  }

  let keys={};
  document.addEventListener("keydown",e=>keys[e.key]=true);
  document.addEventListener("keyup",e=>keys[e.key]=false);

  // === 手機搖桿 ===
  let joy=document.getElementById("joystick"), stick=document.getElementById("stick");
  let joyX=0, joyY=0;
  joy.addEventListener("touchstart",e=>{});
  joy.addEventListener("touchmove",e=>{
    let rect=joy.getBoundingClientRect();
    let touch=e.touches[0];
    let dx=touch.clientX-(rect.left+rect.width/2);
    let dy=touch.clientY-(rect.top+rect.height/2);
    let dist=Math.min(40,Math.hypot(dx,dy));
    let angle=Math.atan2(dy,dx);
    joyX=Math.cos(angle)*dist/40;
    joyY=Math.sin(angle)*dist/40;
    stick.style.left=35+joyX*40+"px";
    stick.style.top=35+joyY*40+"px";
  });
  joy.addEventListener("touchend",()=>{
    joyX=joyY=0;
    stick.style.left="35px"; stick.style.top="35px";
  });

  // 攻擊/大招按鈕
  document.getElementById("attackBtn").addEventListener("touchstart",()=>keys["mobile_attack"]=true);
  document.getElementById("attackBtn").addEventListener("touchend",()=>keys["mobile_attack"]=false);
  document.getElementById("ultBtn").addEventListener("touchstart",()=>keys["mobile_ult"]=true);
  document.getElementById("ultBtn").addEventListener("touchend",()=>keys["mobile_ult"]=false);

  function moveTo(obj,target,speed){
    let dx=target.x-obj.x, dy=target.y-obj.y, d=Math.hypot(dx,dy);
    if(d>0){ obj.x+=dx/d*speed; obj.y+=dy/d*speed; }
  }
  function dist(a,b){ return Math.hypot(a.x-b.x,a.y-b.y); }

  function drawHpBar(obj){
    let barW=40,barH=5,hpRatio=obj.hp/obj.maxHp;
    ctx.fillStyle="red"; ctx.fillRect(obj.x-20,obj.y-30,barW,barH);
    ctx.fillStyle="lime"; ctx.fillRect(obj.x-20,obj.y-30,barW*hpRatio,barH);
  }

  function update(){
    let now=Date.now();

    // 玩家移動 (鍵盤 + 搖桿)
    if(keys["w"]||joyY<-0.3) player.y-=2;
    if(keys["s"]||joyY>0.3)  player.y+=2;
    if(keys["a"]||joyX<-0.3) player.x-=2;
    if(keys["d"]||joyX>0.3)  player.x+=2;

    // 玩家射擊
    if((keys[" "]||keys["mobile_attack"]) && ammo>0 && now-player.lastShot>250){
      let dx=(enemy.x-player.x), dy=(enemy.y-player.y), d=Math.hypot(dx,dy);
      bullets.push({x:player.x,y:player.y,dx:dx/d,dy:dy/d});
      ammo--; player.lastShot=now; updateUI();
    }

    // 玩家大招
    if((keys["b"]||keys["mobile_ult"]) && hitCount>=6){
      hitCount=0; updateUI();
      for(let i=0;i<6;i++){
        setTimeout(()=>{
          let dx=(enemy.x-player.x), dy=(enemy.y-player.y)+(i-3)*20, d=Math.hypot(dx,dy);
          bullets.push({x:player.x,y:player.y,dx:dx/d,dy:dy/d});
        }, i*50);
      }
    }

    // 子彈移動
    bullets.forEach(b=>{
      b.x+=b.dx*7; b.y+=b.dy*7;
      if(dist(b,enemy)<20){ enemy.hp-=5; b.dead=true; hitCount=Math.min(6,hitCount+1); updateUI(); }
    });
    bullets=bullets.filter(b=>!b.dead);

    // 敵人行為：靠近 + 子彈攻擊
    moveTo(enemy,player,1);
    if(now-enemy.lastAttack>1500){
      let dx=(player.x-enemy.x), dy=(player.y-enemy.y), d=Math.hypot(dx,dy);
      enemyBullets.push({x:enemy.x,y:enemy.y,dx:dx/d,dy:dy/d});
      enemy.lastAttack=now;
    }
    enemyBullets.forEach(b=>{
      b.x+=b.dx*5; b.y+=b.dy*5;
      if(dist(b,player)<20){ player.hp-=2; b.dead=true; }
    });
    enemyBullets=enemyBullets.filter(b=>!b.dead);

    // 勝負判定
    if(enemy.hp<=0){ win(); return false; }
    if(player.hp<=0){ lose(); return false; }
    return true;
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(imgPlayer,player.x-16,player.y-16,32,32);
    drawHpBar(player); ctx.fillStyle="white"; ctx.fillText("玩家",player.x-15,player.y-40);
    ctx.drawImage(imgEnemy,enemy.x-16,enemy.y-16,32,32);
    drawHpBar(enemy); ctx.fillStyle="red"; ctx.fillText("敵人",enemy.x-15,enemy.y-40);
    bullets.forEach(b=>ctx.drawImage(imgBullet,b.x-4,b.y-4,8,8));
    enemyBullets.forEach(b=>ctx.fillRect(b.x-2,b.y-2,6,6));
  }

  async function win(){
    gameOver=true;
    document.getElementById("endScreen").style.display="flex";
    document.getElementById("resultText").textContent="🎉 勝利！";
    await saveBalance(coins+50);
  }
  function lose(){
    gameOver=true;
    document.getElementById("endScreen").style.display="flex";
    document.getElementById("resultText").textContent="💀 失敗！";
  }

  async function gameLoop(){
    if(update()){ draw(); if(!gameOver) requestAnimationFrame(gameLoop); }
    else draw();
  }

// === 開始遊戲 ===
document.getElementById("startBtn").onclick=()=>{
  if(playCount>=5){ 
    alert("今天已達 5 場上限"); 
    return; 
  }
  playCount++; 
  localStorage.setItem(todayKey,playCount);
  document.getElementById("startBtn").style.display="none";
  document.getElementById("guide").style.display="none";
  canvas.style.display="block";

  // ✅ 判斷是否為觸控裝置 (手機/平板)
  const isTouchDevice = "ontouchstart" in window || navigator.maxTouchPoints > 0;

  if(isTouchDevice){
    document.getElementById("joystick").style.display="block";
    document.getElementById("buttons").style.display="block";
  } else {
    // 電腦 → 確保隱藏
    document.getElementById("joystick").style.display="none";
    document.getElementById("buttons").style.display="none";
  }

  loadBalance().then(()=>gameLoop());
}
alert(isTouchDevice ? "📱 手機/平板模式" : "💻 電腦模式");


  </script>
</body>
</html>

