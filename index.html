<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>FayWooooo - 官方網站</title>
  <link rel="icon" href="logo.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="faycoin-sync.js" type="module"></script>

  <!-- 字體 & 圖示 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAw3NxfRft4pke6TUl9gQ4a8P0LEm30zWo",
    authDomain: "faycoin-bb878.firebaseapp.com",
    projectId: "faycoin-bb878",
    storageBucket: "faycoin-bb878.appspot.com",
    messagingSenderId: "665116400856",
    appId: "1:665116400856:web:a263d792c69129400d8bad",
    measurementId: "G-ZSZZD4W1HX"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>


  <style>
    body {
      background-image: linear-gradient(rgb(8, 19, 41), rgb(0, 0, 0));
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      margin-left: 15%;
      margin-right: 15%;
      font-family: 'Roboto', sans-serif;
      min-height: 100vh;
    }
    @media (max-width: 768px) {
      body{
        margin-left: 5%;
        margin-right: 5%;
      }
    }

    .pro-banner {
      background-color: gold;
      color: black;
      text-align: center;
      padding: 10px;
      font-size: 24px;
      font-weight: normal;
      font-family: "hanwangheiheavy";
    }

    nav {
      border-radius: 30px;
      padding: 3px;
      background: rgba(255, 255, 255, 0.07);
      backdrop-filter: blur(15px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
      display: flex;
      margin-top: 20px;
      width: 100%;
    }

    ul {
      display: flex;
      list-style: none;
    }

    li {
      display: flex;
      margin-left: 25px;
    }

    .nav_h2 {
      color: white;
      font-size: 35px;
      display: flex;
      margin-top: 15px;
      margin-bottom: 0;
      font-family: "hanwangheiheavy";
      font-weight: normal;
    }

    h1 {
      color: white;
      font-size: 40px;
      font-family: "hanwangheiheavy";
      font-weight: normal;
      text-align: center;
    }

    .wrapper {
      position: relative;
      font-size: 45px;
      font-family: "hanwangheiheavy";
      color: white;
      width: 30ch;
      height: 1.4em;
      margin-top: 50px;
    }
    .bottom-nav {
      position: fixed;
      bottom: 15px;
      width: 70%;
      height: 70px;
      border-radius: 20px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: rgba(255, 255, 255, 0.07);
      backdrop-filter: blur(15px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
      pointer-events: auto;
      z-index: 999;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #888;
      font-size: 13px;
      text-decoration: none;
      width: 80px;
      font-family: 'hanwangheiheavy', sans-serif;
    }

    .nav-item i {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .nav-item.active {
      color: white;
      font-size: 25px;
    }

    .channel-intro {
      background-color: white;
      border-radius: 20px;
      border: 5px solid rgb(100, 37, 0);
      width: 298px;
      padding: 15px;
      box-sizing: border-box;
      font-family: 'hanwangheiheavy', sans-serif;
    }

    .intro-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 20px;
    }

    .user-dropdown {
      position: relative;
      cursor: pointer;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid white;
    }

    .dropdown-menu {
      position: absolute;
      bottom: 55px;
      right: 0;
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid white;
      border-radius: 10px;
      padding: 0;
      display: none;
      font-size: 20px;
      color: white;
      z-index: 999;
      min-width: 180px;
      align-items: center;
      text-align: center;
      padding: 10px;
      gap: 8px;
    }

    .dropdown-menu a {
      color: white;
      text-decoration: none;
      margin-top: 5px;
    }

    #claim-btn {
      background-color: gold;
      border: none;
      padding: 5px 15px;
      border-radius: 10px;
      font-weight: normal;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    .dropdown-menu {
  display: flex;
  flex-direction: column;
  background: rgba(0, 0, 0, 0.85);
  border: 1px solid white;
  border-radius: 10px;
  padding: 10px 15px;
  gap: 8px;
  font-size: 20px;
  color: white;
  min-width: 200px;
  max-width: 90vw;
  z-index: 999;
  text-align: center;
}

.dropdown-item {
  color: white;
  font-family: 'hanwangheiheavy', sans-serif;
  font-size: 20px;
  padding: 5px 10px;
  text-decoration: none;
  border-radius: 5px;
  background: rgba(255, 255, 255, 0.05);
}

.dropdown-item:hover {
  background: rgba(255, 255, 255, 0.2);
}

.dropdown-menu a.dropdown-item {
  display: block;
}
.dropdown-menu {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  background: rgba(0, 0, 0, 0.85);
  border: 1px solid white;
  border-radius: 10px;
  padding: 10px;
  gap: 10px;
  font-size: 20px;
  color: white;
  text-align: center;
  width: auto;
  min-width: 200px;
  max-width: 90vw;
}

.dropdown-item {
  color: white;
  font-family: 'hanwangheiheavy', sans-serif;
  font-size: 20px;
  font-weight: normal;
  text-decoration: none;
  background: none;      /* ✅ 拿掉背景 */
  border: none;          /* ✅ 拿掉邊框 */
  padding: 0;            /* ✅ 拿掉間距 */
  margin: 0;
}

.dropdown-item:hover {
  text-decoration: underline; /* 可選：滑過時底線效果 */
  background: none;
}

.dropdown-menu a.dropdown-item {
  display: inline-block;
}

.email-text {
  font-size: 16px;
  color: rgb(255, 255, 255);
  padding: 0;
}

    .pro-banner {
      background-color: gold;
      color: black;
      text-align: center;
      padding: 10px;
      font-size: 20px;
      font-family: "hanwangheiheavy";
      border-radius: 30px;
    }

    .show {
      display: flex !important;
    }

    .pro-banner button#claim-btn {
      margin-top: 10px;
      padding: 8px 20px;
      font-size: 16px;
      font-weight: bold;
      background-color: gold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    .video{
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    /* 公佈欄樣式 */
    .announcement-section {
      margin: 35px 0;
    }

    .announcement-container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .announcement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .announcement-title {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #FFD700;
      font-size: 24px;
      font-family: "hanwangheiheavy";
      margin: 0;
    }

    .refresh-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-refresh {
      background: linear-gradient(45deg, #4285f4, #1a73e8);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
      font-family: 'hanwangheiheavy', sans-serif;
    }

    .btn-refresh:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
    }

    .btn-refresh:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .announcement-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      overflow: hidden;
    }

    .announcement-table th {
      background: linear-gradient(135deg, #94fbff, #6afff3);
      color: #000;
      padding: 12px 8px;
      text-align: left;
      font-weight: normal;
      font-family: 'hanwangheiheavy', sans-serif;
    }

    .announcement-table td {
      padding: 10px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      vertical-align: top;
    }

    .announcement-table tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .no-announcements {
      text-align: center;
      color: rgba(255, 255, 255, 0.6);
      padding: 30px;
      font-style: italic;
    }

    .loading-status {
      text-align: center;
      color: rgba(255, 255, 255, 0.8);
      padding: 20px;
      font-style: italic;
    }

    .error-status {
      text-align: center;
      color: #ff4757;
      padding: 20px;
      font-style: italic;
    }

    .status-message {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      display: none;
    }
    .last-updated {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
      text-align: right;
      margin-top: 10px;
    }

    @media (max-width:768px){
      .bottom-nav {
        left: 5%;
        right: 5%;
        width: 90%;
      }
      
      .announcement-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .announcement-title {
        font-size: 20px;
        justify-content: center;
      }
      
      .refresh-controls {
        justify-content: center;
      }
      
      .announcement-table {
        font-size: 11px;
      }
      
      .announcement-table th,
      .announcement-table td {
        padding: 8px 4px;
      }
      
      .video iframe {
        width: 90%;
        height: calc(90vw * 9 / 16);
        max-width: none;
      }
    }

    @media (max-width: 768px) {
      .bottom-nav {
        left: 5%;
        right: 5%;
        width: 90%;
      }
      
      .video iframe {
        width: 90%;
        height: calc(90vw * 9 / 16);
        max-width: none;
      }
    }
    .video iframe{
      border-radius: 30px;
      border: solid white 3px;
    }
    
.email-text {
  font-size: 16px;
  color: rgb(255, 255, 255);
  background: none;
  padding: 0;
  margin: 0;
}
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
}

.loader {
  width: 80px;
  height: 80px;
  position: relative;
}

.loader span {
  width: 16px;
  height: 16px;
  background: gold;
  border-radius: 50%;
  position: absolute;
  animation: pulse 1s infinite ease-in-out;
}

.loader span:nth-child(1) { top: 0; left: 50%; transform: translate(-50%, -50%); animation-delay: 0s;}
.loader span:nth-child(2) { right: 0; top: 50%; transform: translate(50%, -50%); animation-delay: 0.2s;}
.loader span:nth-child(3) { bottom: 0; left: 50%; transform: translate(-50%, 50%); animation-delay: 0.4s;}
.loader span:nth-child(4) { left: 0; top: 50%; transform: translate(-50%, -50%); animation-delay: 0.6s;}

@keyframes pulse {
  0%, 100% { transform: scale(0.8); opacity: 0.6; }
  50% { transform: scale(1.2); opacity: 1; }
}
.dropdown-menu {
  display: none;
  flex-direction: column;
  background: rgba(0, 0, 0, 0.85);
  border: 1px solid white;
  border-radius: 10px;
  padding: 10px 15px;
  gap: 8px;
  font-size: 20px;
  color: white;
  min-width: 200px;
  max-width: 90vw;
  z-index: 999;
  text-align: center;
}

.dropdown-menu.show {
  display: flex !important;
}
.no-scroll {
  overflow: hidden;
  height: 100vh;
}
.site-footer {
  background: rgba(255, 255, 255, 0.07);
  backdrop-filter: blur(12px) saturate(180%);
  border-top: 1px solid rgba(255, 255, 255, 0.15);
  text-align: center;
  padding: 15px;
  color: #fff;
  font-family: 'hanwangheiheavy', sans-serif;
  border-radius: 20px 20px 0 0;
  margin-top: 40px;
  margin-bottom: 15px; /* ✅ 與底部導航間隔 */
  box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.4);
}

.site-footer .footer-content {
  max-width: 900px;
  margin: 0 auto;
}

.site-footer p {
  margin: 5px 0;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.8);
}

.site-footer .footer-links a {
  color: #FFD700;
  text-decoration: none;
  margin: 0 8px;
  font-size: 14px;
}

.site-footer .footer-links a:hover {
  text-decoration: underline;
  color: #fff;
}

@media (max-width: 768px) {
  .site-footer {
    font-size: 13px;
    padding: 10px;
  }
}
.site-footer {
  background: rgba(255, 255, 255, 0.07);
  backdrop-filter: blur(12px) saturate(180%);
  border-top: 1px solid rgba(255, 255, 255, 0.15);
  text-align: center;
  padding: 15px;
  color: #fff;
  font-family: 'hanwangheiheavy', sans-serif;
  border-radius: 20px;
  margin-top: 40px;
  margin-bottom: 90px; /* ✅ 預留 bottom-nav 高度避免被蓋住 */
  box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.4);
}

.site-footer .footer-links a {
  color: #FFD700;
  margin: 0 8px;
  text-decoration: none;
}

.site-footer .footer-links a:hover {
  text-decoration: underline;
  color: #fff;
}
@media (max-width:768px){
  .subscribe-hint{
    display: none;
  }
}
  </style>
</head>
<body>
  <!-- Pro Banner 區 -->
  <div id="pro-banner-container"></div>
  <!-- 會員 Banner 提示專用容器（改 ID 名稱避免撞名） -->
  <div id="membership-banner-container"></div>
  <!-- 進入網頁的模糊效果 -->
  <div id="loading-overlay">
  <div class="loader">
    <span></span><span></span><span></span><span></span>
  </div>
</div>

  <!-- 頂部導覽列 -->
  <nav>
    <ul>
      <li><img src="logo.ico" style="width: 70px;"></li>
      <li><h2 class="nav_h2">FayWooooo 官方網站</h2></li>
    </ul>
  </nav>

  <!-- 內容區 -->
  <div class="main">
    <center><div>
      <h1 class="subscribe-hint" style="font-size: 70px;display:inline-block;">訂閱了沒?</h1>
      <h1 class="subscribe-hint" style="margin-top: -35px;display:inline-block;">趕快訂閱起來!!!</h1>
    </div></center>
    <!-- 公佈欄區域 -->
    <hr style="margin-top:35px"> 
    <h1>📢 最新公告 📢</h1>
    <div class="announcement-section">    
        <div id="statusMessage" class="status-message"></div>
        
        <div style="overflow-x: auto;">
          <table class="announcement-table" id="announcementTable">
            <thead>
              <tr>
                <th width="12%" style="font-size: 18px;font-weight:normal">日期</th>
                <th width="25%" style="font-size: 18px;font-weight:normal">標題</th>
                <th width="63%" style="font-size: 18px;font-weight:normal">內容</th>
              </tr>
            </thead>
            <tbody id="announcementBody" style="font-size: 18px;">
              <tr>
                <td colspan="5" class="loading-status">
                  <i class="fas fa-spinner fa-spin"></i> 
                  正在載入公告資料...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="last-updated" id="lastUpdated"></div>
      </div>
    </div>
    
    <hr style="margin-top:35px">
    <h1 style="text-align: center;">✏ 頻道簡介 ✏</h1>
    <div class="intro-container">
      <div class="channel-intro">
        <p>嗨各位~ 我是FayWooooo，一個小主Bo。<br>類型: 遊戲、搞笑、教學<br>主要拍攝遊戲: 荒野亂鬥</p>
      </div>
      <div class="channel-intro">
        <p>✔️50訂閱✔️200訂閱 ✔️350訂閱 ✔️500訂閱 ✔️700 ✔️850 ✔️1000 ❌1500<br>2025/7/13首部超過10萬觀看短片</p>
      </div>
      <div class="channel-intro">
        <p>荒野亂鬥加好友<br>大帳盃數:兩萬多 ID:YTFayWooooo<br>二帳盃數:一萬多 ID:FayWooooo</p>
        <div style="display: flex">
          <a href="https://link.brawlstars.com/invite/friend/cnt?tag=LG2P80G20&token=ptfnj8az" target="_blank">加大帳好友</a>
          <a href="https://link.brawlstars.com/invite/friend/cnt?tag=JGV8LY02V&token=ptfnj8az" target="_blank" style="margin-left:25px">加二帳好友</a>
        </div>
      </div>
      <div class="channel-intro">
        <p>合作邀約:<br>Email: faywooooo@gmail.com<br>LINE: faywooooo<br>Discord: faywooooo_bs</p>
      </div>
    </div>
    <hr style="margin-top:35px">
    <h1 style="text-align: center;">🎞️ 熱門影片 🎞️</h1>
    <div class="video">
      <iframe width="648" height="387" src="https://www.youtube.com/embed/dAhDO5QcQnE" allowfullscreen></iframe>
      <iframe width="648" height="387" src="https://www.youtube.com/embed/yPMO1tqtMco" allowfullscreen></iframe>
      <iframe width="648" height="387" src="https://www.youtube.com/embed/7rYQqpOXqVs" allowfullscreen></iframe>
      <iframe width="648" height="387" src="https://www.youtube.com/embed/Vbgkd2pcJV4" allowfullscreen></iframe>
    </div>
    <hr style="margin-top:35px">
    <h1 style="text-align: center;">➢ 播放清單 ➢</h1>
    <div class="video">
      <iframe width="648" height="387" src="https://www.youtube.com/embed/videoseries?list=PLesAf0sB4MlEUNTCkvYszJvWl3NIXH3s7" allowfullscreen></iframe>
      <iframe width="648" height="387" src="https://www.youtube.com/embed/videoseries?list=PLesAf0sB4MlHA05zWd4TnvzKm1f4BgVk8" allowfullscreen></iframe>
    </div>
    
  </div>
<!-- Footer 在 bottom-nav 前 -->
<footer class="site-footer">
  <div class="footer-content">
    <p>© 2025 FayWooooo. All Rights Reserved.</p>
    <div class="footer-links">
      <a href="about_us.html">關於我們</a> |
      <a href="https://mail.google.com/mail/?view=cm&fs=1&to=faywooooo@gmail.com&su=提供反饋建議&body=您好，我想對本網站提出建議" target="_blank">聯絡信箱</a> |
      <a href="https://sites.google.com/view/faywooooo-related-platforms" target="_blank">相關平台</a>
    </div>
  </div>
</footer>

<div class="bottom-nav">
  <a style="-webkit-text-stroke: 1.5px black;" href="index.html" class="nav-item active"><i class="fas fa-home"></i>首頁</a>
  <a style="-webkit-text-stroke: 1.5px black;" href="https://sites.google.com/view/faywooooo-related-platforms" target="_blank" class="nav-item active"><i class="fab fa-youtube"></i>相關<br>平台</a>
  <a style="-webkit-text-stroke: 1.5px black;" href="about_us.html" class="nav-item active"><i class="fas fa-store"></i>關於<br>我們</a>
  <a style="-webkit-text-stroke: 1.5px black;" href="https://mail.google.com/mail/?view=cm&fs=1&to=faywooooo@gmail.com&su=文字客服&body=您好，我有問題想問:" class="nav-item active" target="_blank"><i class="fas fa-store"></i>官方<br>客服</a>
  <a style="-webkit-text-stroke: 1.5px black;" href="login.html" class="nav-item active" id="login-item">
    <i class="fab fa-discord"></i>會員<br>登入
  </a>
</div>



  <!-- ✅ JS：登入狀態處理與公佈欄功能 -->
<script>
  // ====== 全域變量 ======
  let currentUserEmail = null;
  let currentUserCoinBalance = 0;

  // ====== Firebase 相關函數 ======
  
  // 從 Firebase 獲取使用者 Fay 幣餘額
  async function getUserCoinsFromFirebase(userEmail) {
    try {
      const snapshot = await db.collection('userLoginRewards')
        .where('userEmail', '==', userEmail)
        .limit(1)
        .get();
        
      if (!snapshot.empty) {
        const doc = snapshot.docs[0];
        return doc.data().coins || 0;
      }
      return 0;
    } catch (error) {
      console.error("❌ 無法取得 Fay 幣餘額", error);
      return 0;
    }
  }

  // 更新 Firebase 中的 Fay 幣餘額
  async function updateUserCoinsInFirebase(userEmail, newBalance) {
    try {
      const snapshot = await db.collection('userLoginRewards')
        .where('userEmail', '==', userEmail)
        .limit(1)
        .get();
        
      if (!snapshot.empty) {
        const doc = snapshot.docs[0];
        await doc.ref.update({ coins: newBalance });
      } else {
        // 如果用戶不存在，創建新記錄
        await db.collection('userLoginRewards').add({
          userEmail: userEmail,
          coins: newBalance,
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      return true;
    } catch (error) {
      console.error("❌ 無法更新 Fay 幣餘額", error);
      return false;
    }
  }

  // 檢查用戶是否已領取入會禮
  async function hasClaimedWelcomeGiftFromFirebase(userEmail) {
    try {
      const snapshot = await db.collection('userLoginRewards')
        .where('userEmail', '==', userEmail)
        .where('hasClaimedWelcome', '==', true)
        .limit(1)
        .get();
      return !snapshot.empty;
    } catch (error) {
      console.error("❌ 無法檢查入會禮狀態", error);
      return false;
    }
  }

  // 標記用戶已領取入會禮
  async function markWelcomeGiftClaimedInFirebase(userEmail) {
    try {
      const snapshot = await db.collection('userLoginRewards')
        .where('userEmail', '==', userEmail)
        .limit(1)
        .get();
        
      if (!snapshot.empty) {
        const doc = snapshot.docs[0];
        await doc.ref.update({ 
          hasClaimedWelcome: true,
          coins: firebase.firestore.FieldValue.increment(100)
        });
      } else {
        await db.collection('userLoginRewards').add({
          userEmail: userEmail,
          coins: 100,
          hasClaimedWelcome: true,
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      return true;
    } catch (error) {
      console.error("❌ 無法標記入會禮", error);
      return false;
    }
  }

  // ====== 登入與會員功能 ======

  function showPreLoginBanner() {
    document.getElementById('pro-banner-container').innerHTML =
      '<div class="pro-banner">🔒 登入會員以獲取 100 Fay幣</div>';
  }

  async function showProBannerWithClaim(userEmail) {
  // ✅ 新增記錄機制：曾經領過就不再查詢
  const claimedCacheKey = `hasClaimedWelcome:${userEmail}`;
  const alreadyKnown = localStorage.getItem(claimedCacheKey) === 'true';
  if (alreadyKnown) {
    document.getElementById('pro-banner-container').innerHTML = '';
    return;
  }

  const hasClaimedGift = await hasClaimedWelcomeGiftFromFirebase(userEmail);
  if (hasClaimedGift) {
    localStorage.setItem(claimedCacheKey, 'true'); // ✅ 記錄起來
    document.getElementById('pro-banner-container').innerHTML = '';
    return;
  }

  document.getElementById('pro-banner-container').innerHTML = `
    <div class="pro-banner">
      ✨ 歡迎加入我們的會員，請點擊按鈕獲取入會禮 ✨<br>
      <button id="claim-btn">點我領取100Fay幣</button>
    </div>`;

  const btn = document.getElementById('claim-btn');
  if (btn) {
    btn.onclick = async function () {
      btn.disabled = true;
      btn.innerText = '領取中...';

      const success = await markWelcomeGiftClaimedInFirebase(userEmail);
      if (success) {
        alert('🎉 恭喜你獲得了 100 Fay幣！');
        currentUserCoinBalance = await getUserCoinsFromFirebase(userEmail);
        localStorage.setItem('fayCoinBalance', currentUserCoinBalance.toString());

        // ✅ 記錄領過
        localStorage.setItem(claimedCacheKey, 'true');

        document.getElementById('pro-banner-container').innerHTML = '';
        updateAllFayCoinDisplays();
      } else {
        alert('❌ 領取失敗，請稍後再試');
        btn.disabled = false;
        btn.innerText = '點我領取100Fay幣'
}}}}

  async function showUserMenu(email) {
    const loginItem = document.getElementById('login-item');
    const name = localStorage.getItem('userName') || '訪客';
    const avatarUrl = localStorage.getItem('userPhotoURL') ||
      `https://www.gravatar.com/avatar/${md5(email.trim().toLowerCase())}?s=40&d=identicon`;

    // 從 Firebase 獲取最新 Fay 幣餘額
    currentUserCoinBalance = await getUserCoinsFromFirebase(email);
    localStorage.setItem('fayCoinBalance', currentUserCoinBalance.toString());

    if (loginItem) {
      loginItem.outerHTML = `
        <div class="nav-item user-dropdown" id="user-dropdown">
          <img src="${avatarUrl}" alt="頭像" class="avatar" id="avatar-img" />
          <div class="dropdown-menu" id="dropdown-menu">
            <div class="dropdown-item"><strong>${name}</strong></div>
            <div class="dropdown-item email-text">${email}</div>
            <a class="dropdown-item" href="exchange.html">
              Fay幣：<span id="coin-count" style="color: gold;">${currentUserCoinBalance}</span><br> ➜ 兌換
            </a>
            <a class="dropdown-item" href="earn.html">任務</a>
            <a class="dropdown-item" href="setting.html">設定</a>
            <a class="dropdown-item" href="#" id="logout-link">登出</a>
          </div>
        </div>`;
    }
    
    setTimeout(() => {
      const avatar = document.getElementById('avatar-img');
      const menu = document.getElementById('dropdown-menu');
      const logoutLink = document.getElementById('logout-link');
      
      if (!avatar || !menu) return;
      
      avatar.addEventListener('click', (e) => {
        e.stopPropagation();
        menu.classList.toggle('show');
      });
      
      document.addEventListener('click', (e) => {
        if (!avatar.contains(e.target) && !menu.contains(e.target)) {
          menu.classList.remove('show');
        }
      });
      
      if (logoutLink) {
        logoutLink.addEventListener('click', (e) => {
          e.preventDefault();
          logout();
        });
      }
    }, 100);
  }

  function updateAllFayCoinDisplays() {
    const coinDisplay = document.getElementById('coin-count');
    if (coinDisplay) {
      coinDisplay.innerText = currentUserCoinBalance;
    }
  }

  function logout() {
    // 清除所有登入狀態
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userName');
    localStorage.removeItem('userPhotoURL');
    localStorage.removeItem('fayCoinBalance');
    localStorage.removeItem('justLoggedIn');
    
    // 重載頁面
    window.location.reload();
  }

  // ====== 公告功能 ======

  const GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/1kX-pQsTBIk-_gdd89oIquIaLIeTlNbvZnQ9KzxVqeEs/gviz/tq?tqx=out:csv';

  let announcements = [];
  let isLoading = false;

  async function loadAnnouncementsFromGoogleSheets() {
    if (isLoading) return;

    isLoading = true;
    const refreshBtn = document.getElementById('refreshBtn');
    const statusMessage = document.getElementById('statusMessage');

    if (refreshBtn) {
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 載入中...';
    }

    try {
      const proxyUrl = 'https://corsproxy.io/?';
      const response = await fetch(proxyUrl + encodeURIComponent(GOOGLE_SHEETS_CSV_URL));
      if (!response.ok) throw new Error('無法載入公告資料');
      const csvText = await response.text();
      announcements = parseCSVToAnnouncements(csvText);
      showStatusMessage('公告資料更新成功！', 'success');
      renderAnnouncements();
      updateLastUpdatedTime();
    } catch (error) {
      console.error('載入公告失敗:', error);
      showStatusMessage('載入公告失敗，請稍後再試', 'error');
      showErrorState();
    } finally {
      isLoading = false;
      if (refreshBtn) {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 重新整理';
      }
    }
  }

  function parseCSVToAnnouncements(csvText) {
    const lines = csvText.split('\n');
    const announcements = [];

    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;
      const columns = parseCSVLine(line);
      if (columns.length >= 3 && columns[0] && columns[1]) {
        announcements.push({
          date: columns[0],
          title: columns[1],
          content: columns[2] || '',
        });
      }
    }

    return announcements;
  }

  function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        result.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }

    result.push(current.trim());
    return result;
  }

  function renderAnnouncements() {
    const tbody = document.getElementById('announcementBody');

    if (announcements.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="no-announcements">
            <i class="fas fa-info-circle"></i> 
            目前沒有公告資料
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = '';
    announcements.forEach(announcement => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${announcement.date}</td>
        <td>${announcement.title}</td>
        <td>${announcement.content}</td>
      `;
      tbody.appendChild(row);
    });
  }

  function showStatusMessage(message, type = 'info') {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.className = `status-message status-${type}`;
    statusDiv.textContent = message;
    statusDiv.style.display = 'block';
    setTimeout(() => {
      statusDiv.style.display = 'none';
    }, 3000);
  }

  function updateLastUpdatedTime() {
    const lastUpdatedDiv = document.getElementById('lastUpdated');
    const now = new Date();
    const timeString = now.toLocaleString('zh-TW', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
    lastUpdatedDiv.textContent = `最後更新：${timeString}`;
  }

  function showErrorState() {
    const tbody = document.getElementById('announcementBody');
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="error-status">
          <i class="fas fa-exclamation-triangle"></i> 
          載入公告失敗，請稍後再試
        </td>
      </tr>
    `;
  }

  // ====== 頁面載入效果 ======

  function disableUserInteraction() {
    document.body.classList.add('no-scroll');
    document.addEventListener('wheel', preventDefault, { passive: false });
    document.addEventListener('touchmove', preventDefault, { passive: false });
    document.addEventListener('keydown', preventKeyScroll, { passive: false });
  }

  function enableUserInteraction() {
    document.body.classList.remove('no-scroll');
    document.removeEventListener('wheel', preventDefault);
    document.removeEventListener('touchmove', preventDefault);
    document.removeEventListener('keydown', preventKeyScroll);
  }

  function preventDefault(e) {
    e.preventDefault();
  }

  function preventKeyScroll(e) {
    if ([32, 37, 38, 39, 40].includes(e.keyCode)) {
      e.preventDefault();
    }
  }

  // ====== 事件監聽器 ======

  // 監聽來自登入頁面的訊息
  // 接收從 earn.html 回傳的獎勵通知
window.addEventListener('message', async function(event) {
  // 可選：檢查來源安全性 if needed
  if (event.data?.type === 'fay-reward-claimed') {
    const { day, amount } = event.data;
    alert(`🎁 已成功領取第 ${day} 天獎勵：${amount} Fay幣`);

    // 重新獲取 Fay 幣並更新畫面
    const email = localStorage.getItem('userEmail');
    if (email) {
      const updated = await getUserCoinsFromFirebase(email);
      currentUserCoinBalance = updated;
      localStorage.setItem('fayCoinBalance', updated.toString());
      updateAllFayCoinDisplays();
    }
  }
});



  // 監聽 Fay幣變化事件
  window.addEventListener('fayCoinChanged', function(event) {
    if (event.detail && event.detail.newBalance !== undefined) {
      currentUserCoinBalance = event.detail.newBalance;
      updateAllFayCoinDisplays();
    }
  });

  // 監聽 localStorage 變化（跨頁籤同步）
  window.addEventListener('storage', function(event) {
    if (event.key === 'fayCoinBalance') {
      currentUserCoinBalance = parseInt(event.newValue || '0', 10);
      updateAllFayCoinDisplays();
    }
  });

  // 監聽頁面可見性變化（重新獲取最新數據）
  document.addEventListener('visibilitychange', async function() {
    if (document.visibilityState === 'visible' && currentUserEmail) {
      currentUserCoinBalance = await getUserCoinsFromFirebase(currentUserEmail);
      localStorage.setItem('fayCoinBalance', currentUserCoinBalance.toString());
      updateAllFayCoinDisplays();
    }
  });

  // ====== 初始化 ======

  window.addEventListener('DOMContentLoaded', () => {
    disableUserInteraction(); // 頁面載入時禁止操作
  });

  window.addEventListener('load', () => {
    setTimeout(() => {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.style.display = 'none';
      enableUserInteraction();
    }, 600);
  });

  window.onload = async function () {
    // 顯示登入成功提示
    if (localStorage.getItem('justLoggedIn') === 'true') {
      alert('🎉 歡迎登入成功！');
      localStorage.removeItem('justLoggedIn');
    }

    // 檢查登入狀態
    if (localStorage.getItem('isLoggedIn') === 'true') {
      const email = localStorage.getItem('userEmail') || 'guest@example.com';
      currentUserEmail = email;

      try {
        // 從 Firebase 同步最新 Fay 幣餘額
        currentUserCoinBalance = await getUserCoinsFromFirebase(email);
        localStorage.setItem('fayCoinBalance', currentUserCoinBalance.toString());

        // 顯示用戶界面
        await showProBannerWithClaim(email);
        await showUserMenu(email);
      } catch (error) {
        console.error("❌ 初始化用戶狀態失敗", error);
        // 即使 Firebase 失敗也要顯示基本 UI
        await showUserMenu(email);
      }
    } else {
      showPreLoginBanner();
    }

    // 載入公告
    loadAnnouncementsFromGoogleSheets();
  };
// 現在仍然可以這樣用，會自動同步
addFayCoins(15);
const email = localStorage.getItem('userEmail');
if (email) {
  const db = firebase.firestore();
  db.collection('userLoginRewards')
    .where('userEmail', '==', email)
    .get()
    .then(snapshot => {
      if (!snapshot.empty) {
        snapshot.forEach(doc => {
          db.collection('userLoginRewards').doc(doc.id).update({ coins: updated });
        });
      }
    });
}
window.fayCoinManager.addListener((newBalance) => {
  document.getElementById('coin-balance').textContent = newBalance;
});

</script>
<div id="coin-display">Fay幣：<span id="coin-balance">0</span></div>
<script type="module">
import './faycoin-sync.js';

window.fayCoinManager.addListener((newBal)=>{
  const display = document.getElementById('coin-count');
  if(display) display.textContent = newBal;
});
window.fayCoinManager.updateBalance(最新餘額);
// ====== 修復 Fay幣即時更新 ======

// 等待 fayCoinManager 初始化完成
function waitForFayCoinManager() {
  return new Promise((resolve) => {
    if (window.fayCoinManager) {
      resolve();
    } else {
      setTimeout(() => waitForFayCoinManager().then(resolve), 100);
    }
  });
}

// 設置 Fay幣即時更新監聽器
async function setupFayCoinSync() {
  await waitForFayCoinManager();
  
  // 清除所有舊的監聽器（避免重複）
  if (window.fayCoinSyncSetup) return;
  window.fayCoinSyncSetup = true;
  
  // 添加即時更新監聽器
  window.fayCoinManager.addListener((newBalance, oldBalance) => {
    console.log(`💰 Fay幣更新: ${oldBalance} → ${newBalance}`);
    
    // 更新所有顯示 Fay幣的元素
    const coinDisplays = document.querySelectorAll('#coin-count, #coin-balance, .fay-coin-display');
    coinDisplays.forEach(element => {
      if (element) {
        element.textContent = newBalance;
        element.style.color = 'gold';
      }
    });
    
    // 更新全域變量
    currentUserCoinBalance = newBalance;
  });
  
  console.log('✅ Fay幣即時同步監聽器已設置');
}

// 修改現有的 showUserMenu 函數中的 Fay幣顯示部分
async function showUserMenu(email) {
  const loginItem = document.getElementById('login-item');
  const name = localStorage.getItem('userName') || '訪客';
  const avatarUrl = localStorage.getItem('userPhotoURL') ||
    `https://www.gravatar.com/avatar/${md5(email.trim().toLowerCase())}?s=40&d=identicon`;

  // ✅ 使用 fayCoinManager 獲取餘額
  await waitForFayCoinManager();
  currentUserCoinBalance = window.fayCoinManager.getBalance();

  // ✅ 使用與 exchange.html 相同的方式載入餘額
  try {
    const snapshot = await db.collection('userLoginRewards')
      .where('userEmail', '==', email)
      .get();
    
    let coins = 0;
    if (!snapshot.empty) {
      coins = snapshot.docs[0].data().coins || 0;
    }
    
    // 同步更新
    currentUserCoinBalance = coins;
    localStorage.setItem('fayCoinBalance', coins.toString());
    
  } catch (error) {
    console.error("❌ 載入餘額失敗", error);
    currentUserCoinBalance = parseInt(localStorage.getItem('fayCoinBalance') || '0');
  }

  // 顯示用戶選單（包含最新餘額）
  if (loginItem) {
    loginItem.outerHTML = `
      <div class="nav-item user-dropdown" id="user-dropdown">
        <img src="${avatarUrl}" alt="頭像" class="avatar" id="avatar-img" />
        <div class="dropdown-menu" id="dropdown-menu">
          <div class="dropdown-item"><strong>${name}</strong></div>
          <div class="dropdown-item email-text">${email}</div>
          <a class="dropdown-item" href="exchange.html">
            Fay幣：<span id="coin-count" style="color: gold;">${currentUserCoinBalance}</span><br> ➜ 兌換
          </a>
          <a class="dropdown-item" href="earn.html">任務</a>
          <a class="dropdown-item" href="setting.html">設定</a>
          <a class="dropdown-item" href="#" id="logout-link">登出</a>
        </div>
      </div>`;
  }
}

// 修改 window.onload 函數
window.onload = async function () {
  // 顯示登入成功提示
  if (localStorage.getItem('justLoggedIn') === 'true') {
    alert('🎉 歡迎登入成功！');
    localStorage.removeItem('justLoggedIn');
  }

  // ✅ 先設置 Fay幣同步
  await setupFayCoinSync();

  // 檢查登入狀態
  if (localStorage.getItem('isLoggedIn') === 'true') {
    const email = localStorage.getItem('userEmail') || 'guest@example.com';
    currentUserEmail = email;

    try {
      // ✅ 使用 fayCoinManager 同步 Firebase 餘額
      await waitForFayCoinManager();
      const firebaseBalance = await getUserCoinsFromFirebase(email);
      window.fayCoinManager.updateBalance(firebaseBalance);

      // 顯示用戶界面
      await showProBannerWithClaim(email);
      await showUserMenu(email);
    } catch (error) {
      console.error("❌ 初始化用戶狀態失敗", error);
      await showUserMenu(email);
    }
  } else {
    showPreLoginBanner();
  }

  // 載入公告
  loadAnnouncementsFromGoogleSheets();
};

// ✅ 移除所有重複的監聽器代碼和測試代碼
// ✅ 添加到 window.onload 最後
window.addEventListener('fayCoinChanged', (event) => {
  if (event.detail && event.detail.newBalance !== undefined) {
    currentUserCoinBalance = event.detail.newBalance;
    const coinDisplay = document.getElementById('coin-count');
    if (coinDisplay) {
      coinDisplay.textContent = currentUserCoinBalance;
    }
  }
});
</script>

<script>
const key = `forceReload:${location.pathname.split('/').pop()}`;
const lastReload = localStorage.getItem(key);
if (lastReload) {
  localStorage.removeItem(key);
  location.reload();
}
</script>
const reloadKey = `forceReload:${location.pathname.split('/').pop()}`;
const reloadValue = localStorage.getItem(reloadKey);
if (reloadValue) {
  localStorage.removeItem(reloadKey);
  location.reload();
}

</body>
</html>