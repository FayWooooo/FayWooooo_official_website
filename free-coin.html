<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å…è²»é ˜å– Fay å¹£</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <link rel="icon" href="logo.ico" type="image/x-icon">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body style="text-align:center; font-family:sans-serif; background:#111; color:white;">
  <h1>ğŸ å…è²»é ˜å– Fay å¹£ ğŸ</h1>
  <p>æ¯å€‹å¸³è™Ÿé™é ˜ä¸€æ¬¡</p>
  <button id="claimBtn" style="padding:10px 20px; font-size:18px; border-radius:10px; cursor:pointer;">é»æˆ‘é ˜å– 50 Fay å¹£</button>

  <script>
    // âœ… ä¸€é€²é é¢å…ˆæª¢æŸ¥ç™»å…¥ç‹€æ…‹ï¼Œæœªç™»å…¥ç›´æ¥è·³å›é¦–é 
    if (localStorage.getItem("isLoggedIn") !== "true") {
      alert("âš ï¸ è«‹å…ˆç™»å…¥å¸³è™Ÿ");
      window.location.href = "index.html";
    }

    const firebaseConfig = {
      apiKey: "AIzaSyAw3NxfRft4pke6TUl9gQ4a8P0LEm30zWo",
      authDomain: "faycoin-bb878.firebaseapp.com",
      projectId: "faycoin-bb878",
      storageBucket: "faycoin-bb878.appspot.com",
      messagingSenderId: "665116400856",
      appId: "1:665116400856:web:a263d792c69129400d8bad",
      measurementId: "G-ZSZZD4W1HX"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.getElementById("claimBtn").addEventListener("click", async () => {
      const email = localStorage.getItem("userEmail");
      if (!email) {
        alert("âš ï¸ æ‰¾ä¸åˆ°ç™»å…¥å¸³è™Ÿï¼Œè«‹é‡æ–°ç™»å…¥");
        window.location.href = "index.html";
        return;
      }

      try {
        const snapshot = await db.collection("userLoginRewards")
          .where("userEmail", "==", email)
          .limit(1)
          .get();

        if (!snapshot.empty) {
          const docRef = snapshot.docs[0].ref;
          const data = snapshot.docs[0].data();

          if (data.hasClaimedFreeGift) {
            alert("âŒ ä½ å·²ç¶“é ˜éå›‰ï¼Œæ¯å€‹å¸³è™Ÿåªèƒ½é ˜ä¸€æ¬¡ï¼");
            return;
          }

          await docRef.update({
            hasClaimedFreeGift: true,
            coins: firebase.firestore.FieldValue.increment(50)
          });

          alert("ğŸ‰ æ­å–œï¼ä½ ç²å¾—äº† 50 Fay å¹£");
          localStorage.setItem("fayCoinBalance", (data.coins + 50).toString());
          window.dispatchEvent(new CustomEvent("fayCoinChanged", {
            detail: { newBalance: data.coins + 50 }
          }));
          window.location.href = "exchange.html"; // é ˜å®Œè‡ªå‹•è·³åˆ°å…Œæ›é 
        } else {
          // å¦‚æœå¸³è™Ÿé‚„æ²’è³‡æ–™ï¼Œå»ºç«‹æ–°ç´€éŒ„
          await db.collection("userLoginRewards").add({
            userEmail: email,
            coins: 50,
            hasClaimedFreeGift: true,
            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
          });
          alert("ğŸ‰ æ­å–œï¼ä½ ç²å¾—äº† 50 Fay å¹£");
          localStorage.setItem("fayCoinBalance", "50");
          window.dispatchEvent(new CustomEvent("fayCoinChanged", { detail: { newBalance: 50 } }));
          window.location.href = "exchange.html";
        }
      } catch (error) {
        console.error("âŒ é ˜å–å¤±æ•—ï¼š", error);
        alert("ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
      }
    });
  </script>
</body>
</html>
