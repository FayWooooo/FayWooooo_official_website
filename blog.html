<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>FayWooooo éƒ¨è½æ ¼</title>
  <link rel="icon" href="logo.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      background-image: linear-gradient(rgb(8, 19, 41), rgb(0, 0, 0));
      font-family: 'hanwangheiheavy', sans-serif;
      margin: 0; padding: 0;
      color: white;
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }
    .page { display: none; padding: 20px;margin-bottom: 50px; }
    .page.active { display: block; }

    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: 60px; background: rgba(255,255,255,0.07);
      display: flex; justify-content: space-around; align-items: center;
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(255,255,255,0.2);
      z-index: 1000;
    }
    .bottom-nav a { color: #aaa; text-decoration: none; font-size: 22px; }
    .bottom-nav a.active { color: gold; }

.post-card {
    background: rgba(255,255,255,0.07);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.5);
    cursor: pointer; /* æ»‘é¼ è®Šå°æ‰‹ */
    transition: background 0.3s, transform 0.2s;
  }
  .post-card:hover {
    background: rgba(255,255,255,0.15);
    transform: translateY(-3px);
  }
  
    .post-header { display: flex; align-items: center; margin-bottom: 10px; }
    .avatar {
      width: 40px; height: 40px; border-radius: 50%;
      margin-right: 10px;
    }
    .post-header strong { font-size: 16px; }
    .post-actions { margin-top: 10px; }
    .post-actions button {
      background: none; border: none; color: #ccc;
      cursor: pointer; margin-right: 15px; font-size: 16px;
    }
    .post-actions button:hover { color: gold; }
    .comments { margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; }
    .comments p { margin: 5px 0; font-size: 14px; }
    .comments input { width: 70%; padding: 5px; border-radius: 5px; border: none; }
    .comments button { padding: 5px 10px; border: none; border-radius: 5px; background: gold; cursor: pointer; }
    .comments button:hover{
        background-color: #ffffff;
        color: #000000;
    }
    .comment-btn {
  position: relative;
}

.comment-count {
  position: absolute;
  top: -8px;
  right: -10px;
  background: red;
  color: white;
  font-size: 12px;
  font-weight: bold;
  border-radius: 50%;
  padding: 2px 1px;
  min-width: 18px;
  text-align: center;
}

.post-content img {
    width: 100%;             /* å¡«æ»¿å®¹å™¨å¯¬åº¦ */
    height: auto;            /* é«˜åº¦è‡ªå‹•ä¿æŒæ¯”ä¾‹ */
    max-height: 600px;       /* æ¯”è¼ƒå¤§çš„é™åˆ¶ï¼Œé¿å…ä½”æ»¿æ•´é  */
    border-radius: 12px;
    object-fit: cover;       /* ä¿æŒæ¯”ä¾‹ä½†æ›´è²¼åˆå€å¡Š */
    background: black;
    box-shadow: 0 4px 20px rgba(0,0,0,0.6);
  }
  
  
  .like-btn {
  color: #000000;
  cursor: pointer;
  transition: color 0.2s;
}
.like-btn:hover {
background-color: #ffffff;
  color: rgb(0, 0, 0);
}
.single-post-container {
  display: flex;
  justify-content: center;
  margin: 20px auto;
  width: 80%;
  gap: 20px;
}

.single-post {
  width: 55%;
  background: rgba(255,255,255,0.07);
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.5);
}

.single-comments {
  width: 25%;
  background: rgba(255,255,255,0.05);
  border-radius: 15px;
  padding: 15px;
  overflow-y: auto;
  max-height: 80vh;
}
.single-comments button {
  margin-top: 10px;
}

.single-comments p { margin: 5px 0; font-size: 14px; }
.single-comments input { width: 70%; padding: 5px; border-radius: 5px; border: none; }
.single-comments button { padding: 5px 10px; border: none; border-radius: 5px; background: gold; cursor: pointer; }
.single-comments button:hover{
    background-color: #ffffff;
    color: #000000;
}
#searchPage {
  max-width: 900px;
  margin: 0 auto;
}
#searchInput {
  width: 70%;
  padding: 8px;
  border-radius: 8px;
  border: none;
  margin-right: 10px;
}
#searchResults {
  margin-top: 20px;
}

 </style>
</head>
<body>
  <nav style="padding:10px;background:rgba(255,255,255,0.07);border-radius:15px;margin:10px;">
    <a href="index.html" style="color:white;margin-right:15px;text-decoration: none;">
      <i class="fas fa-home"></i> é¦–é 
    </a>
    <a href="exchange.html" style="color:white;margin-right:15px;text-decoration: none;">
      <i class="fas fa-coins"></i> Fayå¹£å…Œæ›
    </a>
    <a href="blog.html" style="color:gold;text-decoration: none;">
        <i class="fas fa-pen"></i> éƒ¨è½æ ¼
      </a>
  </nav>

  <!-- åˆ†é å…§å®¹ -->
  <div id="homePage" class="page active">
    <h2><i class="fas fa-home"></i> é¦–é </h2>
    <div id="homePosts"></div>
  </div>

  <div id="addPage" class="page">
    <h2><i class="fas fa-plus-square"></i> æ–°å¢è²¼æ–‡</h2>
    <div class="post-card">
        <input type="text" id="postTitle" placeholder="æ¨™é¡Œ"><br>
        <textarea id="postContent" rows="5" placeholder="å…§å®¹"></textarea><br>
        <label>ä¸Šå‚³åœ–ç‰‡ï¼š<input type="file" id="postImage" accept="image/*"></label><br>
        <label>ç•™è¨€ä¸Šé™(0~10000)ï¼š<input type="number" id="maxComments" value="10000" min="0" max="10000"></label><br>
        <button onclick="addBlogPost()">ç™¼è¡¨</button>
      </div>
      
  </div>
  

  <div id="explorePage" class="page">
    <h2><i class="fas fa-compass"></i> æ¢ç´¢</h2>
    <div id="explorePosts"></div>
  </div>

  <div id="profilePage" class="page">
    <h2><i class="fas fa-user"></i> å€‹äººé </h2>
    <p id="profileInfo"></p>
    <div id="profilePosts"></div>
  </div>

  <div id="searchPage" class="page">
    <h2><i class="fas fa-search"></i> æœå°‹</h2>
    <input type="text" id="searchInput" placeholder="è¼¸å…¥é—œéµå­—...">
    <button onclick="searchPosts()">æœå°‹</button>
    <div id="searchResults"></div>
  </div>
  
  <!-- ä¿®æ”¹åº•éƒ¨å°è¦½åˆ— -->
  <div class="bottom-nav">
    <a href="#" onclick="showPage('homePage', this)" class="active"><i class="fas fa-home"></i></a>
    <a href="#" onclick="showPage('searchPage', this)"><i class="fas fa-search"></i></a>
    <a href="#" onclick="showPage('addPage', this)"><i class="fas fa-plus-square"></i></a>
    <a href="#" onclick="showPage('profilePage', this)"><i class="fas fa-user"></i></a>
  </div>
  

  <script>
    // Firebase åˆå§‹åŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyAw3NxfRft4pke6TUl9gQ4a8P0LEm30zWo",
      authDomain: "faycoin-bb878.firebaseapp.com",
      projectId: "faycoin-bb878",
      storageBucket: "faycoin-bb878.appspot.com",
      messagingSenderId: "665116400856",
      appId: "1:665116400856:web:a263d792c69129400d8bad"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const userEmail = localStorage.getItem("userEmail") || "guest@example.com";
    const userNickname = localStorage.getItem("nickname") || "åŒ¿å";
    const userAvatar = localStorage.getItem("avatarUrl") || "default-avatar.png";
    const storage = firebase.storage();



    // ç›¸å°æ™‚é–“
    function timeAgo(date) {
      if (!date) return "";
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);
      if (diff < 60) return "å‰›å‰›";
      const mins = Math.floor(diff / 60);
      if (mins < 60) return mins + " åˆ†é˜å‰";
      const hours = Math.floor(mins / 60);
      if (hours < 24) return hours + " å°æ™‚å‰";
      const days = Math.floor(hours / 24);
      if (days < 7) return days + " å¤©å‰";
      const weeks = Math.floor(days / 7);
      if (weeks < 4) return weeks + " é€±å‰";
      const months = Math.floor(days / 30);
      if (months < 12) return months + " æœˆå‰";
      const years = Math.floor(days / 365);
      return years + " å¹´å‰";
    }

    // æŒ‰è®š
// ç•™è¨€æŒ‰è®šï¼šæŒ‰ä¸€æ¬¡åŠ è®šï¼Œå†æŒ‰ä¸€æ¬¡å–æ¶ˆ
async function likeComment(postId, commentId) {
  const ref = db.collection("blogPosts").doc(postId).collection("comments").doc(commentId);
  const snap = await ref.get();
  const data = snap.data();
  let likedBy = data.likedBy || [];

  if (likedBy.includes(userEmail)) {
    await ref.update({
      likes: firebase.firestore.FieldValue.increment(-1),
      likedBy: firebase.firestore.FieldValue.arrayRemove(userEmail)
    });
  } else {
    await ref.update({
      likes: firebase.firestore.FieldValue.increment(1),
      likedBy: firebase.firestore.FieldValue.arrayUnion(userEmail)
    });
  }
}




    // åˆ†äº«
    // åˆ†äº«åŠŸèƒ½ï¼šè¤‡è£½å–®ä¸€è²¼æ–‡é€£çµ
function sharePost(postId) {
  const url = window.location.origin + window.location.pathname + "?post=" + postId;
  navigator.clipboard.writeText(url).then(() => {
    alert("âœ… å·²è¤‡è£½è©²è²¼æ–‡çš„åˆ†äº«é€£çµï¼");
  });
}

// æª¢æŸ¥ç¶²å€æ˜¯å¦æœ‰å–®ä¸€ postId
window.addEventListener("DOMContentLoaded", async () => {
    const params = new URLSearchParams(window.location.search);
    const postId = params.get("post");
    const profileId = params.get("profile"); // æ–°å¢
  
    if (postId) {
      showSinglePost(postId);
    } else if (profileId) {
      showProfile(profileId);
      showPage("profilePage", document.querySelector('.bottom-nav a[onclick*="profilePage"]'));
    }
  });
  

// é¡¯ç¤ºå–®ä¸€è²¼æ–‡
async function showSinglePost(postId) {
  document.body.innerHTML = ""; // æ¸…ç©ºé é¢
  const snap = await db.collection("blogPosts").doc(postId).get();
  if (!snap.exists) {
    document.body.innerHTML = "<p style='text-align:center'>âŒ æ‰¾ä¸åˆ°è²¼æ–‡</p>";
    return;
  }
  const data = snap.data();

  const container = document.createElement("div");
  container.className = "single-post-container";

  const postDiv = document.createElement("div");
  postDiv.className = "single-post";
  postDiv.innerHTML = `
    <div class="post-header">
      <img src="${data.avatarUrl}" class="avatar">
      <strong>${data.nickname}</strong>
    </div>
    <h3>${data.title}</h3>
    <small><i class="fas fa-clock"></i> ${timeAgo(data.createdAt?.toDate())}</small>
    <div class="post-content">
      <p>${data.content}</p>
      ${data.imageBase64 ? `<img src="${data.imageBase64}">` : ""}
    </div>
    <div class="post-actions">
      <button onclick="likePost('${postId}')"><i class="fas fa-thumbs-up"></i> ${data.likes || 0}</button>
      <button onclick="sharePost('${postId}')"><i class="fas fa-share"></i> åˆ†äº«</button>
    </div>
    <div style="margin-top:20px;text-align:center;">
      <button onclick="goHome()" style="padding:8px 16px;border:none;border-radius:8px;background:gold;cursor:pointer;">
        <i class="fas fa-arrow-left"></i> å›é¦–é 
      </button>
    </div>
  `;

  const commentsDiv = document.createElement("div");
  commentsDiv.className = "single-comments";
  commentsDiv.id = "comments-" + postId;

  container.appendChild(postDiv);
  container.appendChild(commentsDiv);
  document.body.appendChild(container);

setTimeout(() => {
    loadComments(postId);
  }, 50); // ç­‰ç€è¦½å™¨ç•«é¢åˆ·æ–°
  
}

// æ–°å¢å›é¦–é åŠŸèƒ½
function goHome() {
  window.location.href = "blog.html"; // é‡æ–°è¼‰å…¥éƒ¨è½æ ¼é¦–é 
}



function loadComments(postId) {
    const commentsDiv = document.getElementById("comments-" + postId);
    if (!commentsDiv) return;
  
    db.collection("blogPosts").doc(postId)
      .collection("comments").orderBy("createdAt", "asc")
      .onSnapshot(snapshot => {
        // é‡å»ºç•™è¨€å€
        commentsDiv.innerHTML = `
          <h3>ç•™è¨€</h3>
          <input type="text" id="commentInput-${postId}" placeholder="è¼¸å…¥ç•™è¨€...">
          <button onclick="addComment('${postId}')">é€å‡º</button>
          <div id="commentList-${postId}"></div>
        `;
  
        // âš ï¸ å†æª¢æŸ¥ä¸€æ¬¡
        const list = document.getElementById("commentList-" + postId);
        if (!list) return;
  
        if (snapshot.empty) {
          list.innerHTML = "<p style='color:#aaa'>ç›®å‰æ²’æœ‰ç•™è¨€</p>";
          return;
        }
  
        let count = 0;
        snapshot.forEach(doc => {
          const data = doc.data();
          const c = document.createElement("div");
          c.innerHTML = `
            <strong>${data.nickname}</strong>ï¼š${data.text}
            <button class="like-btn" onclick="likeComment('${postId}','${doc.id}')">
              <i class="fas fa-heart"></i> ${data.likes || 0}
            </button>
            <button onclick="replyComment('${postId}','${doc.id}')"><i class="fas fa-reply"></i> å›è¦†</button>
            ${(data.userEmail === userEmail) ? `<button onclick="deleteComment('${postId}','${doc.id}')"><i class="fas fa-trash"></i></button>` : ""}
            <div id="replies-${doc.id}" class="replies"></div>
          `;
  
          if (count < 5) list.appendChild(c);
          else c.style.display = "none";
          count++;
  
          loadReplies(postId, doc.id);
        });
  
        if (count > 5) {
          const btn = document.createElement("button");
          btn.textContent = "å±•é–‹æ›´å¤šç•™è¨€";
          btn.onclick = () => {
            [...list.children].forEach(c => c.style.display = "block");
            btn.remove();
          };
          list.appendChild(btn);
        }
      });
  }
  





async function addComment(postId) {
    const input = document.getElementById("commentInput-" + postId);
    const text = input.value.trim();
    if (!text) return;
  
    // æª¢æŸ¥ç•™è¨€æ•¸é‡
    const post = await db.collection("blogPosts").doc(postId).get();
    const comments = await db.collection("blogPosts").doc(postId).collection("comments").get();
    if (comments.size >= (post.data().maxComments || 10000)) {
      alert("ç•™è¨€æ•¸å·²é”ä¸Šé™");
      return;
    }
  
    // ğŸ”¹ å¾ userProfiles æŠ“æš±ç¨±
    let nickname = userNickname;
    const profileSnap = await db.collection("userProfiles").doc(userEmail).get();
    if (profileSnap.exists) {
      nickname = profileSnap.data().nickname || nickname;
    }
  
    await db.collection("blogPosts").doc(postId).collection("comments").add({
      userEmail,
      nickname,  // âœ… å„²å­˜çœŸæ­£çš„æš±ç¨±
      text,
      likes: 0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    input.value = "";
  }

async function deleteComment(postId, commentId) {
  if (!confirm("åˆªé™¤æ­¤ç•™è¨€ï¼Ÿ")) return;
  await db.collection("blogPosts").doc(postId).collection("comments").doc(commentId).delete();
  loadComments(postId);
}

async function replyComment(postId, commentId) {
    const repliesDiv = document.getElementById("replies-" + commentId);
  
    // å¦‚æœå·²ç¶“æœ‰è¼¸å…¥æ¡†å°±ä¸å†æ–°å¢
    if (document.getElementById(`replyInput-${commentId}`)) return;
  
    const input = document.createElement("input");
    input.type = "text";
    input.id = `replyInput-${commentId}`;
    input.placeholder = "è¼¸å…¥å›è¦†...";
  
    const btn = document.createElement("button");
    btn.textContent = "é€å‡º";
    btn.onclick = async () => {
      const text = input.value.trim();
      if (!text) return;
      await db.collection("blogPosts").doc(postId)
        .collection("comments").doc(commentId)
        .collection("replies").add({
          userEmail,
          nickname: userNickname,
          text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      input.remove();
      btn.remove();
    };
  
    repliesDiv.appendChild(input);
    repliesDiv.appendChild(btn);
  }
  
  
  function loadReplies(postId, commentId) {
  const repliesDiv = document.getElementById("replies-" + commentId);
  db.collection("blogPosts").doc(postId)
    .collection("comments").doc(commentId)
    .collection("replies").orderBy("createdAt","asc")
    .onSnapshot(snapshot => {
      repliesDiv.innerHTML = "";
      snapshot.forEach(doc => {
        const r = doc.data();
        const div = document.createElement("div");
        div.style.marginLeft = "20px";
        div.innerHTML = `<small><strong>${r.nickname}</strong>ï¼š${r.text}</small>`;
        repliesDiv.appendChild(div);
      });
    });
}

  


    function toggleComments(postId) {
      const commentsDiv = document.getElementById("comments-" + postId);
      if (commentsDiv.style.display === "none") {
        commentsDiv.style.display = "block";
        loadComments(postId);
      } else {
        commentsDiv.style.display = "none";
      }
    }

    // é¦–é æ–‡ç« æµ
    db.collection("blogPosts").orderBy("createdAt","desc")
      .onSnapshot(snapshot => {
        const container = document.getElementById("homePosts");
        container.innerHTML = "";
        snapshot.forEach(async (doc) => {
  const data = doc.data();
  const div = document.createElement("div");
  div.className = "post-card";
  div.id = "post-" + doc.id;

  div.innerHTML = `
    <div class="post-header">
      <img src="${data.avatarUrl}" class="avatar">
      <strong>${data.nickname}</strong>
    </div>
    <h3>${data.title}</h3>
    <small><i class="fas fa-clock"></i> ${timeAgo(data.createdAt?.toDate())}</small>
    <div class="post-content">
      <p>${data.content}</p>
      ${data.imageBase64 ? `<img src="${data.imageBase64}">` : ""}
    </div>
    <div class="post-actions">
      <button onclick="event.stopPropagation(); likePost('${doc.id}')">
        <i class="fas fa-thumbs-up"></i> ${data.likes || 0}
      </button>
      <button class="comment-btn" onclick="event.stopPropagation(); toggleComments('${doc.id}')">
        <i class="fas fa-comment"></i> ç•™è¨€
        <span class="comment-count" id="comment-count-${doc.id}" style="display:none;"></span>
      </button>
      <button onclick="event.stopPropagation(); sharePost('${doc.id}')"><i class="fas fa-share"></i> åˆ†äº«</button>
      ${data.userEmail === userEmail ? `<button onclick="event.stopPropagation(); deletePost('${doc.id}')"><i class="fas fa-trash"></i> åˆªé™¤</button>` : ""}
    </div>
    <div class="comments" id="comments-${doc.id}" style="display:none;"></div>
  `;

  // ğŸ”´ ç›£è½ç•™è¨€æ•¸é‡ï¼Œæ›´æ–° badge
  db.collection("blogPosts").doc(doc.id).collection("comments")
    .onSnapshot(snapshot => {
      const count = snapshot.size;
      const badge = div.querySelector(`#comment-count-${doc.id}`);
      if (count > 0) {
        badge.style.display = "inline-block";
        badge.textContent = count > 9 ? "9+" : count;
      } else {
        badge.style.display = "none";
      }
    });

  // âš¡ é»æ“Šå¡ç‰‡èƒŒæ™¯è·³è½‰
  div.addEventListener("click", (e) => {
    if (e.target.closest(".post-actions") || e.target.closest(".comments")) return;
    window.location.href = "blog.html?post=" + doc.id;
  });

  container.appendChild(div);
});


      });

    // åˆ†é åˆ‡æ›
    function showPage(pageId, el) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(pageId).classList.add("active");
  document.querySelectorAll(".bottom-nav a").forEach(a => a.classList.remove("active"));
  el.classList.add("active");

  // ğŸ”¹ å¦‚æœæ˜¯é€²å…¥å€‹äººé ï¼Œè‡ªå‹•é¡¯ç¤ºç™»å…¥è€…çš„æª”æ¡ˆ
  if (pageId === "profilePage") {
    showProfile(userEmail);
  }
}

    // ç™¼æ–‡
async function addBlogPost() {
    const title = document.getElementById("postTitle").value.trim();
    const content = document.getElementById("postContent").value.trim();
    const maxComments = parseInt(document.getElementById("maxComments").value) || 10000;
  
    const imageFile = document.getElementById("postImage").files[0];
    let imageBase64 = "";
  
    if (imageFile) {
      imageBase64 = await fileToBase64(imageFile);
    }
  
    if (!title && !content && !imageBase64) {
      return alert("è«‹è‡³å°‘è¼¸å…¥æ–‡å­—æˆ–ä¸Šå‚³åœ–ç‰‡");
    }
  
    const profileSnap = await db.collection("userProfiles").doc(userEmail).get();
    let nickname = "åŒ¿å", avatarUrl = "default-avatar.png";
    if (profileSnap.exists) {
      const p = profileSnap.data();
      nickname = p.nickname || nickname;
      avatarUrl = p.avatarUrl || avatarUrl;
    }
  
    await db.collection("blogPosts").add({
      userEmail,
      nickname,
      avatarUrl,
      title,
      content,
      imageBase64,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(docRef => {
      alert("âœ… è²¼æ–‡å·²æˆåŠŸç™¼è¡¨ï¼");
      showPage("homePage", document.querySelector('.bottom-nav a'));
      setTimeout(() => {
        const postElement = document.getElementById("post-" + docRef.id);
        if (postElement) {
          postElement.scrollIntoView({ behavior: "smooth", block: "center" });
          postElement.style.boxShadow = "0 0 15px gold";
          setTimeout(() => { postElement.style.boxShadow = ""; }, 2000);
        }
      }, 800);
    });
  
    document.getElementById("postTitle").value = "";
    document.getElementById("postContent").value = "";
    document.getElementById("postImage").value = "";
  }
  

  
  
async function deletePost(postId) {
  if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç¯‡è²¼æ–‡å—ï¼Ÿ")) return;
  await db.collection("blogPosts").doc(postId).delete();
  alert("âœ… è²¼æ–‡å·²åˆªé™¤");
}
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);   // Base64 å­—ä¸²
    reader.onerror = reject;
    reader.readAsDataURL(file); // â† æœƒå¾—åˆ° "data:image/png;base64,..." æˆ– "data:video/mp4;base64,..."
  });
}
async function searchPosts() {
    const keyword = document.getElementById("searchInput").value.trim();
    if (!keyword) return;
  
    const snapshot = await db.collection("blogPosts").orderBy("createdAt","desc").get();
    const resultsDiv = document.getElementById("searchResults");
    resultsDiv.innerHTML = "";
  
    let foundAuthor = false;
  
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.title.includes(keyword) || data.content.includes(keyword) || data.nickname.includes(keyword)) {
        const div = document.createElement("div");
        div.className = "post-card";
        div.innerHTML = `
          <div class="post-header">
            <img src="${data.avatarUrl}" class="avatar">
            <strong>${data.nickname}</strong>
          </div>
          <h3>${data.title}</h3>
          <small><i class="fas fa-clock"></i> ${timeAgo(data.createdAt?.toDate())}</small>
          <div class="post-content">
            <p>${data.content}</p>
            ${data.imageBase64 ? `<img src="${data.imageBase64}">` : ""}
          </div>
        `;
        div.addEventListener("click", () => {
          window.location.href = "blog.html?post=" + doc.id;
        });
        resultsDiv.appendChild(div);
  
        // å¦‚æœæœå°‹è©è·Ÿä½œè€…æš±ç¨±ä¸€æ¨£
        if (data.nickname === keyword && !foundAuthor) {
          const btn = document.createElement("button");
          btn.textContent = `æŸ¥çœ‹ ${data.nickname} çš„å€‹äººæª”æ¡ˆ`;
          btn.style = "margin:10px;padding:8px 16px;border:none;border-radius:8px;background:gold;cursor:pointer;";
          btn.onclick = () => showProfile(data.userEmail);
          resultsDiv.prepend(btn);
          foundAuthor = true;
        }
      }
    });
  
    if (!resultsDiv.innerHTML) {
      resultsDiv.innerHTML = "<p style='color:#aaa;text-align:center;'>æ²’æœ‰æ‰¾åˆ°ç›¸é—œæ–‡ç« æˆ–ä½œè€…</p>";
    }
  }
  
  
// è²¼æ–‡æŒ‰è®šï¼šæŒ‰ä¸€æ¬¡åŠ è®šï¼Œå†æŒ‰ä¸€æ¬¡å–æ¶ˆ
async function likePost(postId) {
  const ref = db.collection("blogPosts").doc(postId);
  const snap = await ref.get();
  const data = snap.data();
  let likedBy = data.likedBy || [];

  if (likedBy.includes(userEmail)) {
    await ref.update({
      likes: firebase.firestore.FieldValue.increment(-1),
      likedBy: firebase.firestore.FieldValue.arrayRemove(userEmail)
    });
  } else {
    await ref.update({
      likes: firebase.firestore.FieldValue.increment(1),
      likedBy: firebase.firestore.FieldValue.arrayUnion(userEmail)
    });
  }
}
async function renderSearchHistory() {
  const historyRef = db.collection("userSearchHistory").doc(userEmail);
  const docSnap = await historyRef.get();
  if (!docSnap.exists) return;

  const history = docSnap.data().keywords || [];
  const input = document.getElementById("searchInput");
  input.setAttribute("list", "searchHistoryList");

  let datalist = document.getElementById("searchHistoryList");
  if (!datalist) {
    datalist = document.createElement("datalist");
    datalist.id = "searchHistoryList";
    document.body.appendChild(datalist);
  }

  datalist.innerHTML = history.map(k => `<option value="${k}">`).join("");
}
// é¡¯ç¤ºå€‹äººæª”æ¡ˆ
async function showProfile(email) {
  const profileDiv = document.getElementById("profileInfo");
  const postsDiv = document.getElementById("profilePosts");
  profileDiv.innerHTML = "è¼‰å…¥ä¸­...";
  postsDiv.innerHTML = "";

  // æŠ“å–ä½¿ç”¨è€…è³‡æ–™
  const profileSnap = await db.collection("userProfiles").doc(email).get();
  if (!profileSnap.exists) {
    profileDiv.innerHTML = "âŒ æ‰¾ä¸åˆ°æ­¤ç”¨æˆ¶";
    return;
  }
  const profile = profileSnap.data();
profileDiv.innerHTML = `
<img src="${profile.avatarUrl || 'default-avatar.png'}" class="avatar" style="width:80px;height:80px;">
<h3>${profile.nickname || "åŒ¿å"}</h3>
<p>${profile.bio || "å€‹äººæª”æ¡ˆ"} </p>
<button onclick="shareProfile('${email}')" 
        style="margin-top:10px;padding:6px 12px;border:none;border-radius:6px;background:gold;cursor:pointer;">
  <i class="fas fa-link"></i> è¤‡è£½å€‹äººæª”æ¡ˆé€£çµ
</button>
`;


  // æŠ“å–æ­¤äººæ–‡ç« 
  const snapshot = await db.collection("blogPosts")
  .where("userEmail", "==", email)
  .get();

// é€™è£¡ç”¨ JS æ’åºï¼Œé¿å… Firestore éœ€è¦ index
const posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
posts.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

  if (snapshot.empty) {
    postsDiv.innerHTML = "<p style='color:#aaa;'>é€™å€‹äººé‚„æ²’æœ‰ç™¼è¡¨æ–‡ç« </p>";
    return;
  }

  posts.forEach(data => {
  const div = document.createElement("div");
  div.className = "post-card";
  div.innerHTML = `
    <h3>${data.title}</h3>
    <small><i class="fas fa-clock"></i> ${timeAgo(data.createdAt?.toDate())}</small>
    <p>${data.content}</p>
    ${data.imageBase64 ? `<img src="${data.imageBase64}">` : ""}
  `;
  div.addEventListener("click", () => {
    window.location.href = "blog.html?post=" + data.id;
  });
  postsDiv.appendChild(div);
});
}
document.addEventListener("click", e => {
  if (e.target.tagName === "IMG" && e.target.closest(".post-content")) {
    const img = document.createElement("img");
    img.src = e.target.src;
    img.style = "position:fixed;top:0;left:0;width:100%;height:100%;object-fit:contain;background:rgba(0,0,0,0.9);z-index:2000;cursor:pointer;";
    img.onclick = () => img.remove();
    document.body.appendChild(img);
  }
});
function shareProfile(email) {
  const url = window.location.origin + window.location.pathname + "?profile=" + encodeURIComponent(email);
  navigator.clipboard.writeText(url).then(() => {
    alert("âœ… å·²è¤‡è£½å€‹äººæª”æ¡ˆé€£çµï¼");
  });
}

  </script>
</body>
</html>
