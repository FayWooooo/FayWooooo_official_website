<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>FayWooooo éƒ¨è½æ ¼</title>
  <link rel="icon" href="logo.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <style>
    body {
      background-image: linear-gradient(rgb(8, 19, 41), rgb(0, 0, 0));
      font-family: 'hanwangheiheavy', sans-serif;
      margin: 0; padding: 0;
      color: white;
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }
    .page { display: none; padding: 20px; }
    .page.active { display: block; }

    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: 60px; background: rgba(255,255,255,0.07);
      display: flex; justify-content: space-around; align-items: center;
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(255,255,255,0.2);
      z-index: 1000;
    }
    .bottom-nav a { color: #aaa; text-decoration: none; font-size: 22px; }
    .bottom-nav a.active { color: gold; }

    .post-card {
      background: rgba(255,255,255,0.07);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.5);
    }
    .post-header { display: flex; align-items: center; margin-bottom: 10px; }
    .avatar {
      width: 40px; height: 40px; border-radius: 50%;
      margin-right: 10px;
    }
    .post-header strong { font-size: 16px; }
    .post-actions { margin-top: 10px; }
    .post-actions button {
      background: none; border: none; color: #ccc;
      cursor: pointer; margin-right: 15px; font-size: 16px;
    }
    .post-actions button:hover { color: gold; }
    .comments { margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; }
    .comments p { margin: 5px 0; font-size: 14px; }
    .comments input { width: 70%; padding: 5px; border-radius: 5px; border: none; }
    .comments button { padding: 5px 10px; border: none; border-radius: 5px; background: gold; cursor: pointer; }

    .post-media {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <nav style="padding:10px;background:rgba(255,255,255,0.07);border-radius:15px;margin:10px;">
    <a href="index.html" style="color:white;margin-right:15px;text-decoration: none;">
      <i class="fas fa-home"></i> é¦–é 
    </a>
    <a href="exchange.html" style="color:white;margin-right:15px;text-decoration: none;">
      <i class="fas fa-coins"></i> Fayå¹£å…Œæ›
    </a>
    <a href="blog.html" style="color:gold;text-decoration: none;">
      <i class="fas fa-pen"></i> éƒ¨è½æ ¼
    </a>
  </nav>

  <!-- åˆ†é å…§å®¹ -->
  <div id="homePage" class="page active">
    <h2><i class="fas fa-home"></i> é¦–é </h2>
    <div id="homePosts"></div>
  </div>

  <div id="addPage" class="page">
    <h2><i class="fas fa-plus-square"></i> æ–°å¢è²¼æ–‡</h2>
    <div class="post-card">
      <input type="text" id="postTitle" placeholder="æ¨™é¡Œ"><br>
      <textarea id="postContent" rows="5" placeholder="å…§å®¹"></textarea><br>
      <label>ä¸Šå‚³åœ–ç‰‡ï¼š<input type="file" id="postImage" accept="image/*"></label><br>
      <label>ä¸Šå‚³å½±ç‰‡ï¼š<input type="file" id="postVideo" accept="video/*"></label><br>
      <label>ç•™è¨€ä¸Šé™(0~10000)ï¼š<input type="number" id="maxComments" value="10000" min="0" max="10000"></label><br>
      <button onclick="addBlogPost()">ç™¼è¡¨</button>
    </div>
  </div>
  
  <div id="explorePage" class="page">
    <h2><i class="fas fa-compass"></i> æ¢ç´¢</h2>
    <div id="explorePosts"></div>
  </div>

  <div id="profilePage" class="page">
    <h2><i class="fas fa-user"></i> å€‹äººé </h2>
    <p id="profileInfo"></p>
    <div id="profilePosts"></div>
  </div>

  <!-- åº•éƒ¨å°è¦½åˆ— -->
  <div class="bottom-nav">
    <a href="#" onclick="showPage('homePage', this)" class="active"><i class="fas fa-home"></i></a>
    <a href="#" onclick="showPage('addPage', this)"><i class="fas fa-plus-square"></i></a>
    <a href="#" onclick="showPage('explorePage', this)"><i class="fas fa-compass"></i></a>
    <a href="#" onclick="showPage('profilePage', this)"><i class="fas fa-user"></i></a>
  </div>

  <script>
    // Firebase åˆå§‹åŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyAw3NxfRft4pke6TUl9gQ4a8P0LEm30zWo",
      authDomain: "faycoin-bb878.firebaseapp.com",
      projectId: "faycoin-bb878",
      storageBucket: "faycoin-bb878.appspot.com",
      messagingSenderId: "665116400856",
      appId: "1:665116400856:web:a263d792c69129400d8bad"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const userEmail = localStorage.getItem("userEmail") || "guest@example.com";
    const userNickname = localStorage.getItem("nickname") || "åŒ¿å";
    const userAvatar = localStorage.getItem("avatarUrl") || "default-avatar.png";

    // ç›¸å°æ™‚é–“
    function timeAgo(date) {
      if (!date) return "";
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);
      if (diff < 60) return "å‰›å‰›";
      const mins = Math.floor(diff / 60);
      if (mins < 60) return mins + " åˆ†é˜å‰";
      const hours = Math.floor(mins / 60);
      if (hours < 24) return hours + " å°æ™‚å‰";
      const days = Math.floor(hours / 24);
      if (days < 7) return days + " å¤©å‰";
      const weeks = Math.floor(days / 7);
      if (weeks < 4) return weeks + " é€±å‰";
      const months = Math.floor(days / 30);
      if (months < 12) return months + " æœˆå‰";
      const years = Math.floor(days / 365);
      return years + " å¹´å‰";
    }

    // ä¸Šå‚³æª”æ¡ˆåˆ° Storage

async function uploadFile(file, folder) {
  const ref = storage.ref().child(`${folder}/${Date.now()}_${file.name}`);
  await ref.put(file);
  return await ref.getDownloadURL(); // ğŸ”¥ æ°¸ä¹…å…¬é–‹ç¶²å€
}



    // æ–°å¢è²¼æ–‡
    async function addBlogPost() {
  const title = document.getElementById("postTitle").value.trim();
  const content = document.getElementById("postContent").value.trim();
  const maxComments = parseInt(document.getElementById("maxComments").value) || 10000;

  let imageUrl = "";
  let videoUrl = "";

  const imageFile = document.getElementById("postImage").files[0];
  if (imageFile) {
    imageUrl = await uploadFile(imageFile, "images");
  }

  const videoFile = document.getElementById("postVideo").files[0];
  if (videoFile) {
    videoUrl = await uploadFile(videoFile, "videos");
  }

  // ğŸ” Debug: ç¢ºèªä¸Šå‚³çµæœ
  console.log("ğŸ“· åœ–ç‰‡ç¶²å€:", imageUrl);
  console.log("ğŸ¥ å½±ç‰‡ç¶²å€:", videoUrl);

  // æŠ“ä½¿ç”¨è€…è³‡æ–™
  const profileSnap = await db.collection("userProfiles").doc(userEmail).get();
  let nickname = "åŒ¿å", avatarUrl = "default-avatar.png";
  if (profileSnap.exists) {
    const p = profileSnap.data();
    nickname = p.nickname || nickname;
    avatarUrl = p.avatarUrl || avatarUrl;
  }

  await db.collection("blogPosts").add({
    userEmail,
    nickname,
    avatarUrl,
    title,
    content,
    imageUrl,
    videoUrl,
    maxComments,
    likes: 0,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(docRef => {
    alert("âœ… è²¼æ–‡å·²æˆåŠŸç™¼è¡¨ï¼");
    showPage("homePage", document.querySelector('.bottom-nav a')); 
    setTimeout(() => {
      const postEl = document.getElementById("post-" + docRef.id);
      if (postEl) postEl.scrollIntoView({ behavior: "smooth" });
    }, 800);
  });

  document.getElementById("postTitle").value = "";
  document.getElementById("postContent").value = "";
  document.getElementById("postImage").value = "";
  document.getElementById("postVideo").value = "";
}



    // æŒ‰è®š
    async function likePost(postId) {
      const ref = db.collection("blogPosts").doc(postId);
      await ref.update({ likes: firebase.firestore.FieldValue.increment(1) });
    }

    // åˆ†äº«
    function sharePost(postId) {
      const url = window.location.href + "?post=" + postId;
      navigator.clipboard.writeText(url).then(()=>{
        alert("å·²è¤‡è£½åˆ†äº«é€£çµï¼");
      });
    }

    // åˆªé™¤è²¼æ–‡
    async function deletePost(postId) {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç¯‡è²¼æ–‡å—ï¼Ÿ")) return;
      await db.collection("blogPosts").doc(postId).delete();
      alert("âœ… è²¼æ–‡å·²åˆªé™¤");
    }

    // ç•™è¨€åŠŸèƒ½
    async function loadComments(postId) {
      const commentsDiv = document.getElementById("comments-" + postId);
      commentsDiv.innerHTML = `
        <input type="text" id="commentInput-${postId}" placeholder="å¯«ç•™è¨€...">
        <button onclick="addComment('${postId}')">é€å‡º</button>
        <div id="commentList-${postId}"></div>
      `;
      const snapshot = await db.collection("blogPosts").doc(postId).collection("comments").orderBy("createdAt","asc").get();
      snapshot.forEach(doc=>{
        const data = doc.data();
        const c = document.createElement("div");
        c.innerHTML = `
          <strong>${data.nickname}</strong>ï¼š${data.text}
          <button onclick="likeComment('${postId}','${doc.id}')"><i class="fas fa-heart"></i> ${data.likes || 0}</button>
          <button onclick="replyComment('${postId}','${doc.id}')"><i class="fas fa-reply"></i> å›è¦†</button>
          ${(data.userEmail === userEmail) ? `<button onclick="deleteComment('${postId}','${doc.id}')"><i class="fas fa-trash"></i></button>` : ""}
        `;
        document.getElementById("commentList-"+postId).appendChild(c);
      });
    }

    async function addComment(postId) {
      const input = document.getElementById("commentInput-" + postId);
      const text = input.value.trim();
      if (!text) return;

      // æª¢æŸ¥ç•™è¨€æ•¸é‡
      const post = await db.collection("blogPosts").doc(postId).get();
      const comments = await db.collection("blogPosts").doc(postId).collection("comments").get();
      if (comments.size >= (post.data().maxComments || 10000)) {
        alert("ç•™è¨€æ•¸å·²é”ä¸Šé™");
        return;
      }

      await db.collection("blogPosts").doc(postId).collection("comments").add({
        userEmail,
        nickname: userNickname,
        text,
        likes: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      input.value = "";
      loadComments(postId);
    }

    async function likeComment(postId, commentId) {
      await db.collection("blogPosts").doc(postId).collection("comments").doc(commentId).update({
        likes: firebase.firestore.FieldValue.increment(1)
      });
    }

    async function deleteComment(postId, commentId) {
      if (!confirm("åˆªé™¤æ­¤ç•™è¨€ï¼Ÿ")) return;
      await db.collection("blogPosts").doc(postId).collection("comments").doc(commentId).delete();
      loadComments(postId);
    }

    async function replyComment(postId, commentId) {
      const reply = prompt("è¼¸å…¥å›è¦†å…§å®¹ï¼š");
      if (!reply) return;
      await db.collection("blogPosts").doc(postId).collection("comments").doc(commentId).collection("replies").add({
        userEmail,
        nickname: userNickname,
        text: reply,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    function toggleComments(postId) {
      const commentsDiv = document.getElementById("comments-" + postId);
      if (commentsDiv.style.display === "none") {
        commentsDiv.style.display = "block";
        loadComments(postId);
      } else {
        commentsDiv.style.display = "none";
      }
    }

    // é¦–é æ–‡ç« æµ
    db.collection("blogPosts").orderBy("createdAt","desc")
      .onSnapshot(snapshot => {
        const container = document.getElementById("homePosts");
        container.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.className = "post-card";
          div.id = "post-" + doc.id;
          div.innerHTML = `
            <div class="post-header">
              <img src="${data.avatarUrl}" class="avatar">
              <strong>${data.nickname}</strong>
            </div>
            <h3>${data.title}</h3>
            <small><i class="fas fa-clock"></i> ${timeAgo(data.createdAt?.toDate())}</small>
            <p>${data.content}</p>
            ${data.imageUrl ? `<img src="${data.imageUrl}" class="post-media">` : ""}
${data.videoUrl ? `<video src="${data.videoUrl}" controls class="post-media"></video>` : ""}
            <div class="post-actions">
              <button onclick="likePost('${doc.id}')"><i class="fas fa-thumbs-up"></i> ${data.likes || 0}</button>
              <button onclick="toggleComments('${doc.id}')"><i class="fas fa-comment"></i> ç•™è¨€</button>
              <button onclick="sharePost('${doc.id}')"><i class="fas fa-share"></i> åˆ†äº«</button>
              ${data.userEmail === userEmail ? `<button onclick="deletePost('${doc.id}')"><i class="fas fa-trash"></i> åˆªé™¤</button>` : ""}
            </div>
            <div class="comments" id="comments-${doc.id}" style="display:none;"></div>
          `;
          container.appendChild(div);
        });
      });

    // åˆ†é åˆ‡æ›
    function showPage(pageId, el) {
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      document.getElementById(pageId).classList.add("active");
      document.querySelectorAll(".bottom-nav a").forEach(a => a.classList.remove("active"));
      el.classList.add("active");
    }
  </script>
</body>
</html>
