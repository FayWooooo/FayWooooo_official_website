<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è§€çœ¾ç•™è¨€çµ¦æˆ‘ç© - FayWooooo</title>
  <link rel="icon" href="logo.ico" type="image/x-icon">
  <style>
    body {
      background: linear-gradient(#081329,#000);
      color: white; font-family: sans-serif;
      margin: 0; padding: 0; text-align: center;
    }
    .tabs { display: flex; justify-content: center; gap: 15px; padding: 20px; background: rgba(255,255,255,0.05);}
    .tab { padding: 10px 20px; border-radius: 8px; background: rgba(255,255,255,0.1); cursor: pointer; }
    .tab.active { background: gold; color: black; font-weight: bold; }
    .page { display: none; padding: 30px; }
    .page.active { display: block; }
    .form-container { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; max-width: 600px; margin: 0 auto; }
    input, textarea { width: 90%; padding: 10px; margin: 10px 0; border-radius: 8px; border: none; }
    button { background: gold; color: black; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>
  <h1 style="margin-top:20px;">ğŸ“ è§€çœ¾ç•™è¨€çµ¦æˆ‘ç©</h1>

  <div class="tabs">
    <div class="tab active" data-target="rules">æŠ•ç¨¿è¦å‰‡</div>
    <div class="tab" data-target="play">ç•™è¨€æŠ•ç¨¿</div>
  </div>

  <select id="eventSelect" style="width:90%;padding:10px;border-radius:8px;margin-top:15px;">
    <option value="">è¼‰å…¥ä¸­...</option>
  </select>

  <!-- æŠ•ç¨¿è¦å‰‡ -->
  <div class="page active" id="rules">
    <h2>æŠ•ç¨¿è¦å‰‡</h2>
    <p>ğŸ“Œ æ¯æ¬¡æŠ•ç¨¿æœƒæ‰£é™¤ 50 Fayå¹£ï¼Œè‹¥æœªè¢«æ¡ç”¨å°‡é€€å›<br>
       ğŸ“Œ æ¯å€‹æŒ‘æˆ°å¿…é ˆæ˜¯ä¸€å±€èƒ½å®Œæˆ,åªå¯è¦æ±‚å°å±€å…§çš„æŒ‘æˆ°<br>
       ğŸ“Œ è‹¥å˜—è©¦é4æ¬¡å¾Œç„¡æ³•æˆåŠŸæˆ‘æœƒé–‹å§‹æŠ•æ©Ÿå–å·§</p>
  </div>

  <!-- è§€çœ¾ç•™è¨€çµ¦æˆ‘ç© -->
  <div class="page" id="play">
    <h2>ç•™è¨€æŠ•ç¨¿</h2>
    <div class="form-container">
      <input type="text" id="playTitle" placeholder="æ¨™é¡Œ">
      <textarea id="playText" placeholder="ç•™è¨€å…§å®¹"></textarea>
      <button onclick="submitPost()">é€å‡ºç•™è¨€</button>
    </div>
  </div>

  <button style="margin-top:40px;" onclick="window.location.href='index.html'">å›é¦–é </button>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- ç®¡ç†å“¡æ§åˆ¶å° -->
  <div id="adminArea" style="display:none;padding:30px;background:rgba(255,255,255,0.05);margin-top:50px;">
    <h2 style="color:gold;">ç®¡ç†å“¡ï¼šæŠ•ç¨¿æ´»å‹•ç®¡ç†</h2>
    <input id="newEventName" placeholder="æ–°æ´»å‹•åç¨±">
    <button onclick="createSubmissionEvent()">å»ºç«‹æ´»å‹•</button>
    <div id="eventList"></div>

    <h3>å¯©æ ¸ç•™è¨€</h3>
    <div id="reviewList"></div>
  </div>

  <script>
        // ç¢ºä¿ç™»å…¥ç‹€æ…‹
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      window.location.href = 'index.html';
    }
    const firebaseConfig = {
      apiKey: "AIzaSyAw3NxfRft4pke6TUl9gQ4a8P0LEm30zWo",
      authDomain: "faycoin-bb878.firebaseapp.com",
      projectId: "faycoin-bb878",
      storageBucket: "faycoin-bb878.appspot.com",
      messagingSenderId: "665116400856",
      appId: "1:665116400856:web:a263d792c69129400d8bad"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const userEmail = localStorage.getItem('userEmail') || '';

    async function submitPost(){
      if(!userEmail){ alert('è«‹å…ˆç™»å…¥'); return; }

      const eventId = document.getElementById('eventSelect').value;
      if(!eventId){ alert('ç›®å‰æ²’æœ‰é–‹æ”¾çš„æŠ•ç¨¿æ´»å‹•'); return; }

      const title = document.getElementById('playTitle').value.trim();
      const text = document.getElementById('playText').value.trim();

      if(!title && !text){ alert('è«‹è¼¸å…¥å…§å®¹'); return; }

      // ç¢ºèª Fayå¹£
      const snap = await db.collection('userLoginRewards').where('userEmail','==',userEmail).get();
      if(snap.empty){ alert('æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™'); return; }
      const doc = snap.docs[0];
      let data = doc.data();
      let coins = data.coins || 0;
      if(coins < 50){ alert('âŒ Fayå¹£ä¸è¶³ï¼ˆéœ€è¦50ï¼‰'); return; }

      // æ‰£ 50 Fayå¹£
      coins -= 50;
      await db.collection('userLoginRewards').doc(doc.id).update({ coins });

      // å­˜é€² Firestore
      await db.collection('submissions').add({
        userEmail, type: 'play', eventId,
        title, text,
        status: 'pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      alert('âœ… ç•™è¨€å·²é€å‡ºï¼ˆå·²æ‰£50 Fayå¹£ï¼‰ï¼Œç­‰å¾…å¯©æ ¸');
    }

    document.querySelectorAll('.tab').forEach(t=>{
      t.onclick = ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById(t.dataset.target).classList.add('active');
      };
    });

    const adminEmails = ["faywooooo@gmail.com"];
    if(adminEmails.includes(userEmail)) {
      document.getElementById('adminArea').style.display = 'block';
    }

    async function createSubmissionEvent(){
      const name = document.getElementById('newEventName').value.trim();
      if(!name) return;
      await db.collection('submissionEvents').add({
        name, isOpen:true, createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      loadEvents();
    }

    async function loadEvents(){
      const list = document.getElementById('eventList');
      const snap = await db.collection('submissionEvents').orderBy('createdAt','desc').get();
      list.innerHTML='';
      snap.forEach(doc=>{
        const d = doc.data();
        const div = document.createElement('div');
        div.style.margin = '8px 0';
        div.innerHTML = `
          <b>${d.name}</b>ï¼ˆ${d.isOpen?'é–‹æ”¾ä¸­':'å·²é—œé–‰'}ï¼‰
          <button onclick="toggleEvent('${doc.id}',${!d.isOpen})">${d.isOpen?'é—œé–‰':'é–‹æ”¾'}</button>
          <button style="background:#e74c3c;color:white;" onclick="deleteEvent('${doc.id}')">åˆªé™¤</button>
        `;
        list.appendChild(div);
      });
    }

    async function loadOpenEvents(){
      const sel = document.getElementById('eventSelect');
      const snap = await db.collection('submissionEvents').where('isOpen','==',true).get();
      sel.innerHTML = '';
      if(snap.empty){
        sel.innerHTML = '<option value="">ç›®å‰ç„¡é–‹æ”¾æ´»å‹•</option>';
        return;
      }
      snap.forEach(d=>{
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = d.data().name;
        sel.appendChild(opt);
      });
    }

    async function toggleEvent(id,val){
      await db.collection('submissionEvents').doc(id).update({isOpen:val});
      loadEvents(); loadOpenEvents();
    }

    async function deleteEvent(id){
      if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ´»å‹•å—ï¼Ÿ\nï¼ˆä¸æœƒåˆªé™¤ç•™è¨€å…§å®¹ï¼‰')) return;
      await db.collection('submissionEvents').doc(id).delete();
      loadEvents(); loadOpenEvents();
    }

    async function loadPending(){
      const list = document.getElementById('reviewList');
      const snap = await db.collection('submissions').where('status','==','pending').get();
      list.innerHTML='';
      snap.forEach(doc=>{
        const d = doc.data();
        const div = document.createElement('div');
        div.style.margin='15px 0';
        div.style.background='rgba(255,255,255,0.05)';
        div.style.padding='10px';
        div.style.borderRadius='8px';

        div.innerHTML = `
          <b>${d.title || 'ç„¡æ¨™é¡Œ'}</b> (${d.userEmail})
          <br>
          <button onclick="approve('${doc.id}')">æ¡ç”¨</button>
          <button onclick="reject('${doc.id}','${d.userEmail}')">æœªæ¡ç”¨é€€å¹£</button>
          <p>${d.text || ''}</p>
        `;

        list.appendChild(div);
      });
    }

    async function approve(id){
      await db.collection('submissions').doc(id).update({status:'accepted'});
      loadPending();
    }

    async function reject(id,email){
      await db.collection('submissions').doc(id).update({status:'rejected'});
      const snap = await db.collection('userLoginRewards').where('userEmail','==',email).get();
      if(!snap.empty){
        const doc = snap.docs[0];
        let coins = doc.data().coins||0;
        coins += 50;
        await db.collection('userLoginRewards').doc(doc.id).update({coins});
      }
      loadPending();
    }

    loadEvents();
    loadPending();
    loadOpenEvents();
  </script>
</body>
</html>
