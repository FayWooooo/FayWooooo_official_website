<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Fay 通行券 - FayWooooo</title>
  <link rel="icon" href="logo.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
        @font-face {
    font-family: 'hanwangheiheavy';
    src: url('https://www.moedict.tw/fonts/truetype/wang/wt014.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
  }
    body {
      background: linear-gradient(135deg, #1a0033, #000);
      font-family: 'hanwangheiheavy', sans-serif;
      color: white;
      margin: 0;
      padding: 0;
    }
    h1 { text-align: center; font-size: 42px; padding: 20px; color: gold; }
    .progress-bar { margin: 20px; height: 20px; background: #333; border-radius: 10px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, gold, orange); width: 0%; transition: width 0.5s ease; }
    .pass-grid {
      user-select: none;
      display: flex;
      overflow-x: auto;
      gap: 15px;
      padding: 20px;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    .tier-card {
      flex: 0 0 calc(20% - 15px);
      min-width: 200px; max-width: 220px;
      background: rgba(255,255,255,0.08);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 12px; padding: 12px;
      text-align: center; transition: transform 0.3s ease;
    }
    .tier-card:hover { transform: scale(1.05); }
    .tier-level { font-size: 20px; font-weight: bold; margin-bottom: 8px; }
    .reward { border-radius: 8px; padding: 8px; margin: 5px 0; }
    .reward.free { border: 1px solid lightblue; }
    .reward.premium { border: 1px solid gold; }
    .locked { opacity: 0.4; }
    .unlocked { outline: 2px solid gold; }
    button {
      margin: 5px;
      background: gold;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
    }
    #adminPanel {
      display: none; margin: 30px auto; padding: 20px;
      background: rgba(255,255,255,0.08);
      border-radius: 12px; max-width: 600px;
    }
    #adminPanel h2 { color: #ffcc00; margin-bottom: 15px; }
    .admin-info { background: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px; margin-bottom: 15px; }
    .admin-actions button { background: dodgerblue; }
    #userData { text-align: left; white-space: pre-wrap; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>🎟 Fay 通行券</h1>
  <div id="musicPanel" style="display:none; background:rgba(0,0,0,0.8); padding:20px; border-radius:12px; max-width:500px; margin:20px auto;">
    <h2>🎵 音樂選擇</h2>
    <table border="1" cellpadding="6" style="width:100%; color:white; border-collapse:collapse;">
      <thead><tr><th>名稱</th><th>類型</th><th>操作</th></tr></thead>
      <tbody id="musicTable"></tbody>
    </table>
    <br>
    <button onclick="saveMusic()">✔ 保存選擇</button>
    <button onclick="document.getElementById('musicPanel').style.display='none'">關閉</button>
  </div>
  
  <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
  <p style="text-align:center;">目前進度：<span id="progress">0</span>/<span id="maxProgress">100</span></p>
  <p style="text-align:center;">剩餘 Fay幣：<span class="fay-balance">0</span></p>

  <div style="text-align:center; margin:15px;">
    <button onclick="buyPremium()">購買高級通行券 (3000Fay幣)</button>
    <button onclick="window.location.href='exchange.html'">回兌換區</button>
    <button onclick="openMusicPanel()">🎵 選擇音樂</button>
  </div>
  <h1 style="color:white">第1季 Fay幣的家</h1>

  <div class="pass-grid" id="passWrapper"></div>
  <audio id="bgMusic" loop autoplay style="display:none"></audio>

  <div id="adminPanel">
    <h2>🛠 通行券後台控制</h2>
    <div class="admin-info">
      <input id="targetEmail" placeholder="輸入用戶 Email"><br>
      <label><input type="checkbox" id="targetPremium"> 已購買高級通行券</label>
    </div>
    <div class="admin-actions">
      <button onclick="changeProgress(10)">+10 等級</button>
      <button onclick="changeProgress(-10)">-10 等級</button>
      <button onclick="resetProgress()">歸零</button>
    </div>
    <pre id="userData"></pre>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAw3NxfRft4pke6TUl9gQ4a8P0LEm30zWo",
      authDomain: "faycoin-bb878.firebaseapp.com",
      projectId: "faycoin-bb878",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  
    const email = (localStorage.getItem("userEmail") || "").toLowerCase();
    let progress = 0, maxProgress = 100, userPremium = false, claimed = {};
const totalProgress = 5000; //
  
    const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIfrpA8wZL8LPLOjfmQqX7Q4CIu5a019qRBZwLMfJtjW3J_RBlB2LLlPDOcBXUG-Nz-B5y7n2ionnk/pub?output=csv";
  
    // 即時監聽通行券
function listenUser() {
    if (!email) {
      console.warn("未登入用戶，仍然載入通行券展示");
      loadCSVRewards();
      return;
    }
  
    db.collection("battlePass").doc(email).onSnapshot(async snapshot => {
      if (snapshot.exists) {
        progress = snapshot.data().progress || 0;
        userPremium = snapshot.data().premium || false;
        claimed = snapshot.data().claimed || {};
      } else {
        const userRef = db.collection("users").doc(email);
        const userDoc = await userRef.get();
        let coins = (userDoc.exists ? (userDoc.data().fayCoins || 0) : 0);
  
        await db.collection("battlePass").doc(email).set({
          progress: 0,
          premium: false,
          claimed: {}
        }, { merge: true });
  
        progress = 0;
        userPremium = false;
        claimed = {};
      }
  
      updateUI();
      loadCSVRewards();
  
      // 🔒 如果已經買過，馬上把按鈕鎖定
      const btn = document.querySelector("button[onclick='buyPremium()']");
      if (btn && userPremium) {
        btn.innerText = "已購買高級通行券";
        btn.disabled = true;
      }
    });
  }
  

// Fay幣顯示 (統一跟 exchange.html 一樣，用 userLoginRewards)
function listenBalance() {
  const email = localStorage.getItem('userEmail');
  if (!email) return;

  db.collection('userLoginRewards')
    .where('userEmail', '==', email)
    .onSnapshot(snapshot => {
      if (!snapshot.empty) {
        const coins = snapshot.docs[0].data().coins || 0;

        // 更新顯示與 localStorage
        localStorage.setItem(`fayCoins_${email}`, coins);
        localStorage.setItem('fayCoinBalance', coins.toString());
        document.querySelectorAll('.fay-balance').forEach(el => {
          el.innerText = coins;
        });

        // 廣播事件，通知其他頁面
        window.dispatchEvent(new CustomEvent('fayCoinChanged', {
          detail: { newBalance: coins }
        }));
      }
    });
}

// 監聽其他頁面同步事件
window.addEventListener('fayCoinChanged', (event) => {
  const newBalance = event.detail.newBalance;
  document.querySelectorAll('.fay-balance').forEach(el => {
    el.innerText = newBalance;
  });
});

  
    // 渲染通行券
    function renderPass(rewards) {
    const wrapper = document.getElementById("passWrapper");
    wrapper.innerHTML = "";
    rewards.forEach(r => {
      if (!r.等級) return;
      const level = r.等級;
      const freeKey = `${level}_free`;
      const premiumKey = `${level}_premium`;
      const need = parseInt(r.門檻) || 0;

      let extraReward = "";


      const div = document.createElement("div");
      div.className = "tier-card " + (progress >= need ? "unlocked" : "locked");
      div.innerHTML = `
        <div class="tier-level">Lv.${level}</div>
        <div class="reward free">免費：${r.免費獎勵}
          <button onclick="claimReward('${freeKey}', '${level}')" ${progress < need || (claimed[freeKey]||false) ? 'disabled' : ''}>
            ${claimed[freeKey] ? '已領取' : '領取'}
          </button>
        </div>
        <div class="reward premium ${userPremium ? '' : 'locked'}">
          高級：${r.付費獎勵}
          <button onclick="claimReward('${premiumKey}', '${level}')" ${progress < need || !userPremium || (claimed[premiumKey]||false) ? 'disabled' : ''}>
            ${claimed[premiumKey] ? '已領取' : (userPremium ? '領取' : '需購買')}
          </button>
        </div>
        ${extraReward}
        <div style="font-size:12px;color:#aaa;">需求：${r.門檻} EXP</div>`;
      wrapper.appendChild(div);
    });
  }
  
let lastCSVRewards = [];

function loadCSVRewards() {
  Papa.parse(csvURL, { 
    download: true, 
    header: true, 
    complete: res => {
      console.log("[loadCSVRewards] rewards =", res.data);
      lastCSVRewards = res.data;   // 存起來
      renderPass(res.data);
    } 
  });
}

  
function updateUI() {
    console.log("[updateUI] progress =", progress, "totalProgress =", totalProgress);
    document.getElementById("progress").innerText = progress;
    document.getElementById("maxProgress").innerText = totalProgress;
  
    let percent = (progress / totalProgress) * 100;
    if (percent > 100) percent = 100;
    document.getElementById("progressFill").style.width = percent + "%";
  }
  
  
async function buyPremium() {
    if (!email) return;
  
    const passRef = db.collection("battlePass").doc(email);
    const passDoc = await passRef.get();
  
    // 🔒 檢查是否已經購買過
    if (passDoc.exists && passDoc.data().premium) {
      alert("你已經購買過高級通行券了！");
      return;
    }
  
    const snapshot = await db.collection('userLoginRewards')
      .where('userEmail', '==', email)
      .get();
  
    if (snapshot.empty) return alert("找不到帳號資料");
  
    const docRef = snapshot.docs[0].ref;
    let coins = snapshot.docs[0].data().coins || 0;
  
    if (coins < 3000) return alert("需要 3000 Fay幣！");
  
    // 扣款
    await docRef.update({ coins: coins - 3000 });
  
    // battlePass 加 premium + 送進度
    let newProgress = (passDoc.exists ? (passDoc.data().progress || 0) : 0) + 500;
    if (newProgress > totalProgress) newProgress = totalProgress;
  
    await passRef.set({
      premium: true,
      progress: newProgress
    }, { merge: true });
  
    alert("成功購買高級通行券！已加 500 階");
  
    // 更新 UI
    userPremium = true;
    progress = newProgress;
    updateUI();
  
    const btn = document.querySelector("button[onclick='buyPremium()']");
    if (btn) {
      btn.innerText = "已購買";
      btn.disabled = true;
    }
  }
  
  
  
  
  const musicLevels = [3,13,23,33,43,53,63];  // 官方音樂解鎖等級
const customMusicLevels = [73,83,93];                // 自訂音樂等級


  
async function claimReward(key, level) {
  if (!email) return;
  if (claimed[key]) return alert("已領取過！");
  const lv = parseInt(level);

  // 找到該等級對應的獎勵內容
  const rewardRow = lastCSVRewards.find(r => r.等級 == level);
  if (!rewardRow) return alert("找不到該等級獎勵");

  let rewardText = key.includes("free") ? rewardRow.免費獎勵 : rewardRow.付費獎勵;
  console.log("[claimReward] 領取 =", rewardText);

  // 發 Fay幣或寶箱
  const snapshot = await db.collection('userLoginRewards')
    .where('userEmail', '==', email)
    .get();

  if (!snapshot.empty) {
    const docRef = snapshot.docs[0].ref;
    let coins = snapshot.docs[0].data().coins || 0;

    if (rewardText.includes("Fay幣")) {
      // 例如「100 Fay幣」
      let num = parseInt(rewardText.replace(/[^0-9]/g, "")) || 0;
      await docRef.update({ coins: coins + num });
    } else if (rewardText.includes("普通寶箱")) {
  const current = snapshot.docs[0].data().normalChests || 0;
  await docRef.update({ normalChests: current + 1 });
} else if (rewardText.includes("高級寶箱")) {
  const current = snapshot.docs[0].data().chests || 0;
  await docRef.update({ chests: current + 1 });
}
else if (rewardText.includes("稱號") || rewardText.includes("桌布")) {
  const userEmail = localStorage.getItem("userEmail");
  if (userEmail && userEmail !== "faywooooo@gmail.com") {
    sendRewardEmail(
      userEmail,
      rewardText,
      "template_7r9kdt9",   // ✅ 改用寶箱的模板
      "通行券獎勵"
    );
  } else {
    console.warn("❌ 測試帳號被排除，未寄送 Email");
  }
}


  }

  // 標記為已領取
  claimed[key] = true;
  await db.collection("battlePass").doc(email).set({ claimed: claimed }, { merge: true });

  alert("🎁 成功領取：" + rewardText);
  loadCSVRewards();
  
}

  
async function changeProgress(delta) {
    const targetEmail = document.getElementById("targetEmail").value.trim();
    if (!targetEmail) return;
  
    const doc = await db.collection("battlePass").doc(targetEmail).get();
    let currentProgress = (doc.exists ? (doc.data().progress || 0) : 0);
  
    // ✅ 從目前階級加減
    let newProgress = currentProgress + delta;
  
    if (newProgress < 0) newProgress = 0;
    if (newProgress > totalProgress) newProgress = totalProgress;
  
    console.log("[changeProgress] 目前 =", currentProgress, "→ 新進度 =", newProgress);
  
    await db.collection("battlePass").doc(targetEmail).set({
      progress: newProgress
    }, { merge: true });
  }
  
  
    async function resetProgress() {
      const targetEmail = document.getElementById("targetEmail").value.trim();
      if (!targetEmail) return;
      console.log("[resetProgress] 重置", targetEmail);
      await db.collection("battlePass").doc(targetEmail).set({ progress: 0, claimed: {} }, { merge: true });
      alert("已重置！");
    }
  
    function loadUser(targetEmail) {
      db.collection("battlePass").doc(targetEmail).onSnapshot(doc => {
        console.log("[loadUser]", doc.data());
        document.getElementById("userData").innerText = doc.exists ? JSON.stringify(doc.data(), null, 2) : "查無資料";
        if (doc.exists) document.getElementById("targetPremium").checked = doc.data().premium || false;
      });
    }
    function openMusicPanel() {
  buildMusicTable();
  document.getElementById('musicPanel').style.display = 'block';
}

function buildMusicTable() {
    const tbody = document.getElementById("musicTable");
    tbody.innerHTML = "";
  
    if (!userPremium) {
      tbody.innerHTML = `<tr><td colspan="3">❌ 需要購買高級通行證才能解鎖音樂</td></tr>`;
      return;
    }
  
    // 官方音樂：必須 premium + 等級已達成 + 已領取
    Object.entries(officialMusic).forEach(([lv, url]) => {
      const key = `${lv}_premium`; // premium 獎勵的 key
      if (progress >= lv && claimed[key]) {
        tbody.innerHTML += `
          <tr>
            <td>官方音樂 Lv.${lv}</td>
            <td>官方</td>
            <td><input type="radio" name="musicSelect" value="${url}"></td>
          </tr>`;
      }
    });
  
    // 自訂音樂：同樣 premium + 等級已達成 + 已領取
    customMusicLevels.forEach(lv => {
      const key = `${lv}_premium`;
      if (progress >= lv && claimed[key]) {
        tbody.innerHTML += `
          <tr>
            <td>自訂背景音樂 Lv.${lv}</td>
            <td>自訂</td>
            <td><input type="radio" name="musicSelect" value="custom_${lv}"></td>
          </tr>`;
      }
    });
  
    if (!tbody.innerHTML) {
      tbody.innerHTML = `<tr><td colspan="3">🔒 尚未解鎖任何音樂</td></tr>`;
    }
  }
  

    const officialMusic = {
  3: "/music/BS_Subway_Surfer.mp3",
  13: "/music/Nothing Beats a Jet2holiday Sale Family TV advert.mp3",
  23: "/music/Rick Astley - Never Gonna Give You Up (Official Video) (4K Remaster).mp3",
  33: "/music/𝙉𝘼𝙆𝘼𝙈𝘼 & 𝙈𝘾 𝙇𝙔𝘾4𝙉 - 𝙍𝘼𝙅𝘼𝘿𝘼 (𝙐𝙇𝙏𝙍𝘼 𝙎𝙇𝙊𝙒𝙀𝘿 + 𝙍𝙀𝙑𝙀𝙍𝘽).mp3",
  43: "/music/CANTO DE LUNA ULTRA SLOWED.mp3",
  53: "/music/Montagem Bandido Slowed.mp3",
  63: "/music/W&W - OIIA OIIA (Spinning Cat).mp3",
  73: "/music/song8.mp3",
  83: "/music/song9.mp3",
  93: "/music/song10.mp3"
};
function saveMusic() {
  const choice = document.querySelector("input[name='musicSelect']:checked");
  if (!choice) return alert("請先選擇一首音樂");
  const url = choice.value;

  // 播放音樂
  const player = document.getElementById("bgMusic");
  if (url.startsWith("custom_")) {
    // 自訂音樂可讓玩家輸入網址或上傳
    alert("這裡可以做自訂音樂上傳/輸入網址的功能");
  } else {
    player.src = url;
    player.play();
  }

  document.getElementById("musicPanel").style.display = "none";
}

    // 初始化
    listenUser();
    listenBalance();
    if (email === "faywooooo@gmail.com") {
      document.getElementById("adminPanel").style.display = "block";
      document.getElementById("targetEmail").value = email;
      loadUser(email);
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    emailjs.init("Rna6NHThG_VW9eyRE"); // ⚠️ 換成你的 Public Key
  
    function sendRewardEmail(userEmail, rewardName, templateId, source) {
      const templateParams = {
        user: userEmail || "未知玩家",
        reward: rewardName,
        time: new Date().toLocaleString(),
        source: source || "通行券" // 額外參數方便辨識
      };
  
      emailjs.send("service_g83kh8j", templateId, templateParams)
        .then(res => console.log("✅ Email 發送成功:", res))
        .catch(err => console.error("❌ Email 發送失敗:", err));
    }
    // 🔒 限制非管理員用戶操作
(function() {
  const userEmail = (localStorage.getItem("userEmail") || "").toLowerCase();
  if (userEmail !== "faywooooo@gmail.com") {

    // 禁止右鍵
    document.addEventListener("contextmenu", e => e.preventDefault());

    // 禁止 F12、Ctrl+U、Ctrl+S
    document.addEventListener("keydown", e => {
      // F12
      if (e.key === "F12") {
        e.preventDefault();
        e.stopPropagation();
      }
      // Ctrl + U / S
      if (e.ctrlKey && (e.key.toLowerCase() === "u" || e.key.toLowerCase() === "s")) {
        e.preventDefault();
        e.stopPropagation();
      }
    }, true);
  }
})();

  </script>
  
</body>
</html>
