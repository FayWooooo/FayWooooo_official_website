<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Fay é€šè¡Œåˆ¸ - FayWooooo</title>
  <link rel="icon" href="logo.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
        @font-face {
    font-family: 'hanwangheiheavy';
    src: url('https://www.moedict.tw/fonts/truetype/wang/wt014.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
  }
    body {
      background: linear-gradient(135deg, #1a0033, #000);
      font-family: 'hanwangheiheavy', sans-serif;
      color: white;
      margin: 0;
      padding: 0;
    }
    h1 { text-align: center; font-size: 42px; padding: 20px; color: gold; }
    .progress-bar { margin: 20px; height: 20px; background: #333; border-radius: 10px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, gold, orange); width: 0%; transition: width 0.5s ease; }
    .pass-grid {
      user-select: none;
      display: flex;
      overflow-x: auto;
      gap: 15px;
      padding: 20px;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    .tier-card {
      flex: 0 0 calc(20% - 15px);
      min-width: 200px; max-width: 220px;
      background: rgba(255,255,255,0.08);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 12px; padding: 12px;
      text-align: center; transition: transform 0.3s ease;
    }
    .tier-card:hover { transform: scale(1.05); }
    .tier-level { font-size: 20px; font-weight: bold; margin-bottom: 8px; }
    .reward { border-radius: 8px; padding: 8px; margin: 5px 0; }
    .reward.free { border: 1px solid lightblue; }
    .reward.premium { border: 1px solid gold; }
    .locked { opacity: 0.4; }
    .unlocked { outline: 2px solid gold; }
    button {
      margin: 5px;
      background: gold;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
    }
    #adminPanel {
      display: none; margin: 30px auto; padding: 20px;
      background: rgba(255,255,255,0.08);
      border-radius: 12px; max-width: 600px;
    }
    #adminPanel h2 { color: #ffcc00; margin-bottom: 15px; }
    .admin-info { background: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px; margin-bottom: 15px; }
    .admin-actions button { background: dodgerblue; }
    #userData { text-align: left; white-space: pre-wrap; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>ğŸŸ Fay é€šè¡Œåˆ¸</h1>
  <div id="musicPanel" style="display:none; background:rgba(0,0,0,0.8); padding:20px; border-radius:12px; max-width:500px; margin:20px auto;">
    <h2>ğŸµ éŸ³æ¨‚é¸æ“‡</h2>
    <table border="1" cellpadding="6" style="width:100%; color:white; border-collapse:collapse;">
      <thead><tr><th>åç¨±</th><th>é¡å‹</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="musicTable"></tbody>
    </table>
    <br>
    <button onclick="saveMusic()">âœ” ä¿å­˜é¸æ“‡</button>
    <button onclick="document.getElementById('musicPanel').style.display='none'">é—œé–‰</button>
  </div>
  
  <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
  <p style="text-align:center;">ç›®å‰é€²åº¦ï¼š<span id="progress">0</span>/<span id="maxProgress">100</span></p>
  <p style="text-align:center;">å‰©é¤˜ Fayå¹£ï¼š<span class="fay-balance">0</span></p>

  <div style="text-align:center; margin:15px;">
    <button onclick="buyPremium()">è³¼è²·é«˜ç´šé€šè¡Œåˆ¸ (3000Fayå¹£)</button>
    <button onclick="window.location.href='exchange.html'">å›å…Œæ›å€</button>
    <button onclick="openMusicPanel()">ğŸµ é¸æ“‡éŸ³æ¨‚</button>
  </div>
  <h1 style="color:white">ç¬¬1å­£ Fayå¹£çš„å®¶</h1>

  <div class="pass-grid" id="passWrapper"></div>
  <audio id="bgMusic" loop autoplay style="display:none"></audio>

  <div id="adminPanel">
    <h2>ğŸ›  é€šè¡Œåˆ¸å¾Œå°æ§åˆ¶</h2>
    <div class="admin-info">
      <input id="targetEmail" placeholder="è¼¸å…¥ç”¨æˆ¶ Email"><br>
      <label><input type="checkbox" id="targetPremium"> å·²è³¼è²·é«˜ç´šé€šè¡Œåˆ¸</label>
    </div>
    <div class="admin-actions">
      <button onclick="changeProgress(10)">+10 ç­‰ç´š</button>
      <button onclick="changeProgress(-10)">-10 ç­‰ç´š</button>
      <button onclick="resetProgress()">æ­¸é›¶</button>
    </div>
    <pre id="userData"></pre>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAw3NxfRft4pke6TUl9gQ4a8P0LEm30zWo",
      authDomain: "faycoin-bb878.firebaseapp.com",
      projectId: "faycoin-bb878",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  
    const email = (localStorage.getItem("userEmail") || "").toLowerCase();
    let progress = 0, maxProgress = 100, userPremium = false, claimed = {};
const totalProgress = 5000; //
  
    const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIfrpA8wZL8LPLOjfmQqX7Q4CIu5a019qRBZwLMfJtjW3J_RBlB2LLlPDOcBXUG-Nz-B5y7n2ionnk/pub?output=csv";
  
    // å³æ™‚ç›£è½é€šè¡Œåˆ¸
function listenUser() {
    if (!email) {
      console.warn("æœªç™»å…¥ç”¨æˆ¶ï¼Œä»ç„¶è¼‰å…¥é€šè¡Œåˆ¸å±•ç¤º");
      loadCSVRewards();
      return;
    }
  
    db.collection("battlePass").doc(email).onSnapshot(async snapshot => {
      if (snapshot.exists) {
        progress = snapshot.data().progress || 0;
        userPremium = snapshot.data().premium || false;
        claimed = snapshot.data().claimed || {};
      } else {
        const userRef = db.collection("users").doc(email);
        const userDoc = await userRef.get();
        let coins = (userDoc.exists ? (userDoc.data().fayCoins || 0) : 0);
  
        await db.collection("battlePass").doc(email).set({
          progress: 0,
          premium: false,
          claimed: {}
        }, { merge: true });
  
        progress = 0;
        userPremium = false;
        claimed = {};
      }
  
      updateUI();
      loadCSVRewards();
  
      // ğŸ”’ å¦‚æœå·²ç¶“è²·éï¼Œé¦¬ä¸ŠæŠŠæŒ‰éˆ•é–å®š
      const btn = document.querySelector("button[onclick='buyPremium()']");
      if (btn && userPremium) {
        btn.innerText = "å·²è³¼è²·é«˜ç´šé€šè¡Œåˆ¸";
        btn.disabled = true;
      }
    });
  }
  

// Fayå¹£é¡¯ç¤º (çµ±ä¸€è·Ÿ exchange.html ä¸€æ¨£ï¼Œç”¨ userLoginRewards)
function listenBalance() {
  const email = localStorage.getItem('userEmail');
  if (!email) return;

  db.collection('userLoginRewards')
    .where('userEmail', '==', email)
    .onSnapshot(snapshot => {
      if (!snapshot.empty) {
        const coins = snapshot.docs[0].data().coins || 0;

        // æ›´æ–°é¡¯ç¤ºèˆ‡ localStorage
        localStorage.setItem(`fayCoins_${email}`, coins);
        localStorage.setItem('fayCoinBalance', coins.toString());
        document.querySelectorAll('.fay-balance').forEach(el => {
          el.innerText = coins;
        });

        // å»£æ’­äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–é é¢
        window.dispatchEvent(new CustomEvent('fayCoinChanged', {
          detail: { newBalance: coins }
        }));
      }
    });
}

// ç›£è½å…¶ä»–é é¢åŒæ­¥äº‹ä»¶
window.addEventListener('fayCoinChanged', (event) => {
  const newBalance = event.detail.newBalance;
  document.querySelectorAll('.fay-balance').forEach(el => {
    el.innerText = newBalance;
  });
});

  
    // æ¸²æŸ“é€šè¡Œåˆ¸
    function renderPass(rewards) {
    const wrapper = document.getElementById("passWrapper");
    wrapper.innerHTML = "";
    rewards.forEach(r => {
      if (!r.ç­‰ç´š) return;
      const level = r.ç­‰ç´š;
      const freeKey = `${level}_free`;
      const premiumKey = `${level}_premium`;
      const need = parseInt(r.é–€æª») || 0;

      let extraReward = "";


      const div = document.createElement("div");
      div.className = "tier-card " + (progress >= need ? "unlocked" : "locked");
      div.innerHTML = `
        <div class="tier-level">Lv.${level}</div>
        <div class="reward free">å…è²»ï¼š${r.å…è²»çå‹µ}
          <button onclick="claimReward('${freeKey}', '${level}')" ${progress < need || (claimed[freeKey]||false) ? 'disabled' : ''}>
            ${claimed[freeKey] ? 'å·²é ˜å–' : 'é ˜å–'}
          </button>
        </div>
        <div class="reward premium ${userPremium ? '' : 'locked'}">
          é«˜ç´šï¼š${r.ä»˜è²»çå‹µ}
          <button onclick="claimReward('${premiumKey}', '${level}')" ${progress < need || !userPremium || (claimed[premiumKey]||false) ? 'disabled' : ''}>
            ${claimed[premiumKey] ? 'å·²é ˜å–' : (userPremium ? 'é ˜å–' : 'éœ€è³¼è²·')}
          </button>
        </div>
        ${extraReward}
        <div style="font-size:12px;color:#aaa;">éœ€æ±‚ï¼š${r.é–€æª»} EXP</div>`;
      wrapper.appendChild(div);
    });
  }
  
let lastCSVRewards = [];

function loadCSVRewards() {
  Papa.parse(csvURL, { 
    download: true, 
    header: true, 
    complete: res => {
      console.log("[loadCSVRewards] rewards =", res.data);
      lastCSVRewards = res.data;   // å­˜èµ·ä¾†
      renderPass(res.data);
    } 
  });
}

  
function updateUI() {
    console.log("[updateUI] progress =", progress, "totalProgress =", totalProgress);
    document.getElementById("progress").innerText = progress;
    document.getElementById("maxProgress").innerText = totalProgress;
  
    let percent = (progress / totalProgress) * 100;
    if (percent > 100) percent = 100;
    document.getElementById("progressFill").style.width = percent + "%";
  }
  
  
async function buyPremium() {
    if (!email) return;
  
    const passRef = db.collection("battlePass").doc(email);
    const passDoc = await passRef.get();
  
    // ğŸ”’ æª¢æŸ¥æ˜¯å¦å·²ç¶“è³¼è²·é
    if (passDoc.exists && passDoc.data().premium) {
      alert("ä½ å·²ç¶“è³¼è²·éé«˜ç´šé€šè¡Œåˆ¸äº†ï¼");
      return;
    }
  
    const snapshot = await db.collection('userLoginRewards')
      .where('userEmail', '==', email)
      .get();
  
    if (snapshot.empty) return alert("æ‰¾ä¸åˆ°å¸³è™Ÿè³‡æ–™");
  
    const docRef = snapshot.docs[0].ref;
    let coins = snapshot.docs[0].data().coins || 0;
  
    if (coins < 3000) return alert("éœ€è¦ 3000 Fayå¹£ï¼");
  
    // æ‰£æ¬¾
    await docRef.update({ coins: coins - 3000 });
  
    // battlePass åŠ  premium + é€é€²åº¦
    let newProgress = (passDoc.exists ? (passDoc.data().progress || 0) : 0) + 500;
    if (newProgress > totalProgress) newProgress = totalProgress;
  
    await passRef.set({
      premium: true,
      progress: newProgress
    }, { merge: true });
  
    alert("æˆåŠŸè³¼è²·é«˜ç´šé€šè¡Œåˆ¸ï¼å·²åŠ  500 éš");
  
    // æ›´æ–° UI
    userPremium = true;
    progress = newProgress;
    updateUI();
  
    const btn = document.querySelector("button[onclick='buyPremium()']");
    if (btn) {
      btn.innerText = "å·²è³¼è²·";
      btn.disabled = true;
    }
  }
  
  
  
  
  const musicLevels = [3,13,23,33,43,53,63];  // å®˜æ–¹éŸ³æ¨‚è§£é–ç­‰ç´š
const customMusicLevels = [73,83,93];                // è‡ªè¨‚éŸ³æ¨‚ç­‰ç´š


  
async function claimReward(key, level) {
  if (!email) return;
  if (claimed[key]) return alert("å·²é ˜å–éï¼");
  const lv = parseInt(level);

  // æ‰¾åˆ°è©²ç­‰ç´šå°æ‡‰çš„çå‹µå…§å®¹
  const rewardRow = lastCSVRewards.find(r => r.ç­‰ç´š == level);
  if (!rewardRow) return alert("æ‰¾ä¸åˆ°è©²ç­‰ç´šçå‹µ");

  let rewardText = key.includes("free") ? rewardRow.å…è²»çå‹µ : rewardRow.ä»˜è²»çå‹µ;
  console.log("[claimReward] é ˜å– =", rewardText);

  // ç™¼ Fayå¹£æˆ–å¯¶ç®±
  const snapshot = await db.collection('userLoginRewards')
    .where('userEmail', '==', email)
    .get();

  if (!snapshot.empty) {
    const docRef = snapshot.docs[0].ref;
    let coins = snapshot.docs[0].data().coins || 0;

    if (rewardText.includes("Fayå¹£")) {
      // ä¾‹å¦‚ã€Œ100 Fayå¹£ã€
      let num = parseInt(rewardText.replace(/[^0-9]/g, "")) || 0;
      await docRef.update({ coins: coins + num });
    } else if (rewardText.includes("æ™®é€šå¯¶ç®±")) {
  const current = snapshot.docs[0].data().normalChests || 0;
  await docRef.update({ normalChests: current + 1 });
} else if (rewardText.includes("é«˜ç´šå¯¶ç®±")) {
  const current = snapshot.docs[0].data().chests || 0;
  await docRef.update({ chests: current + 1 });
}
else if (rewardText.includes("ç¨±è™Ÿ") || rewardText.includes("æ¡Œå¸ƒ")) {
  const userEmail = localStorage.getItem("userEmail");
  if (userEmail && userEmail !== "faywooooo@gmail.com") {
    sendRewardEmail(
      userEmail,
      rewardText,
      "template_7r9kdt9",   // âœ… æ”¹ç”¨å¯¶ç®±çš„æ¨¡æ¿
      "é€šè¡Œåˆ¸çå‹µ"
    );
  } else {
    console.warn("âŒ æ¸¬è©¦å¸³è™Ÿè¢«æ’é™¤ï¼Œæœªå¯„é€ Email");
  }
}


  }

  // æ¨™è¨˜ç‚ºå·²é ˜å–
  claimed[key] = true;
  await db.collection("battlePass").doc(email).set({ claimed: claimed }, { merge: true });

  alert("ğŸ æˆåŠŸé ˜å–ï¼š" + rewardText);
  loadCSVRewards();
  
}

  
async function changeProgress(delta) {
    const targetEmail = document.getElementById("targetEmail").value.trim();
    if (!targetEmail) return;
  
    const doc = await db.collection("battlePass").doc(targetEmail).get();
    let currentProgress = (doc.exists ? (doc.data().progress || 0) : 0);
  
    // âœ… å¾ç›®å‰éšç´šåŠ æ¸›
    let newProgress = currentProgress + delta;
  
    if (newProgress < 0) newProgress = 0;
    if (newProgress > totalProgress) newProgress = totalProgress;
  
    console.log("[changeProgress] ç›®å‰ =", currentProgress, "â†’ æ–°é€²åº¦ =", newProgress);
  
    await db.collection("battlePass").doc(targetEmail).set({
      progress: newProgress
    }, { merge: true });
  }
  
  
    async function resetProgress() {
      const targetEmail = document.getElementById("targetEmail").value.trim();
      if (!targetEmail) return;
      console.log("[resetProgress] é‡ç½®", targetEmail);
      await db.collection("battlePass").doc(targetEmail).set({ progress: 0, claimed: {} }, { merge: true });
      alert("å·²é‡ç½®ï¼");
    }
  
    function loadUser(targetEmail) {
      db.collection("battlePass").doc(targetEmail).onSnapshot(doc => {
        console.log("[loadUser]", doc.data());
        document.getElementById("userData").innerText = doc.exists ? JSON.stringify(doc.data(), null, 2) : "æŸ¥ç„¡è³‡æ–™";
        if (doc.exists) document.getElementById("targetPremium").checked = doc.data().premium || false;
      });
    }
    function openMusicPanel() {
  buildMusicTable();
  document.getElementById('musicPanel').style.display = 'block';
}

function buildMusicTable() {
    const tbody = document.getElementById("musicTable");
    tbody.innerHTML = "";
  
    if (!userPremium) {
      tbody.innerHTML = `<tr><td colspan="3">âŒ éœ€è¦è³¼è²·é«˜ç´šé€šè¡Œè­‰æ‰èƒ½è§£é–éŸ³æ¨‚</td></tr>`;
      return;
    }
  
    // å®˜æ–¹éŸ³æ¨‚ï¼šå¿…é ˆ premium + ç­‰ç´šå·²é”æˆ + å·²é ˜å–
    Object.entries(officialMusic).forEach(([lv, url]) => {
      const key = `${lv}_premium`; // premium çå‹µçš„ key
      if (progress >= lv && claimed[key]) {
        tbody.innerHTML += `
          <tr>
            <td>å®˜æ–¹éŸ³æ¨‚ Lv.${lv}</td>
            <td>å®˜æ–¹</td>
            <td><input type="radio" name="musicSelect" value="${url}"></td>
          </tr>`;
      }
    });
  
    // è‡ªè¨‚éŸ³æ¨‚ï¼šåŒæ¨£ premium + ç­‰ç´šå·²é”æˆ + å·²é ˜å–
    customMusicLevels.forEach(lv => {
      const key = `${lv}_premium`;
      if (progress >= lv && claimed[key]) {
        tbody.innerHTML += `
          <tr>
            <td>è‡ªè¨‚èƒŒæ™¯éŸ³æ¨‚ Lv.${lv}</td>
            <td>è‡ªè¨‚</td>
            <td><input type="radio" name="musicSelect" value="custom_${lv}"></td>
          </tr>`;
      }
    });
  
    if (!tbody.innerHTML) {
      tbody.innerHTML = `<tr><td colspan="3">ğŸ”’ å°šæœªè§£é–ä»»ä½•éŸ³æ¨‚</td></tr>`;
    }
  }
  

    const officialMusic = {
  3: "/music/BS_Subway_Surfer.mp3",
  13: "/music/Nothing Beats a Jet2holiday Sale Family TV advert.mp3",
  23: "/music/Rick Astley - Never Gonna Give You Up (Official Video) (4K Remaster).mp3",
  33: "/music/ğ™‰ğ˜¼ğ™†ğ˜¼ğ™ˆğ˜¼ & ğ™ˆğ˜¾ ğ™‡ğ™”ğ˜¾4ğ™‰ - ğ™ğ˜¼ğ™…ğ˜¼ğ˜¿ğ˜¼ (ğ™ğ™‡ğ™ğ™ğ˜¼ ğ™ğ™‡ğ™Šğ™’ğ™€ğ˜¿ + ğ™ğ™€ğ™‘ğ™€ğ™ğ˜½).mp3",
  43: "/music/CANTO DE LUNA ULTRA SLOWED.mp3",
  53: "/music/Montagem Bandido Slowed.mp3",
  63: "/music/W&W - OIIA OIIA (Spinning Cat).mp3",
  73: "/music/song8.mp3",
  83: "/music/song9.mp3",
  93: "/music/song10.mp3"
};
function saveMusic() {
  const choice = document.querySelector("input[name='musicSelect']:checked");
  if (!choice) return alert("è«‹å…ˆé¸æ“‡ä¸€é¦–éŸ³æ¨‚");
  const url = choice.value;

  // æ’­æ”¾éŸ³æ¨‚
  const player = document.getElementById("bgMusic");
  if (url.startsWith("custom_")) {
    // è‡ªè¨‚éŸ³æ¨‚å¯è®“ç©å®¶è¼¸å…¥ç¶²å€æˆ–ä¸Šå‚³
    alert("é€™è£¡å¯ä»¥åšè‡ªè¨‚éŸ³æ¨‚ä¸Šå‚³/è¼¸å…¥ç¶²å€çš„åŠŸèƒ½");
  } else {
    player.src = url;
    player.play();
  }

  document.getElementById("musicPanel").style.display = "none";
}

    // åˆå§‹åŒ–
    listenUser();
    listenBalance();
    if (email === "faywooooo@gmail.com") {
      document.getElementById("adminPanel").style.display = "block";
      document.getElementById("targetEmail").value = email;
      loadUser(email);
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    emailjs.init("Rna6NHThG_VW9eyRE"); // âš ï¸ æ›æˆä½ çš„ Public Key
  
    function sendRewardEmail(userEmail, rewardName, templateId, source) {
      const templateParams = {
        user: userEmail || "æœªçŸ¥ç©å®¶",
        reward: rewardName,
        time: new Date().toLocaleString(),
        source: source || "é€šè¡Œåˆ¸" // é¡å¤–åƒæ•¸æ–¹ä¾¿è¾¨è­˜
      };
  
      emailjs.send("service_g83kh8j", templateId, templateParams)
        .then(res => console.log("âœ… Email ç™¼é€æˆåŠŸ:", res))
        .catch(err => console.error("âŒ Email ç™¼é€å¤±æ•—:", err));
    }
    // ğŸ”’ é™åˆ¶éç®¡ç†å“¡ç”¨æˆ¶æ“ä½œ
(function() {
  const userEmail = (localStorage.getItem("userEmail") || "").toLowerCase();
  if (userEmail !== "faywooooo@gmail.com") {

    // ç¦æ­¢å³éµ
    document.addEventListener("contextmenu", e => e.preventDefault());

    // ç¦æ­¢ F12ã€Ctrl+Uã€Ctrl+S
    document.addEventListener("keydown", e => {
      // F12
      if (e.key === "F12") {
        e.preventDefault();
        e.stopPropagation();
      }
      // Ctrl + U / S
      if (e.ctrlKey && (e.key.toLowerCase() === "u" || e.key.toLowerCase() === "s")) {
        e.preventDefault();
        e.stopPropagation();
      }
    }, true);
  }
})();

  </script>
  
</body>
</html>
